<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>在 Flutter 中使用 NestedScrollView 與 CustomScrollView - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="最近在修改 app 的個人頁，遇到的需求：

Tab bar 切出圓角
Tab bar 可以滑動，滑到 app bar 的時候固定住

用文字說不太清楚，下面直接看圖：

頁面的 components 有：

App bar
個人資訊區
Tab bar
Tab view

Tab view 裡是可滾動的內容, 這裡放了兩種類型：grid 與 list。
當用戶向上滑動時，app bar 固定不動，tab bar 往上滑動到 tab bar 時固定不動，下方 tab view 保持可滑動。如下圖：
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="在 Flutter 中使用 NestedScrollView 與 CustomScrollView" />
<meta property="og:description" content="最近在修改 app 的個人頁，遇到的需求：

Tab bar 切出圓角
Tab bar 可以滑動，滑到 app bar 的時候固定住

用文字說不太清楚，下面直接看圖：

頁面的 components 有：

App bar
個人資訊區
Tab bar
Tab view

Tab view 裡是可滾動的內容, 這裡放了兩種類型：grid 與 list。
當用戶向上滑動時，app bar 固定不動，tab bar 往上滑動到 tab bar 時固定不動，下方 tab view 保持可滑動。如下圖：
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/using-nestedscrollview-in-flutter/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-01T19:30:23+08:00" />
<meta property="article:modified_time" content="2022-07-01T19:30:23+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="在 Flutter 中使用 NestedScrollView 與 CustomScrollView"/>
<meta name="twitter:description" content="最近在修改 app 的個人頁，遇到的需求：

Tab bar 切出圓角
Tab bar 可以滑動，滑到 app bar 的時候固定住

用文字說不太清楚，下面直接看圖：

頁面的 components 有：

App bar
個人資訊區
Tab bar
Tab view

Tab view 裡是可滾動的內容, 這裡放了兩種類型：grid 與 list。
當用戶向上滑動時，app bar 固定不動，tab bar 往上滑動到 tab bar 時固定不動，下方 tab view 保持可滑動。如下圖：
"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">在 Flutter 中使用 NestedScrollView 與 CustomScrollView</h1>
			<div class="meta">Posted on Jul 1, 2022</div>
		</div>
		

		<section class="body">
			<p>最近在修改 app 的個人頁，遇到的需求：</p>
<ol>
<li>Tab bar 切出圓角</li>
<li>Tab bar 可以滑動，滑到 app bar 的時候固定住</li>
</ol>
<p>用文字說不太清楚，下面直接看圖：</p>
<p><img src="https://i.imgur.com/CxZ6jxL.png" alt="Imgur"></p>
<p>頁面的 components 有：</p>
<ul>
<li>App bar</li>
<li>個人資訊區</li>
<li>Tab bar</li>
<li>Tab view</li>
</ul>
<p>Tab view 裡是可滾動的內容, 這裡放了兩種類型：grid 與 list。
當用戶向上滑動時，app bar 固定不動，tab bar 往上滑動到 tab bar 時固定不動，下方 tab view 保持可滑動。如下圖：</p>
<p><img src="https://i.imgur.com/o63DCh9.png" alt="Imgur"></p>
<p>放上我的 demo project 以供參考: <a href="https://github.com/maple52046/demo20220701">demo20220701</a>。</p>
<h1 id="app-bar-與個人資訊區">App bar 與個人資訊區</h1>
<p>一般在網上看到的範例都是用 <a href="https://api.flutter.dev/flutter/material/SliverAppBar-class.html">SliverAppBar</a>，設定 <code>pinned</code> 為 <code>true</code>，然後將個人資訊區放到 <code>flexibleSpace</code>。</p>
<p>但是實作的過程中發現，這個方法非常的不好用。原因在於 <code>flexibleSpace</code> 還需要搭配設定 <code>expandedHeight</code> 去指定高度。而我的個人資訊中包含了非固定長度的自介，因此就需要提前計算自介區的高度然後調整 <code>expandedHeight</code>。</p>
<p>為了省麻煩，我決定將自介包裝成 sliver 放到 appbar 底下。</p>
<blockquote>
<p>謎之音: 如果 <code>flexibleSpace</code> 只放頭像跟統計，那為何不乾脆放棄 <code>flexibleSpace</code>，全部都弄成 sliver，這樣連 <code>expandedHeight</code> 都可以省略了？</p>
</blockquote>
<p>既然 app bar 與 tab bar 之間有 widgets，那麼 tab bar 就不能放到 app bar 的 <code>bottom</code>，它必須也是獨立的 sliver。</p>
<blockquote>
<p>謎之音：既然 app bar 需要一直固定在上方，那現在還有需要使用 SliverAppBar 嗎？</p>
</blockquote>
<h1 id="sliver-tab-bar">Sliver Tab bar</h1>
<p>Flutter 的 <a href="https://api.flutter.dev/flutter/material/TabBar-class.html">TabBar</a> 並不是一個 sliver widget，再加上我需要讓 tab bar 在滑動的過程中可以固定到上方，因此就需要搭配使用 <code>SliverPersistentHeader</code>。</p>
<p><code>SliverPersistentHeader</code> 需要帶入 <code>SliverPersistentHeaderDelegate</code> 類型的 <code>delegate</code>。這裡我參考網路上的範例，做了一份自己的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SliverTabBarDelegate</span> <span style="color:#66d9ef">extends</span> SliverPersistentHeaderDelegate {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> Color backgroundColor;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> TabBar tabBar;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> Radius topRadius;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> SliverTabBarDelegate({
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.tabBar,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.backgroundColor,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.topRadius,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">double</span> <span style="color:#66d9ef">get</span> minExtent <span style="color:#f92672">=&gt;</span> tabBar.preferredSize.height;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">double</span> <span style="color:#66d9ef">get</span> maxExtent <span style="color:#f92672">=&gt;</span> tabBar.preferredSize.height;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Widget build(context, shrinkOffset, overlapsContent) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Container(
</span></span><span style="display:flex;"><span>      decoration: BoxDecoration(
</span></span><span style="display:flex;"><span>        borderRadius: BorderRadius.only(
</span></span><span style="display:flex;"><span>          topLeft: topRadius,
</span></span><span style="display:flex;"><span>          topRight: topRadius,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        color: backgroundColor,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>      child: tabBar,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> shouldRebuild(SliverTabBarDelegate oldDelegate) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> tabBar <span style="color:#f92672">!=</span> oldDelegate.tabBar;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>在參數中直接帶入 <code>TabBar</code> widget，然後高度就直接從 widget 中抓就可以了。</li>
<li>業務需求需要切 tab bar 的圓角，因此參數額外加上 radius，然後在 <code>build</code> 中設定 border radius。</li>
<li>另外帶入 tab bar 本身的底色，以便於區分 scaffold 後面的背景色。</li>
</ul>
<p>有了 delegate 之後，就可以把 tab bar 製作成 sliver widget：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span>SliverPersistentHeader(
</span></span><span style="display:flex;"><span>  delegate: SliverTabBarDelegate(
</span></span><span style="display:flex;"><span>    tabBar: TabBar(controller: _tabController, tabs: _tabs),
</span></span><span style="display:flex;"><span>    topRadius: _topRadius,
</span></span><span style="display:flex;"><span>    backgroundColor: Colors.white,
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>  pinned: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><h1 id="customscrollview">CustomScrollView</h1>
<p>看一下目前為止的架構：</p>
<p><img src="https://i.imgur.com/nv3RxRf.png" alt="Imgur"></p>
<p>AppBar 是不是 sliver 已經無所謂了，個人還是喜歡原本的方式，因此不採用 SliverAppBar；Tab view 是不是 sliver 則視實作的方式決定。Profile 與 tab bar 則確定是 sliver widgets。</p>
<p>這種場景一般會直接用 <a href="https://api.flutter.dev/flutter/widgets/CustomScrollView-class.html">CustomScrollView</a> 建構頁面。例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span>SafeArea(
</span></span><span style="display:flex;"><span>  bottom: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>  child: DefaultTabController(
</span></span><span style="display:flex;"><span>    initialIndex: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    length: _tabs.length,
</span></span><span style="display:flex;"><span>    child: CustomScrollView(
</span></span><span style="display:flex;"><span>      slivers: [
</span></span><span style="display:flex;"><span>        SliverToBoxAdapter(
</span></span><span style="display:flex;"><span>          child: Profile(bio: bio, socialStatisticData: statistic),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> SliverPersistentHeader(
</span></span><span style="display:flex;"><span>          delegate: SliverTabBarDelegate(
</span></span><span style="display:flex;"><span>            tabBar: TabBar(tabs: _tabs),
</span></span><span style="display:flex;"><span>            topRadius: _topRadius,
</span></span><span style="display:flex;"><span>            backgroundColor: Colors.white,
</span></span><span style="display:flex;"><span>          ),
</span></span><span style="display:flex;"><span>          pinned: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> SliverFillRemaining(
</span></span><span style="display:flex;"><span>          child: ColoredBox(
</span></span><span style="display:flex;"><span>            color: Color.fromRGBO(<span style="color:#ae81ff">234</span>, <span style="color:#ae81ff">236</span>, <span style="color:#ae81ff">238</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>            child: TabBarView(
</span></span><span style="display:flex;"><span>              children: [
</span></span><span style="display:flex;"><span>                ContentGrid(
</span></span><span style="display:flex;"><span>                  itemCount: <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>                  itemColor: Color.fromRGBO(<span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">183</span>, <span style="color:#ae81ff">177</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>                ContentList(
</span></span><span style="display:flex;"><span>                  itemCount: <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>                  itemColor: Color.fromRGBO(<span style="color:#ae81ff">169</span>, <span style="color:#ae81ff">223</span>, <span style="color:#ae81ff">191</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                )
</span></span><span style="display:flex;"><span>              ],
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>          ),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  ),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>但是這樣做會產生兩個問題：</p>
<ol>
<li>Scrolling 被切成了兩部份: profile + tab bar、<code>TabBarView</code>。<code>TabBarView</code> 中的 grid 與 list 上下滑動不會一起帶動 tab bar，這樣使用起來體驗很奇怪；但是如果在 grid/list 裡指定 <code>physics: NeverScrollableScrollPhysics()</code> 則會造成列表無法捲動到底部。</li>
<li>當 grid/list 往上滑時，本應該隱藏在 tab bar 後的內容，會出現在 tab bar 的圓角旁邊，這樣視覺上就很差：</li>
</ol>
<p><img src="https://i.imgur.com/pn0QAKU.jpg" alt="Imgur"></p>
<h1 id="nestedscrollview--valuelistener">NestedScrollView + ValueListener</h1>
<p>上面第一個問題很好解決，就是採用 <code>NestedScrollView</code>，將 profile 與 tab bar 放到 <code>headerSliverBuilder</code>；<code>TabBarView</code> 直接放在 <code>body</code> 中，不需要包裝成 sliver。同時，任何 <code>physics</code> 都不需要調整。</p>
<p>但是第二個問題呢？ 我本來想到的解決方案是：當 grid/list 內容捲到 tab bar 後面時，就同時一起切圓角：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;models/statistics.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/lists.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/grids.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/profiles.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/utils/scaffolds.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/utils/tabbars.dart&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> _tabs <span style="color:#f92672">=</span> [Tab(text: <span style="color:#e6db74">&#39;Grid&#39;</span>), Tab(text: <span style="color:#e6db74">&#39;List&#39;</span>)];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> _topRadius <span style="color:#f92672">=</span> Radius.circular(<span style="color:#ae81ff">40</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHomePage</span> <span style="color:#66d9ef">extends</span> StatefulWidget {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">String</span> bio;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">String</span> name;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> SocialStatisticData statistic;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> MyHomePage({
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.name,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.bio,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.statistic,
</span></span><span style="display:flex;"><span>    Key<span style="color:#f92672">?</span> key,
</span></span><span style="display:flex;"><span>  }) <span style="color:#f92672">:</span> <span style="color:#66d9ef">super</span>(key: key);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  State<span style="color:#f92672">&lt;</span>MyHomePage<span style="color:#f92672">&gt;</span> createState() <span style="color:#f92672">=&gt;</span> _MyHomePageState();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_MyHomePageState</span> <span style="color:#66d9ef">extends</span> State<span style="color:#f92672">&lt;</span>MyHomePage<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> ValueNotifier<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span><span style="color:#f92672">&gt;</span> _innerTabScrolled <span style="color:#f92672">=</span> ValueNotifier(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Widget build(BuildContext context) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ColorfulScaffold(
</span></span><span style="display:flex;"><span>      backgroundColor: <span style="color:#66d9ef">const</span> Color.fromRGBO(<span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">0.3</span>),
</span></span><span style="display:flex;"><span>      gradient: <span style="color:#66d9ef">const</span> LinearGradient(colors: [
</span></span><span style="display:flex;"><span>        Color.fromRGBO(<span style="color:#ae81ff">247</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        Color.fromRGBO(<span style="color:#ae81ff">243</span>, <span style="color:#ae81ff">156</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>      ]),
</span></span><span style="display:flex;"><span>      appBar: AppBar(
</span></span><span style="display:flex;"><span>        title: Text(widget.name),
</span></span><span style="display:flex;"><span>        backgroundColor: Colors.transparent,
</span></span><span style="display:flex;"><span>        elevation: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>      body: SafeArea(
</span></span><span style="display:flex;"><span>        bottom: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        child: DefaultTabController(
</span></span><span style="display:flex;"><span>          length: _tabs.length,
</span></span><span style="display:flex;"><span>          child: NestedScrollView(
</span></span><span style="display:flex;"><span>            headerSliverBuilder: (context, innerBoxScrolled) {
</span></span><span style="display:flex;"><span>              _innerTabScrolled.value <span style="color:#f92672">=</span> innerBoxScrolled;
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">return</span> [
</span></span><span style="display:flex;"><span>                SliverToBoxAdapter(
</span></span><span style="display:flex;"><span>                  child: Profile(
</span></span><span style="display:flex;"><span>                    bio: widget.bio,
</span></span><span style="display:flex;"><span>                    socialStatisticData: widget.statistic,
</span></span><span style="display:flex;"><span>                  ),
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">const</span> SliverPersistentHeader(
</span></span><span style="display:flex;"><span>                  delegate: SliverTabBarDelegate(
</span></span><span style="display:flex;"><span>                    tabBar: TabBar(tabs: _tabs),
</span></span><span style="display:flex;"><span>                    topRadius: _topRadius,
</span></span><span style="display:flex;"><span>                    backgroundColor: Colors.white,
</span></span><span style="display:flex;"><span>                  ),
</span></span><span style="display:flex;"><span>                  pinned: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>              ];
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            body: ValueListenableBuilder<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span><span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>              valueListenable: _innerTabScrolled,
</span></span><span style="display:flex;"><span>              builder: (_, value, child) <span style="color:#f92672">=&gt;</span> ClipRRect(
</span></span><span style="display:flex;"><span>                borderRadius: value
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">?</span> <span style="color:#66d9ef">const</span> BorderRadius.only(
</span></span><span style="display:flex;"><span>                        topLeft: _topRadius,
</span></span><span style="display:flex;"><span>                        topRight: _topRadius,
</span></span><span style="display:flex;"><span>                      )
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">:</span> BorderRadius.zero,
</span></span><span style="display:flex;"><span>                child: child,
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>              child: <span style="color:#66d9ef">const</span> ColoredBox(
</span></span><span style="display:flex;"><span>                color: Color.fromRGBO(<span style="color:#ae81ff">234</span>, <span style="color:#ae81ff">236</span>, <span style="color:#ae81ff">238</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                child: TabBarView(
</span></span><span style="display:flex;"><span>                  children: [
</span></span><span style="display:flex;"><span>                    ContentGrid(
</span></span><span style="display:flex;"><span>                      itemCount: <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>                      itemColor: Color.fromRGBO(<span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">183</span>, <span style="color:#ae81ff">177</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                    ),
</span></span><span style="display:flex;"><span>                    ContentList(
</span></span><span style="display:flex;"><span>                      itemCount: <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>                      itemColor: Color.fromRGBO(<span style="color:#ae81ff">169</span>, <span style="color:#ae81ff">223</span>, <span style="color:#ae81ff">191</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                    )
</span></span><span style="display:flex;"><span>                  ],
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>          ),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>當 <code>innerBoxScrolled</code> 為 <code>true</code> 時，就是 body 上滑到 <code>headerSliverBuilder</code> 的 slivers 裡了。這時候就裁切 <code>TabBarView</code>。</p>
<p>理論上應該可以完美解決我的需求。但是，夢想很美好，現實很殘酷，跑出來的結果變成：</p>
<p><img src="https://i.imgur.com/uKzlCwN.gif" alt="Imgur"></p>
<p>實際上是 body 觸及頂部的時候，<code>innerBoxScrolled</code> 才變更為 <code>true</code>。於是就變成這樣瞬間切圓角的搞笑畫面。</p>
<blockquote>
<p>這個是慢動作，滑快一點的話就看不出來了?! XD</p>
</blockquote>
<h1 id="nestedscrollview--customscrollview">NestedScrollView + CustomScrollView</h1>
<p>在經過一番思考與嘗試之後，我將架構調整如下：</p>
<p><img src="https://i.imgur.com/HU3Au11.png" alt="Imgur"></p>
<ul>
<li>外層依然使用 <code>NestedScrollView</code>，因為我們需要它來協調整體的 scrolling。</li>
<li><code>headerSliverBuilder</code> 只放 profile</li>
<li><code>TabBar</code> 與 <code>TabBarView</code> 同時放到 <code>NestedScrollView</code> 的 body 中。但是為了讓 <code>TabBar</code> 保留 pinned 到頂層的功能，因此這裡還是得要包裝成 sliver widget，然後連同 <code>TabBarView</code> (sliver) 一起放到 <code>CustomScrollView</code> 裡。</li>
<li>直接剪裁 <code>CustomScrollView</code> 圓角即可，grid/list 都是 child，因此不會跑出去。</li>
</ul>
<p>這個方式有兩個重點：</p>
<ul>
<li><strong><code>NestedScrollView</code> 與 <code>CustomScrollView</code> 的 scroll controller 必須要設為同一個</strong></li>
<li><strong><code>CustomScrollView</code> 的 <code>physics</code> 必須設為 <code>NeverScrollableScrollPhysics</code></strong></li>
</ul>
<p>兩者缺一不可，否則依然還是會有上下 scrolling 不同步的問題。</p>
<p>最終的程式碼：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:flutter/material.dart&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;models/statistics.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/lists.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/grids.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/profiles.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/utils/scaffolds.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;widgets/utils/tabbars.dart&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> _tabs <span style="color:#f92672">=</span> [Tab(text: <span style="color:#e6db74">&#39;Grid&#39;</span>), Tab(text: <span style="color:#e6db74">&#39;List&#39;</span>)];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> _topRadius <span style="color:#f92672">=</span> Radius.circular(<span style="color:#ae81ff">20</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyHomePage</span> <span style="color:#66d9ef">extends</span> StatefulWidget {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">String</span> bio;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">String</span> name;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> SocialStatisticData statistic;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> MyHomePage({
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.name,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.bio,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.statistic,
</span></span><span style="display:flex;"><span>    Key<span style="color:#f92672">?</span> key,
</span></span><span style="display:flex;"><span>  }) <span style="color:#f92672">:</span> <span style="color:#66d9ef">super</span>(key: key);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  State<span style="color:#f92672">&lt;</span>MyHomePage<span style="color:#f92672">&gt;</span> createState() <span style="color:#f92672">=&gt;</span> _MyHomePageState();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">_MyHomePageState</span> <span style="color:#66d9ef">extends</span> State<span style="color:#f92672">&lt;</span>MyHomePage<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> _scrollController <span style="color:#f92672">=</span> ScrollController();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> dispose() {
</span></span><span style="display:flex;"><span>    _scrollController.dispose();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">super</span>.dispose();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Widget build(BuildContext context) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> ColorfulScaffold(
</span></span><span style="display:flex;"><span>      backgroundColor: <span style="color:#66d9ef">const</span> Color.fromRGBO(<span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">250</span>, <span style="color:#ae81ff">0.3</span>),
</span></span><span style="display:flex;"><span>      gradient: <span style="color:#66d9ef">const</span> LinearGradient(colors: [
</span></span><span style="display:flex;"><span>        Color.fromRGBO(<span style="color:#ae81ff">247</span>, <span style="color:#ae81ff">220</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>        Color.fromRGBO(<span style="color:#ae81ff">243</span>, <span style="color:#ae81ff">156</span>, <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>      ]),
</span></span><span style="display:flex;"><span>      appBar: AppBar(
</span></span><span style="display:flex;"><span>        title: Text(widget.name),
</span></span><span style="display:flex;"><span>        backgroundColor: Colors.transparent,
</span></span><span style="display:flex;"><span>        elevation: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>      body: SafeArea(
</span></span><span style="display:flex;"><span>        bottom: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        child: NestedScrollView(
</span></span><span style="display:flex;"><span>          controller: _scrollController,
</span></span><span style="display:flex;"><span>          headerSliverBuilder: (context, _) <span style="color:#f92672">=&gt;</span> [
</span></span><span style="display:flex;"><span>            SliverToBoxAdapter(
</span></span><span style="display:flex;"><span>              child: Profile(
</span></span><span style="display:flex;"><span>                bio: widget.bio,
</span></span><span style="display:flex;"><span>                socialStatisticData: widget.statistic,
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>          ],
</span></span><span style="display:flex;"><span>          body: ClipRRect(
</span></span><span style="display:flex;"><span>            borderRadius: <span style="color:#66d9ef">const</span> BorderRadius.only(
</span></span><span style="display:flex;"><span>              topLeft: _topRadius,
</span></span><span style="display:flex;"><span>              topRight: _topRadius,
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>            child: ColoredBox(
</span></span><span style="display:flex;"><span>              color: Colors.white,
</span></span><span style="display:flex;"><span>              child: DefaultTabController(
</span></span><span style="display:flex;"><span>                length: _tabs.length,
</span></span><span style="display:flex;"><span>                child: CustomScrollView(
</span></span><span style="display:flex;"><span>                  physics: <span style="color:#66d9ef">const</span> NeverScrollableScrollPhysics(),
</span></span><span style="display:flex;"><span>                  controller: _scrollController,
</span></span><span style="display:flex;"><span>                  slivers: <span style="color:#66d9ef">const</span> [
</span></span><span style="display:flex;"><span>                    SliverPersistentHeader(
</span></span><span style="display:flex;"><span>                      delegate: SliverTabBarDelegate(
</span></span><span style="display:flex;"><span>                        tabBar: TabBar(tabs: _tabs),
</span></span><span style="display:flex;"><span>                        topRadius: Radius.zero,
</span></span><span style="display:flex;"><span>                        backgroundColor: Colors.white,
</span></span><span style="display:flex;"><span>                      ),
</span></span><span style="display:flex;"><span>                      pinned: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>                    ),
</span></span><span style="display:flex;"><span>                    SliverTabBarView(
</span></span><span style="display:flex;"><span>                      color: Color.fromRGBO(<span style="color:#ae81ff">234</span>, <span style="color:#ae81ff">236</span>, <span style="color:#ae81ff">238</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                      children: [
</span></span><span style="display:flex;"><span>                        ContentGrid(
</span></span><span style="display:flex;"><span>                          itemCount: <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>                          itemColor: Color.fromRGBO(<span style="color:#ae81ff">245</span>, <span style="color:#ae81ff">183</span>, <span style="color:#ae81ff">177</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                        ),
</span></span><span style="display:flex;"><span>                        ContentList(
</span></span><span style="display:flex;"><span>                          itemCount: <span style="color:#ae81ff">50</span>,
</span></span><span style="display:flex;"><span>                          itemColor: Color.fromRGBO(<span style="color:#ae81ff">169</span>, <span style="color:#ae81ff">223</span>, <span style="color:#ae81ff">191</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>                        )
</span></span><span style="display:flex;"><span>                      ],
</span></span><span style="display:flex;"><span>                    ),
</span></span><span style="display:flex;"><span>                  ],
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>            ),
</span></span><span style="display:flex;"><span>          ),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最終的成果：</p>
<p><img src="https://i.imgur.com/m50Xqsz.gif" alt="Imgur"></p>
<h1 id="參考資料">參考資料</h1>
<ul>
<li><a href="https://book.flutterchina.club/chapter6/nestedscrollview.html#_6-12-1-nestedscrollview">嵌套可滚动组件 NestedScrollView</a></li>
<li><a href="https://abhishekdoshi26.medium.com/rebuild-your-widget-without-setstate-valuenotifier-bd7c1bf7a96b">Rebuild your widget without setState — ValueNotifier!</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1516957">神奇的ScrollPhysics与Simulation</a></li>
<li><a href="https://www.jianshu.com/p/1904a1657522">flutter SliverAppBar + Tabbar + TabView使用</a></li>
<li><a href="https://stackoverflow.com/questions/68640078/tabbarview-inside-sliver-with-stickyheader">TabBarView inside Sliver with StickyHeader</a></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/flutter">flutter</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
