<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>OpenStack Heat 使用筆記 - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Heat 是 OpenStack 中，負責提供 Orchestration 服務的 component。
Heat 用 resource 來描述 OpenStack 的狀態。例如你設定一個 network resource，在這個 resource 中，設定名稱為 default。接下來 Heat 將會在你的 project 中，檢查是否有一個名稱為 default 的 network；如果沒有，則 Heat 將會在 project 建立 network。除了 network 之外，image、volume、port、instance 等都可以是 Heat 的 resource。
Resource 之間可以建立關連性，例如你可以先建立一個 volume resource。接下來再設定一個 instance resource ，並且在 instance resource 的 block_device_mapping 的屬性中，設定與 volume resource 建立關連性。這樣 Heat 就會先檢查 volume 是否存在，然後檢查 instance 是否存在並且 volume 是否已掛載到 instance 中。
這個想法與許多 deployment 軟體相同，例如 Puppet 是讓使用者設定 resource，然後 Puppet 根據 resource 的描述去配置 Linux；而 Saltstack 則是根據 user 設定的 state 來配置 Linux。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="OpenStack Heat 使用筆記" />
<meta property="og:description" content="Heat 是 OpenStack 中，負責提供 Orchestration 服務的 component。
Heat 用 resource 來描述 OpenStack 的狀態。例如你設定一個 network resource，在這個 resource 中，設定名稱為 default。接下來 Heat 將會在你的 project 中，檢查是否有一個名稱為 default 的 network；如果沒有，則 Heat 將會在 project 建立 network。除了 network 之外，image、volume、port、instance 等都可以是 Heat 的 resource。
Resource 之間可以建立關連性，例如你可以先建立一個 volume resource。接下來再設定一個 instance resource ，並且在 instance resource 的 block_device_mapping 的屬性中，設定與 volume resource 建立關連性。這樣 Heat 就會先檢查 volume 是否存在，然後檢查 instance 是否存在並且 volume 是否已掛載到 instance 中。
這個想法與許多 deployment 軟體相同，例如 Puppet 是讓使用者設定 resource，然後 Puppet 根據 resource 的描述去配置 Linux；而 Saltstack 則是根據 user 設定的 state 來配置 Linux。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/notes-openstack-heat-usage/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-06-30T15:48:16+00:00" />
<meta property="article:modified_time" content="2016-06-30T15:48:16+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="OpenStack Heat 使用筆記"/>
<meta name="twitter:description" content="Heat 是 OpenStack 中，負責提供 Orchestration 服務的 component。
Heat 用 resource 來描述 OpenStack 的狀態。例如你設定一個 network resource，在這個 resource 中，設定名稱為 default。接下來 Heat 將會在你的 project 中，檢查是否有一個名稱為 default 的 network；如果沒有，則 Heat 將會在 project 建立 network。除了 network 之外，image、volume、port、instance 等都可以是 Heat 的 resource。
Resource 之間可以建立關連性，例如你可以先建立一個 volume resource。接下來再設定一個 instance resource ，並且在 instance resource 的 block_device_mapping 的屬性中，設定與 volume resource 建立關連性。這樣 Heat 就會先檢查 volume 是否存在，然後檢查 instance 是否存在並且 volume 是否已掛載到 instance 中。
這個想法與許多 deployment 軟體相同，例如 Puppet 是讓使用者設定 resource，然後 Puppet 根據 resource 的描述去配置 Linux；而 Saltstack 則是根據 user 設定的 state 來配置 Linux。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">OpenStack Heat 使用筆記</h1>
			<div class="meta">Posted on Jun 30, 2016</div>
		</div>
		

		<section class="body">
			<p>Heat 是 OpenStack 中，負責提供 Orchestration 服務的 component。</p>
<p>Heat 用 <strong>resource</strong> 來描述 OpenStack 的狀態。例如你設定一個 network resource，在這個 resource 中，設定名稱為 <code>default</code>。接下來 Heat 將會在你的 project 中，檢查是否有一個名稱為 <code>default</code> 的 network；如果沒有，則 Heat 將會在 project 建立 network。除了 network 之外，image、volume、port、instance 等都可以是 Heat 的 resource。</p>
<p>Resource 之間可以建立關連性，例如你可以先建立一個 volume resource。接下來再設定一個 instance resource ，並且在 instance resource 的 <code>block_device_mapping</code> 的屬性中，設定與 volume resource 建立關連性。這樣 Heat 就會先檢查 volume 是否存在，然後檢查 instance 是否存在並且 volume 是否已掛載到 instance 中。</p>
<p>這個想法與許多 deployment 軟體相同，例如 Puppet 是讓使用者設定 <strong>resource</strong>，然後 Puppet 根據 resource 的描述去配置 Linux；而 Saltstack 則是根據 user 設定的 <strong>state</strong> 來配置 Linux。</p>
<p>在開始之前，你必須要先準備：</p>
<ol>
<li>一個 OpenStack Account。同時你必須要確定該 platform 有安裝 Heat 服務。本文是使用 <a href="https://www.unicloud.org.tw/services/sscloud">SSCloud</a> 做 demo。</li>
<li>熟悉 OpenStack 的基本操作：使用 OpenStack dashboard 或是使用 OpenStack command client。</li>
</ol>
<h1 id="template">Template</h1>
<p>先前已經提過 Heat Resource 。在 Heat 中，由眾多 resource 所組合而成的檔案/物件就是樣版(template)。
你可以使用 <code>heat</code> 指令來查詢你的 OpenStack platform 支援哪些 template。</p>
<p>執行 <code>heat template-version-list</code> 會得到：</p>
<p><img src="http://i.imgur.com/OM80xOF.png" alt="Imgur"></p>
<p>從上圖中可以看到 Template type 有兩種：</p>
<ol>
<li>cfn: 是 AWS CloudFormation 的縮寫。這套 template 支援 AWS 也支援 OpenStack Heat。CFN 是採用 Json 作為檔案格式。</li>
<li>hot: 是 Heat Orchestration Template 的縮寫。這套 template 只能使用於 OpenStack Heat，並不支援 AWS。一般來說，HOT 是採用 YAML 作為檔案格式。</li>
</ol>
<p>在撰寫你的 template 的時候，一開始就必須要先指定 template 的版本。
例如：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;AWSTemplateFormatVersion&#34;</span> : <span style="color:#e6db74">&#34;2010-09-09&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Description&#34;</span> : <span style="color:#e6db74">&#34;Sample Heat template that spins up multiple instances and a private network (JSON)&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Resources&#34;</span> : { }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這是一個 CFN 的 template，所以是以 Json 為檔案格式。一開始先定義這個 template 是採用哪個版本，這個設定可以從 <code>heat template-version-list</code> 中取得；而 <code>Description</code> 則是 user 可以增加的自訂描述。</p>
<p>最後 Resouces 則是一個 Json object，裡面則是由多個 resource 所組成。</p>
<h1 id="resource">Resource</h1>
<p>先前已經提過，resource 就是基本描述/操作 OpenStack(AWS) 的物件。與 template 一樣，我們可以透過 heat 的指令來取得所支援的 resource 列表。</p>
<p>你可以執行 <code>heat resource-type-list</code>，將會得到以下結果：</p>
<p><img src="http://i.imgur.com/xKObLA4.png" alt="List of Heat resource type"></p>
<p>或者是你也可以從 Horizon 上面看到 resource type list：</p>
<p><img src="http://i.imgur.com/4aEEzh8.png" alt="List of Heat resource type on Horizon"></p>
<p>得到 resource type list 後，接下來你需要取得 resource 的設定參數。
使用 <code>heat resource-type-template &quot;TemplateName&quot;</code> 以及 <code>heat resource-type-show &quot;TemplateName&quot;</code> 來取得 resource 的詳細內容。</p>
<p><img src="http://i.imgur.com/hlFCCT8.png" alt="Heat resource-type-template"></p>
<p><img src="http://i.imgur.com/dn8xbUR.png" alt="Heat resource-type-show"></p>
<p>在 Template 中，我們可以給 Resource 設定的選項，是該 Resource 的 properties 裡面包含的參數。
以下我們以 Network 為例：</p>
<p>首先，先看 <code>OS::Neutron::Net</code> 有什麼參數可以設定：</p>
<p><img src="http://i.imgur.com/xmUOcFJ.png" alt="The result of show Net resource"></p>
<p><code>dhcp_agent_ids</code>、<code>name</code>、<code>admin_state_up</code>、&hellip;等是 <code>OS::Neutron::Net</code> 這個 resource 可以設定的參數。而每個參數下面，會有這個參數的 type、description、default、required 等屬性。</p>
<p>接下來，我們建立一個 resource object:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#e6db74">&#34;heat_net1&#34;</span> <span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Type&#34;</span> : <span style="color:#e6db74">&#34;OS::Neutron::Net&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Properties&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;my_heat_net1&#34;</span>,
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>heat_net1</code> 是這個 resource object 的名稱，只會在這個 Template 中被使用。<code>my_heat_net1</code> 則是實際會在 OpenStack 中建立的網路名稱。</p>
<p>那如果接下來，我們要在這個 <code>my_heat_net1</code> 再建立一個 subnet，要怎麼做呢？</p>
<p>首先，先執行 <code>heat resource-type-show OS::Neutron::Subnet</code> 取得參數列表。接下來根據參數列表，建立 Subnet 的 resource object:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#e6db74">&#34;heat_subnet1&#34;</span> <span style="color:#960050;background-color:#1e0010">:</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Type&#34;</span> : <span style="color:#e6db74">&#34;OS::Neutron::Subnet&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Properties&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;my_heat_subnet1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cidr&#34;</span> : <span style="color:#e6db74">&#34;192.168.0.0/24&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;dns_nameservers&#34;</span> : [<span style="color:#e6db74">&#34;8.8.8.8&#34;</span>, <span style="color:#e6db74">&#34;8.8.8.4&#34;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;network_id&#34;</span> : { <span style="color:#f92672">&#34;Ref&#34;</span>: <span style="color:#e6db74">&#34;heat_net1&#34;</span> }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>cidr</code> 是 <code>OS::Neutron::Subnet</code> required 的參數，型態是 string，value 則是該 subnet 的 CIDR。</li>
<li><code>dns_nameservers</code> 雖然不是 required 參數，但是一般我們在建立 subnet 的時候，都還是需要設定這個參數，這樣 instance 取得 DHCP IP 之後，才能一併設定 DNS server。透過查詢得知，<code>dns_nameservers</code> 的 value 必須要是 list 型態。</li>
<li><code>network_id</code> 與 <code>dns_nameservers</code> 雷同，他也不是 required 參數。但是在 OpenStack Neutron 中，subnet 是必須要歸屬在某個 network 底下。先前我們已經建立了一個 net resource objetct，利用 <code>Ref</code> 我們可以將這兩個 resource 中建立關連性，讓 Heat 讀取到 <code>heat_subnet1</code> 這個 resource object 時，會自動將 <code>heat_net1</code> 裡面，network ID 帶入到 <code>network_id</code> 這個參數中。</li>
</ul>
<p>瞭解了 resource object 是如何設定之後，接下來我們將這些 resource 放到 template 中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;AWSTemplateFormatVersion&#34;</span> : <span style="color:#e6db74">&#34;2010-09-09&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Description&#34;</span> : <span style="color:#e6db74">&#34;Sample Heat template that spins up multiple instances and a private network (JSON)&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;Resources&#34;</span> : {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;heat_net1&#34;</span> : {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Type&#34;</span> : <span style="color:#e6db74">&#34;OS::Neutron::Net&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Properties&#34;</span> : {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;my_heat_net1&#34;</span>,
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;heat_subnet1&#34;</span> : {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Type&#34;</span> : <span style="color:#e6db74">&#34;OS::Neutron::Subnet&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;Properties&#34;</span> : {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;my_heat_subnet1&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;cidr&#34;</span> : <span style="color:#e6db74">&#34;192.168.0.0/24&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;dns_nameservers&#34;</span> : [<span style="color:#e6db74">&#34;8.8.8.8&#34;</span>, <span style="color:#e6db74">&#34;8.8.8.4&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;network_id&#34;</span> : { <span style="color:#f92672">&#34;Ref&#34;</span>: <span style="color:#e6db74">&#34;heat_net1&#34;</span> }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>以上就是一個完整的 template。</p>
<h1 id="stack">Stack</h1>
<p>Template 只是一個設定檔，用來告訴 Heat 如何去配置你的 project。而在 Heat 中，真正擁有這些 resource 的就是 stack。
將 Template 轉成 Stack 有兩種方式：</p>
<ol>
<li>透過 Horizon 設定</li>
<li>透過 heat command line 設定</li>
</ol>
<h2 id="launch-a-stack-on-horizon">Launch a Stack on Horizon</h2>
<p>步驟：</p>
<ol start="0">
<li>先準備好你的 Template</li>
<li>登入你的 OpenStack Dashboard，並選擇 <code>Orchestration</code> 然後再切換到 <code>Stacks</code> 分頁。</li>
<li>點選 <code>Launch Stack</code>，接下來會跳出設定視窗。
<img src="http://i.imgur.com/5SgFMYz.png" alt="Launch Stack in Horizon (1)">
這裡選擇 Template 的輸入方式，如果你已經準備好了 Template file，則你可以 upload 這個檔案到 dashboard 上。</li>
<li>點選 <code>Next</code> 之後，接下來必須要設定 Stack 的名稱，以及密碼。
<img src="http://i.imgur.com/mBQ2eNi.png" alt="Launch Stack in Horizon (2)"></li>
<li>點選 <code>Launch</code> 之後，接下來就會回到 Stack 列表，並且新的 Stack 就會出現在列表中。
<img src="http://imgur.com/2vcv4Oq.png" alt="Heat Stack List"></li>
</ol>
<p>接下來只要稍微等一段時間，直到 Stack 的狀態為: <code>Create Complete </code>。就完成工作囉!!~</p>
<h2 id="launch-a-stack-with-heat-command-client">Launch a Stack with Heat command client</h2>
<p>步驟：</p>
<ol>
<li>先準備好你的 Template</li>
<li>使用 <code>heat stack-create</code> 來建立一個新的 Stack
<img src="http://i.imgur.com/1HOe2Qu.png" alt="Help message of Heat command to create stack"></li>
</ol>
<p>執行 <code>heat stack-create -f MyTemplate.json --poll 5 MyStackName</code>
<img src="http://i.imgur.com/a9qbRcv.png" alt="Launch Stack with Heat Command (1)"></p>
<p>接下來，Heat 就會開始建立 Stack。</p>
<p>完成之後，會出現 <strong>Stack</strong> <code>MyStackName</code> <strong>CREATE_COMPLETE</strong>。
<img src="http://i.imgur.com/r3RRcPl.png" alt="Launch Stack with Heat Command (2)"></p>
<p>你可以執行 <code>heat stack-list</code> 來察看你的 stack 列表。</p>
<h1 id="reference">Reference</h1>
<ol>
<li><a href="http://blog.scottlowe.org/2014/05/01/an-introduction-to-openstack-heat/">An Introduction to OpenStack Heat</a></li>
</ol>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/heat">heat</a></li>
					
					<li><a href="/tags/openstack">openstack</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
