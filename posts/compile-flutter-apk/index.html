<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>編譯 Flutter APK - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="本文主要紀錄使用 flutter 編譯 app apk 時遇到的問題與解法。
版本資訊:



#
Version




Flutter
3.0.1


Host OS
MacOS Big Sur (11.3.1)


Android Studio
2020.3 (AI-203.7717.56.2031.7678000)


Android Platform Tool
r33.0.2


OpenJDK
18.0.1.1


Android (phone)
11


" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="編譯 Flutter APK" />
<meta property="og:description" content="本文主要紀錄使用 flutter 編譯 app apk 時遇到的問題與解法。
版本資訊:



#
Version




Flutter
3.0.1


Host OS
MacOS Big Sur (11.3.1)


Android Studio
2020.3 (AI-203.7717.56.2031.7678000)


Android Platform Tool
r33.0.2


OpenJDK
18.0.1.1


Android (phone)
11


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/compile-flutter-apk/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-10T10:12:20+08:00" />
<meta property="article:modified_time" content="2022-06-10T10:12:20+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="編譯 Flutter APK"/>
<meta name="twitter:description" content="本文主要紀錄使用 flutter 編譯 app apk 時遇到的問題與解法。
版本資訊:



#
Version




Flutter
3.0.1


Host OS
MacOS Big Sur (11.3.1)


Android Studio
2020.3 (AI-203.7717.56.2031.7678000)


Android Platform Tool
r33.0.2


OpenJDK
18.0.1.1


Android (phone)
11


"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">編譯 Flutter APK</h1>
			<div class="meta">Posted on Jun 10, 2022</div>
		</div>
		

		<section class="body">
			<p>本文主要紀錄使用 flutter 編譯 app apk 時遇到的問題與解法。</p>
<p>版本資訊:</p>
<table>
<thead>
<tr>
<th style="text-align:left">#</th>
<th style="text-align:left">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Flutter</td>
<td style="text-align:left">3.0.1</td>
</tr>
<tr>
<td style="text-align:left">Host OS</td>
<td style="text-align:left">MacOS Big Sur (11.3.1)</td>
</tr>
<tr>
<td style="text-align:left">Android Studio</td>
<td style="text-align:left">2020.3 (AI-203.7717.56.2031.7678000)</td>
</tr>
<tr>
<td style="text-align:left">Android Platform Tool</td>
<td style="text-align:left">r33.0.2</td>
</tr>
<tr>
<td style="text-align:left">OpenJDK</td>
<td style="text-align:left">18.0.1.1</td>
</tr>
<tr>
<td style="text-align:left">Android (phone)</td>
<td style="text-align:left">11</td>
</tr>
</tbody>
</table>
<h1 id="問題列表">問題列表</h1>
<h2 id="android-sdk-version">Android SDK Version</h2>
<p>編譯 camera plugin 時出現錯誤訊息如下：</p>
<p><img src="https://i.imgur.com/kHxNVdJ.png" alt="Imgur"></p>
<p>錯誤訊息中提示解決方法是指定 <code>minSdkVersion</code> 版本。解法是編輯 <code>android/app/build.gradle</code>，修改 <code>android</code> 的 <code>defaultConfig</code> 區塊：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gradle" data-lang="gradle"><span style="display:flex;"><span>android <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    defaultConfig <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// minSdkVersion flutter.minSdkVersion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        minSdkVersion <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>照步驟改完重新編譯即可。</p>
<h2 id="openjdk-version">OpenJDK Version</h2>
<p>第一個錯誤訊息沒有保存到，依稀記得是類似語法錯誤。猜測可能是 jdk 版本太老舊。但是更新了系統的 jdk 依然沒效，仔細看編譯的過程才發現 flutter 是使用 android studio 自帶的 jdk，而非 system path 裡的。</p>
<p>我的解決方法：</p>
<ol>
<li>打開 <a href="https://docs.gradle.org/current/userguide/compatibility.html">Compatibility Matrix</a> 查詢當前 gradle 對應的 jdk 版本：</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center">Java</th>
<th style="text-align:center">Gradle</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">2.0</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">4.3</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">4.7</td>
</tr>
<tr>
<td style="text-align:center">11</td>
<td style="text-align:center">5.0</td>
</tr>
<tr>
<td style="text-align:center">12</td>
<td style="text-align:center">5.4</td>
</tr>
<tr>
<td style="text-align:center">13</td>
<td style="text-align:center">6.0</td>
</tr>
<tr>
<td style="text-align:center">14</td>
<td style="text-align:center">6.3</td>
</tr>
<tr>
<td style="text-align:center">15</td>
<td style="text-align:center">6.7</td>
</tr>
<tr>
<td style="text-align:center">16</td>
<td style="text-align:center">7.0</td>
</tr>
<tr>
<td style="text-align:center">17</td>
<td style="text-align:center">7.3</td>
</tr>
</tbody>
</table>
<p>我的 flutter project 創建時自動指定的 gradle 版本是 6.7，而我的 android studio 內建的 jdk 是 11 版，明顯落後版本的最低需求。因此下一步就是下載並安裝<a href="https://openjdk.java.net/projects/jdk/">新版 OpenJDK</a>，並替換掉內建的版本。</p>
<ol start="2">
<li>安裝完 OpenJDK 之後，接下來就是更換 jdk。這裡提供我的(有點暴力)作法:</li>
</ol>
<blockquote>
<p>注意: <!-- raw HTML omitted --><strong>替換掉 OpenJDK 版本可能會讓 Android Studio 無法使用</strong><!-- raw HTML omitted -->，因此如果習慣用 Android Studio 開發的朋友請謹慎。另外最好也做一個備份。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /Applications/Android Studio.app/Contents/jre
</span></span><span style="display:flex;"><span><span style="color:#75715e"># tar jcf ~/Downloads/AndroidStudioJDK_backup.tar.bz2 Contents/</span>
</span></span><span style="display:flex;"><span>rm -rf Contents
</span></span><span style="display:flex;"><span>ln -s /Library/Java/JavaVirtualMachines/jdk-18.0.1.1.jdk/Contents Contents
</span></span></code></pre></div><p>更新完重新編譯即可。</p>
<h2 id="gradle-and-kotlin-version">Gradle (and Kotlin) Version</h2>
<p>編譯過程中出現的錯誤訊息:</p>
<p><img src="https://i.imgur.com/h7oVCxx.png" alt="Imgur"></p>
<p>看錯誤訊息，應該還是版本問題。編譯失敗的 plugin 是 <a href="https://pub.dev/packages/image_picker">image_picker</a>。但是我的 project 裡並沒有直接使用 image_picker，而是其他 package 相依性自帶的；更新版本只能透過執行 <code>flutter pub upgrade</code> 但是依然無法解決。</p>
<p>仔細看 log 裏面提示解決問題的建議步驟：</p>
<ol>
<li>查看官方 issue list</li>
<li>如果線上沒有，建議提交一個 issue</li>
</ol>
<p>按照提示，我找到了: <a href="https://issuetracker.google.com/issues/234820023">GitHub Actions: &lsquo;:app:lintVitalRelease&rsquo;. &gt; &lsquo;:image_picker_android:debugUnitTestRuntimeClasspath&rsquo;.</a></p>
<p>在回覆留言中找到了正確的解決方法:</p>
<p><img src="https://i.imgur.com/I0kkaZO.png" alt="Imgur"></p>
<p>照步驟改完重新編譯即可。</p>
<h2 id="plugin-version">Plugin Version</h2>
<p>編譯 <a href="https://pub.dev/packages/flutter_openim_sdk">flutter_openim_sdk</a> 時出現的錯誤：</p>
<p><img src="https://i.imgur.com/u1AmAF6.png" alt="Imgur"></p>
<p>中間 trace 了很久，最後發現是 repo 上找不到相應的資源。pubspec.yml 裡 flutter_openim_sdk  是 2.0.9；而 repo 的資源只有 2.0.9.10。原來是版本已經更新，舊版的資源直接被刪了。</p>
<p><img src="https://i.imgur.com/DdQlKTh.png" alt="Imgur"></p>
<p>解法也就只能更新 plugin 了。</p>
<h1 id="install-apk">Install apk</h1>
<p>順便紀錄一下如何用 adb 經由無線網路安裝 apk 的方式：</p>
<ul>
<li>
<p>手機</p>
<ol>
<li>啟用開發者模式</li>
<li>啟用 wlan debug</li>
<li>打開配對資訊 (我拿到的是中國手機，不知道台版的叫什麼名稱)</li>
</ol>
<p><img src="https://i.imgur.com/827KyWX.jpg" alt="Imgur"></p>
<p>上圖中有兩個地址:</p>
<ol>
<li><code>192.168.100.141:41679</code> 這是配對用的</li>
<li><code>192.168.100.141:41577</code> 這是adb connect用的</li>
</ol>
</li>
<li>
<p>adb</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>adb pair 192.168.100.141:41679 <span style="color:#ae81ff">497130</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># adb devices -l</span>
</span></span><span style="display:flex;"><span>adb connect 192.168.100.141:41577
</span></span><span style="display:flex;"><span>adb install build/app/outputs/flutter-apk/app-release.apk
</span></span></code></pre></div></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/flutter">flutter</a></li>
					
					<li><a href="/tags/grandle">grandle</a></li>
					
					<li><a href="/tags/apk">apk</a></li>
					
					<li><a href="/tags/android">android</a></li>
					
					<li><a href="/tags/adb">adb</a></li>
					
					<li><a href="/tags/kotlin">kotlin</a></li>
					
					<li><a href="/tags/openjdk">openjdk</a></li>
					
					<li><a href="/tags/openim">openim</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
