<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>解决 Ceph PG stuck in degraded &#43; undersized - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="執行 ceph -s 發現有很多 pg 狀態卡住不動。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="解决 Ceph PG stuck in degraded &#43; undersized" />
<meta property="og:description" content="執行 ceph -s 發現有很多 pg 狀態卡住不動。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/ceph-pg-stuck-stuck-in-degraded-and-undersized/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-12-17T17:08:53+00:00" />
<meta property="article:modified_time" content="2015-12-17T17:08:53+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="解决 Ceph PG stuck in degraded &#43; undersized"/>
<meta name="twitter:description" content="執行 ceph -s 發現有很多 pg 狀態卡住不動。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">解决 Ceph PG stuck in degraded &#43; undersized</h1>
			<div class="meta">Posted on Dec 17, 2015</div>
		</div>
		

		<section class="body">
			<p>執行 <code>ceph -s</code> 發現有很多 pg 狀態卡住不動。</p>
<pre tabindex="0"><code>cluster 1a1d374a-c6e9-48cb-9b45-525a6fdaa91e
 health HEALTH_WARN
        64 pgs degraded
        64 pgs stale
        64 pgs stuck degraded
        64 pgs stuck stale
        64 pgs stuck unclean
        64 pgs stuck undersized
        64 pgs undersized
 monmap e1: 1 mons at {twin-storage-01=172.16.91.1:6789/0}
        election epoch 2, quorum 0 twin-storage-01
 mdsmap e5: 1/1/1 up {0=twin-storage-01=up:active}
 osdmap e92: 7 osds: 7 up, 7 in
  pgmap v685: 832 pgs, 7 pools, 43573 kB data, 38 objects
        7491 MB used, 14889 GB / 14896 GB avail
             769 active+clean
              37 stale+active+undersized+degraded+remapped
              26 stale+active+undersized+degraded
</code></pre><p>很多 pg 卡在 <code>degraded</code> + <code>undersized</code> 狀態。</p>
<p>執行 <code>ceph health detail</code> 看到詳細一點的資訊：</p>
<pre tabindex="0"><code>pg 0.2c is stuck stale for 59834.916633, current state stale+active+undersized+degraded, last acting [0]
pg 0.2b is stuck stale for 59834.916635, current state stale+active+undersized+degraded, last acting [0]
pg 0.2a is stuck stale for 59834.916637, current state stale+active+undersized+degraded+remapped, last acting [0]
pg 0.29 is stuck stale for 59834.916638, current state stale+active+undersized+degraded, last acting [0]
pg 0.28 is stuck stale for 59834.916640, current state stale+active+undersized+degraded, last acting [0]
pg 0.27 is stuck stale for 59834.916642, current state stale+active+undersized+degraded+remapped, last acting [0]
pg 0.26 is stuck stale for 59834.916644, current state stale+active+undersized+degraded+remapped, last acting [0]
pg 0.25 is stuck stale for 59834.916645, current state stale+active+undersized+degraded+remapped, last acting [0]
pg 0.24 is stuck stale for 59834.916647, current state stale+active+undersized+degraded+remapped, last acting [0]
</code></pre><p>想要利用 <code>ceph pg &lt;pgid&gt; query</code> 查看 pg 的詳細資訊，卻出現 error：</p>
<pre tabindex="0"><code>$ ceph pg 0.24 query
Error ENOENT: i don&#39;t have pgid 0.24
</code></pre><p>猜測問題產生的原因，可能是我在建置這一套 Ceph cluster 時，曾經把所有的 OSD 都移出重建。可能移除時沒有把資料清乾淨；或是我移除的方法不對，&hellip;等原因。</p>
<hr>
<h1 id="solution">Solution</h1>
<p>解決方法就是用 <code>ceph pg force_creat_pg &lt;pgid&gt;</code> 去覆蓋那個有問題的 pg</p>
<pre tabindex="0"><code>$ ceph pg force_create_pg 0.24
pg 0.24 now creating, ok
</code></pre><p>這個 pg 就會轉成 <code>creating</code>，過一段時間，等 <code>creating</code>完成之後，就可以 query 出那個 pg 的資訊：</p>
<pre tabindex="0"><code>$ ceph pg 0.24 query
{
    &#34;state&#34;: &#34;active+clean&#34;,
    &#34;snap_trimq&#34;: &#34;[]&#34;,
    &#34;epoch&#34;: 94,
    &#34;up&#34;: [
        2,
        4
    ],

    ... (省略)...

    &#34;agent_state&#34;: {}
}
</code></pre><p>同時，<code>ceph -s</code>也可以看到少了有狀況的 pg：</p>
<pre tabindex="0"><code>cluster 1a1d374a-c6e9-48cb-9b45-525a6fdaa91e
 health HEALTH_WARN
        63 pgs degraded
        63 pgs stale
        63 pgs stuck degraded
        63 pgs stuck stale
        63 pgs stuck unclean
        63 pgs stuck undersized
        63 pgs undersized
 monmap e1: 1 mons at {twin-storage-01=172.16.91.1:6789/0}
        election epoch 2, quorum 0 twin-storage-01
 mdsmap e5: 1/1/1 up {0=twin-storage-01=up:active}
 osdmap e92: 7 osds: 7 up, 7 in
  pgmap v685: 832 pgs, 7 pools, 43573 kB data, 38 objects
        7491 MB used, 14889 GB / 14896 GB avail
             769 active+clean
              37 stale+active+undersized+degraded+remapped
              26 stale+active+undersized+degraded
</code></pre><hr>
<p>如果有問題的 pg 數量很多，可以用 for loop 去跑：</p>
<pre tabindex="0"><code>for pg in `ceph health detail | grep &#34;stale+active+undersized+degraded&#34; | awk &#39;{print $2}&#39; | sort | uniq`;
do
  ceph pg force_create_pg $pg
done
</code></pre><p>用 for loop 跑指令下太快，可能會變成以下狀況：</p>
<pre tabindex="0"><code>cluster 1a1d374a-c6e9-48cb-9b45-525a6fdaa91e
 health HEALTH_WARN
        63 pgs stuck inactive
        63 pgs stuck unclean
 monmap e1: 1 mons at {twin-storage-01=172.16.91.1:6789/0}
        election epoch 2, quorum 0 twin-storage-01
 mdsmap e5: 1/1/1 up {0=twin-storage-01=up:active}
 osdmap e92: 7 osds: 7 up, 7 in
  pgmap v892: 832 pgs, 7 pools, 45412 kB data, 42 objects
        7496 MB used, 14889 GB / 14896 GB avail
             769 active+clean
              63 creating
</code></pre><p><code>ceph health detal</code> 出現：</p>
<pre tabindex="0"><code>pg 0.31 is stuck inactive since forever, current state creating, last acting []
</code></pre><p>這時先不要急，放著讓他處理一段時間即可。</p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/ceph">ceph</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
