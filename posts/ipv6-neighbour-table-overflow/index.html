<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>IPv6 Neighbour table overflow - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="這兩天一直在 syslog 上看到 Neighbour table overflow
Apr 30 06:27:03 host-42 kernel: [72924.290265] net_ratelimit: 1739 callbacks suppressed
Apr 30 06:27:03 host-42 kernel: [72924.290269] IPv6: Neighbour table overflow
每兩分鐘就出現6~7筆,數量非常的多
如果不處理它，放任它繼續增長，過一兩天後系統就會 kernel panic。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="IPv6 Neighbour table overflow" />
<meta property="og:description" content="這兩天一直在 syslog 上看到 Neighbour table overflow
Apr 30 06:27:03 host-42 kernel: [72924.290265] net_ratelimit: 1739 callbacks suppressed
Apr 30 06:27:03 host-42 kernel: [72924.290269] IPv6: Neighbour table overflow
每兩分鐘就出現6~7筆,數量非常的多
如果不處理它，放任它繼續增長，過一兩天後系統就會 kernel panic。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/ipv6-neighbour-table-overflow/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-05-01T12:07:00+00:00" />
<meta property="article:modified_time" content="2015-05-01T12:07:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="IPv6 Neighbour table overflow"/>
<meta name="twitter:description" content="這兩天一直在 syslog 上看到 Neighbour table overflow
Apr 30 06:27:03 host-42 kernel: [72924.290265] net_ratelimit: 1739 callbacks suppressed
Apr 30 06:27:03 host-42 kernel: [72924.290269] IPv6: Neighbour table overflow
每兩分鐘就出現6~7筆,數量非常的多
如果不處理它，放任它繼續增長，過一兩天後系統就會 kernel panic。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">IPv6 Neighbour table overflow</h1>
			<div class="meta">Posted on May 1, 2015</div>
		</div>
		

		<section class="body">
			<p>這兩天一直在 syslog 上看到 <code>Neighbour table overflow</code></p>
<pre tabindex="0"><code class="language-syslog" data-lang="syslog">Apr 30 06:27:03 host-42 kernel: [72924.290265] net_ratelimit: 1739 callbacks suppressed
Apr 30 06:27:03 host-42 kernel: [72924.290269] IPv6: Neighbour table overflow
</code></pre><p>每兩分鐘就出現6~7筆,數量非常的多
如果不處理它，放任它繼續增長，過一兩天後系統就會 kernel panic。</p>
<p>Google 一番之後大概得知，neighbour table 基本上就是 arp table。所以簡單來說就是 arp table 爆了。
問題是我已經把 IPv6 都關了，還能衝爆 neighbour table 實在無法理解。</p>
<h2 id="increase-the-size-of-neighbour-table">Increase the size of neighbour table</h2>
<p>這大概是搜尋到最多的解法，簡單來說就是直接增加 neighbour table 的大小。</p>
<p>設定 <code>/etc/sysctl.conf</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>net<span style="color:#f92672">.</span>ipv6<span style="color:#f92672">.</span>neigh<span style="color:#f92672">.</span>default<span style="color:#f92672">.</span>gc_thresh1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>ipv6<span style="color:#f92672">.</span>neigh<span style="color:#f92672">.</span>default<span style="color:#f92672">.</span>gc_thresh2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">8192</span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>ipv6<span style="color:#f92672">.</span>neigh<span style="color:#f92672">.</span>default<span style="color:#f92672">.</span>gc_thresh3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">8192</span>
</span></span></code></pre></div><p>然後在執行 <code>sysctl -p</code> 讓設定值生效。</p>
<p>在網路上搜尋到的範例大多都是設定成 512, 1024, 2048。這些設定對我的平台一點效果都沒有，必須要設定到 4096, 8192 才夠用。</p>
<h2 id="disable-ipv6">Disable IPv6</h2>
<p>原本我是在 <code>/etc/sysctl.conf</code> 中加入以下設定來關閉 IPv6：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>net<span style="color:#f92672">.</span>ipv6<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>all<span style="color:#f92672">.</span>disable_ipv6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>ipv6<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>default<span style="color:#f92672">.</span>disable_ipv6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>net<span style="color:#f92672">.</span>ipv6<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>lo<span style="color:#f92672">.</span>disable_ipv6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>但是很顯然的，這並沒有真正的關閉 IPv6。到比較像是單純隱藏 IPv6 的感覺。最好的證明就是：</p>
<ol>
<li><code>netstat -tnlup</code> 可以看到部分 service 依然監聽 IPv6</li>
<li>Neighbour table overflow 的狀況出現</li>
</ol>
<p>因此我嘗試了一下用 grub 的方式關閉，沒想到效果不錯。</p>
<ol>
<li>編輯 <code>/etc/default/grub</code>, 並且在 <code>GRUB_CMDLINE_LINUX</code> 的設定中加入 <code>ipv6.disable=1</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>GRUB_CMDLINE_LINUX<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ipv6.disable=1&#34;</span>
</span></span></code></pre></div><ol start="2">
<li>更新 grub <code>update-grub</code></li>
<li>Reboot</li>
</ol>
<p>設定完之後發現:</p>
<ul>
<li><code>netstat -tnlup</code> 再也看不到有 service listen on IPv6 address</li>
<li>先前加的 sysctl 參數，不論是 disable IPv6 還是 increase neighbour table size 都直接失效。</li>
</ul>
<pre tabindex="0"><code>root@localhost:~ # sysctl -p
error: &#34;net.ipv6.conf.all.disable_ipv6&#34; is an unknown key
error: &#34;net.ipv6.conf.default.disable_ipv6&#34; is an unknown key
error: &#34;net.ipv6.conf.lo.disable_ipv6&#34; is an unknown key
error: &#34;net.ipv6.neigh.default.gc_thresh1&#34; is an unknown key
error: &#34;net.ipv6.neigh.default.gc_thresh2&#34; is an unknown key
error: &#34;net.ipv6.neigh.default.gc_thresh3&#34; is an unknown key
</code></pre><p>即使將 disable_ipv6 都設定為 0 ，也無法啟用 IPv6。</p>
<h2 id="現況與採取方案">現況與採取方案</h2>
<p>一開始先採用了第一個方案，但是數值設太小了，沒多久系統又爆出一樣的 error；於是採取的第二個方案，在 grub 的參數上增加 <code>ipv6.disable=1</code>。結果 syslog 終於沒有在看到這個 error，但是 syslog 中出現另外一個錯誤：</p>
<pre tabindex="0"><code>Apr 28 06:50:52 host-42 ovs-vsctl: 00001|vsctl|INFO|Called as /usr/bin/ovs-vsctl --timeout=2 add-port br-tun gre-10
Apr 28 06:50:52 host-42 ovs-vsctl: 00002|vsctl|ERR|cannot create a port named gre-10 because a port named gre-10 already exists on bridge br-tun
Apr 28 06:50:53 host-42 ovs-vsctl: 00001|vsctl|INFO|Called as /usr/bin/ovs-vsctl --timeout=2 set Interface gre-10 type=gre
Apr 28 06:50:53 host-42 ovs-vsctl: 00001|vsctl|INFO|Called as /usr/bin/ovs-vsctl --timeout=2 set Interface gre-10 options:remote_ip=192.168.91.93
Apr 28 06:50:53 host-42 ovs-vsctl: 00001|vsctl|INFO|Called as /usr/bin/ovs-vsctl --timeout=2 set Interface gre-10 options:in_key=flow
Apr 28 06:50:53 host-42 ovs-vsctl: 00001|vsctl|INFO|Called as /usr/bin/ovs-vsctl --timeout=2 set Interface gre-10 options:out_key=flow
</code></pre><p>這個問題很久以前就看過，但是以前都不影響 OpenStack 的運作；而這次 syslog 中每一秒都出現這個 error，OpenStack virtual network 也跟著一起掛了。嘗試將 IPv6 打開，這個 error 就消除了。這讓我感到非常莫名其妙，目前也還不太清楚發生的原因。</p>
<p>最後還是回到第一個方案，並起將參數調大至 4096 與 8192，最後才讓系統恢復正常運作。但我心中認為這是個治標不治本的方案。看來只能多花點時間研究一下 IPv6 的機制了。</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="http://www.arcweb.ro/blog/2011/12/13/neighbour-table-overflow-debug-ipv4-and-ipv6/">Neighbour table overflow – debug – IPv4 and IPv6</a></li>
<li><a href="http://blog.csdn.net/reyleon/article/details/24981581">neighbour table overflow 问题解决</a><strong>(Important)</strong></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/grub">grub</a></li>
					
					<li><a href="/tags/ipv6">ipv6</a></li>
					
					<li><a href="/tags/openstack">openstack</a></li>
					
					<li><a href="/tags/ubuntu">ubuntu</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
