<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Configure Open vSwitch in OpenWRT - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="當你安裝完 Open vSwitch 或是燒了一個內建 Open vSwitch 的 OpenWRT 後，接下來要將網卡綁到 Open vSwitch 上。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Configure Open vSwitch in OpenWRT" />
<meta property="og:description" content="當你安裝完 Open vSwitch 或是燒了一個內建 Open vSwitch 的 OpenWRT 後，接下來要將網卡綁到 Open vSwitch 上。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/configure-open-vswitch-in-openwrt/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-03-18T17:04:00+00:00" />
<meta property="article:modified_time" content="2015-03-18T17:04:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="Configure Open vSwitch in OpenWRT"/>
<meta name="twitter:description" content="當你安裝完 Open vSwitch 或是燒了一個內建 Open vSwitch 的 OpenWRT 後，接下來要將網卡綁到 Open vSwitch 上。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Configure Open vSwitch in OpenWRT</h1>
			<div class="meta">Posted on Mar 18, 2015</div>
		</div>
		

		<section class="body">
			<p>當你安裝完 Open vSwitch 或是燒了一個<a href="http://worldend.logdown.com/posts/256561-compile-openwrt-with-open-vswitch">內建 Open vSwitch 的 OpenWRT</a> 後，接下來要將網卡綁到 Open vSwitch 上。</p>
<h1 id="實驗環境"><strong>實驗環境</strong></h1>
<ul>
<li>路由器: <a href="http://www.tp-link.tw/products/details/?model=TL-WR1043ND">TP-Link TL-WR1043ND</a>
<ul>
<li>Wan port x 1</li>
<li>Lan port x 4</li>
</ul>
</li>
</ul>
<hr>
<h1 id="prepare-work">Prepare Work</h1>
<ul>
<li>
<p><strong>更換 root 密碼</strong></p>
<p>剛裝好 OpenWRT 之後，要先設定 root 密碼。第一次登入必須使用 telnet 從 lan 登入:</p>
<pre tabindex="0"><code>telnet 192.168.1.1
</code></pre><p>接下來執行 <code>passwd</code> 更換 root 密碼:</p>
<pre tabindex="0"><code>root@OpenWrt:/# passwd
Changing password for root
New password:
Retype password:
Password for root changed by root
</code></pre><p>執行 <code>exit</code> 登出，然後改用 ssh 登入。 (或者是 Luci)</p>
<pre tabindex="0"><code>ssh root@192.168.1.1
</code></pre></li>
</ul>
<pre tabindex="0"><code>
## Modify network configuration

Network 設定檔在 `/etc/config/network`，先看一下 **lan** 預設值:

```python /etc/config/network
config interface &#39;lan&#39;
	option ifname &#39;eth1&#39;
	option force_link &#39;1&#39;
	option type &#39;bridge&#39;
	option proto &#39;static&#39;
	option ipaddr &#39;192.168.1.1&#39;
	option netmask &#39;255.255.255.0&#39;
	option ip6assign &#39;60&#39;
</code></pre><ul>
<li><code>lan</code> 是<strong>網路名稱</strong> 而非網卡名稱</li>
<li>ifname 後面接網卡名稱，<code>eth1</code> (lan port)。<strong>每一個 network 只能設定一個 ifname</strong>。</li>
<li>proto 後面接設定網路的方式: 固定 IP 就是 <code>static</code>、浮動 IP 就是 <code>dhcp</code>；其他還有 ppp &hellip;等。</li>
</ul>
<p>lan 的 type 為 <code>bridge</code>，使用 <code>ifconfig</code> 與 <code>brctl</code> 可以觀察到:</p>
<pre tabindex="0"><code>root@OpenWrt:~# ifconfig br-lan
br-lan    Link encap:Ethernet  HWaddr E8:DE:27:67:05:6E  
          inet addr:192.168.1.1  Bcast:192.168.1.255  Mask:255.255.255.0
          inet6 addr: fddb:c62a:a451::1/60 Scope:Global
          inet6 addr: fe80::eade:27ff:fe67:56e/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:48715 errors:0 dropped:0 overruns:0 frame:0
          TX packets:51387 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:9282220 (8.8 MiB)  TX bytes:22974165 (21.9 MiB)

root@OpenWrt:~# brctl show
bridge name	bridge id		STP enabled	interfaces
br-lan		7fff.e8de2767056e	no		eth1
</code></pre><p>接下來我們要做的事情是:</p>
<ol>
<li>設定 lan 的網卡為 Open vSwitch 的 switch name</li>
<li>設定新的 network 來開啟原本的網卡</li>
</ol>
<p>因此，第一步就是要修改 <code>/etc/config/network</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>config interface <span style="color:#e6db74">&#39;lan&#39;</span>                         
</span></span><span style="display:flex;"><span>        option ifname <span style="color:#e6db74">&#39;ovs-lan&#39;</span>                
</span></span><span style="display:flex;"><span>        option proto <span style="color:#e6db74">&#39;static&#39;</span>                  
</span></span><span style="display:flex;"><span>        option ipaddr <span style="color:#e6db74">&#39;192.168.1.1&#39;</span>            
</span></span><span style="display:flex;"><span>        option netmask <span style="color:#e6db74">&#39;255.255.255.0&#39;</span>         
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config interface <span style="color:#e6db74">&#39;eth1&#39;</span>               
</span></span><span style="display:flex;"><span>        option ifname <span style="color:#e6db74">&#39;eth1&#39;</span>          
</span></span><span style="display:flex;"><span>        option proto <span style="color:#e6db74">&#39;static&#39;</span>
</span></span></code></pre></div><p>接下來，要使用指令來做幾個步驟:</p>
<ul>
<li>建立 ovs bridge</li>
<li>移除 linux bridge 上原本的 interface</li>
<li>將 interface 新增到 ovs bridge 中</li>
<li>重新啟動網路套用新的設定值</li>
</ul>
<p>以上步驟可以利用 script 一氣呵成。 (當然也可以手動慢慢打指令，但是要注意的是執行 <code>brctl delif</code> 與 <code>ovs-vsctl add-port</code> 時會造成網路斷線)</p>
<p>新增並執行 scrpit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>OVS_LAN<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ovs-lan&#34;</span>
</span></span><span style="display:flex;"><span>LAN_PORT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;eth1&#34;</span>
</span></span><span style="display:flex;"><span>LINUX_BRIDGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;br-lan&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create Open vSwitch</span>
</span></span><span style="display:flex;"><span>ovs-vsctl --may-exist add-br $OVS_LAN
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove LAN port from Linux bridge</span>
</span></span><span style="display:flex;"><span>brctl delif $LINUX_BRIDGE $LAN_PORT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add LAN port to Open vSwitch</span>
</span></span><span style="display:flex;"><span>ovs-vsctl --may-exist add-port $OVS_LAN $LAN_PORT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Restart network</span>
</span></span><span style="display:flex;"><span>/etc/init.d/network restart
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>這樣就完成了 Open vSwitch 的基礎設定。</p>
<pre tabindex="0"><code>root@OpenWrt:~# ovs-vsctl show
f9a6117b-8af2-400b-91ff-39986349f0c6
    Bridge ovs-lan
        Port ovs-lan
            Interface ovs-lan
                type: internal
        Port &#34;eth1&#34;
            Interface &#34;eth1&#34;
</code></pre><h2 id="wifi">Wifi</h2>
<p>Wifi 的設定檔放在 <code>/etc/config/wireless</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>onfig wifi-device  radio0
</span></span><span style="display:flex;"><span>        option type     mac80211
</span></span><span style="display:flex;"><span>        option channel  11
</span></span><span style="display:flex;"><span>        option hwmode   11g
</span></span><span style="display:flex;"><span>        option path     &#39;platform/qca955x_wmac&#39;
</span></span><span style="display:flex;"><span>        option htmode   HT20
</span></span><span style="display:flex;"><span>        # REMOVE THIS LINE TO ENABLE WIFI:
</span></span><span style="display:flex;"><span>        option disabled 1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>config wifi-iface
</span></span><span style="display:flex;"><span>        option device   radio0
</span></span><span style="display:flex;"><span>        option network  lan
</span></span><span style="display:flex;"><span>        option mode     ap
</span></span><span style="display:flex;"><span>        option ssid     OpenWrt
</span></span><span style="display:flex;"><span>        option encryption none
</span></span></code></pre></div><p>註解 <code>option disabled 1</code> 這行，然後執行 <code>wifi</code></p>
<p>執行 <code>ifconfig</code> 可以看到 <code>wlan0</code> 這個介面</p>
<pre tabindex="0"><code>wlan0     Link encap:Ethernet  HWaddr E8:DE:27:67:05:6E  
          inet6 addr: fe80::eade:27ff:fe67:56e/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:4 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:0 (0.0 B)  TX bytes:480 (480.0 B)
</code></pre><p>但是利用 ovs-vsctl show 卻看到 wlan0 沒有被新增到 openvswitch 裡:</p>
<pre tabindex="0"><code>root@OpenWrt:~# ovs-vsctl show
f9a6117b-8af2-400b-91ff-39986349f0c6
    Bridge ovs-lan
        Port ovs-lan
            Interface ovs-lan
                type: internal
        Port &#34;eth1&#34;
            Interface &#34;eth1&#34;
</code></pre><p>手動執行 <code>ovs-vsctl add-port</code> 去新增 wlan0</p>
<pre tabindex="0"><code>ovs-vsctl add-port ovs-lan wlan0
</code></pre><p>這時候再用 ovs-vsctl show 就會看到 wlan0 加入到 openvswitch 中。使用無線裝置測試連線，可以順利取得 IP 並連上 internet。</p>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="http://roan.logdown.com/posts/239799-openvswitch-lab-7-setting-openwrt">OpenvSwitch Lab 7$ Setting OpenWrt</a></li>
<li><a href="http://linton.tw/2014/05/13/openflow-13-for-openwrt-on-tl-1043nd-with-open-vswitch/">OpenFlow 1.3 for OpenWRT on TL-1043ND with OVS</a></li>
</ul>
<hr>
<h1 id="附錄">附錄</h1>
<p>如果想要自己手動打指令的方式去設定，有兩種方法:</p>
<ol>
<li>
<p>參考 <a href="http://roan.logdown.com/posts/239799-openvswitch-lab-7-setting-openwrt">OpenvSwitch Lab 7$ Setting OpenWrt</a> 這篇的做法，切出一個 console port</p>
</li>
<li>
<p>或者是你跟我一樣懶XD，那就修改 firewall，然後從 wan 登入進去設定。</p>
</li>
</ol>
<p>編輯 <code>/etc/config/firewall</code> 並加上以下內容:</p>
<pre tabindex="0"><code>config rule
        option src              wan
        option dest_port        22
        option target           ACCEPT
        option proto            tcp
</code></pre><p>然後重啟 firewall</p>
<pre tabindex="0"><code>/etc/init.d/firewall restart
</code></pre><p>之後就可以從 wan 登入 OpenWRT 了</p>
<p>Firewall 的規則可以參考 OpenWRT 官方的資料: <a href="http://wiki.openwrt.org/doc/uci/firewall">Firewall configuration</a></p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/openwrt">openwrt</a></li>
					
					<li><a href="/tags/open-vswitch">open vswitch</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
