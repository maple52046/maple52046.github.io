<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Compile OpenWRT With OpenClash - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="最近朋友希望弄一台翻牆路由器放在辦公室用，於是買了一台 Netgear R6300 v2。刷了 DD-WRT 後才發現問題：安裝不了 OpenClash，ipkg 連 update 都不行了，就更不用說安裝。
參考 DD-WRT 官網 development 的 Firmware Modification Kit，將 OpenClash 的 ipk 解壓縮後放進 firmware 一起重編。編譯完後的 fireware 貌似是含有 OpenClash，但是刷到 AP 後卻消失了，web 介面沒有相關的 UI、ssh 進去後也找不到。
重新拾回 OpenWRT，先刷了官網 for R6300v2 的 firmware，在 wifi 上遇到很大的問題：

5G 完全不能用
2.4G 可以用，但是目前實測很不穩 (ping 掉封包、高延遲)

實在不想花太多時間在翻牆上，而且電腦可以插網路線，不影響工作，於是就選擇 OpenWRT。
但是安裝 OpenClash 時又遇到的問題，luci-app-openclash_0.45.59-beta_all.ipk 的相依性 packages 包含了 dnsmasq-full，而官網提供的 firmware 預設已經有了 dnsmasq，這兩個是衝突的。如果 opkg install 加上 --nodeps 是可以解決，安裝完後的 OpenClash 也是可以使用的。不過對於系統潔癖/強迫症患者來說，這裡提供了重新編譯的解法。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Compile OpenWRT With OpenClash" />
<meta property="og:description" content="最近朋友希望弄一台翻牆路由器放在辦公室用，於是買了一台 Netgear R6300 v2。刷了 DD-WRT 後才發現問題：安裝不了 OpenClash，ipkg 連 update 都不行了，就更不用說安裝。
參考 DD-WRT 官網 development 的 Firmware Modification Kit，將 OpenClash 的 ipk 解壓縮後放進 firmware 一起重編。編譯完後的 fireware 貌似是含有 OpenClash，但是刷到 AP 後卻消失了，web 介面沒有相關的 UI、ssh 進去後也找不到。
重新拾回 OpenWRT，先刷了官網 for R6300v2 的 firmware，在 wifi 上遇到很大的問題：

5G 完全不能用
2.4G 可以用，但是目前實測很不穩 (ping 掉封包、高延遲)

實在不想花太多時間在翻牆上，而且電腦可以插網路線，不影響工作，於是就選擇 OpenWRT。
但是安裝 OpenClash 時又遇到的問題，luci-app-openclash_0.45.59-beta_all.ipk 的相依性 packages 包含了 dnsmasq-full，而官網提供的 firmware 預設已經有了 dnsmasq，這兩個是衝突的。如果 opkg install 加上 --nodeps 是可以解決，安裝完後的 OpenClash 也是可以使用的。不過對於系統潔癖/強迫症患者來說，這裡提供了重新編譯的解法。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/compile-openwrt-with-openclash/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-26T16:13:48+08:00" />
<meta property="article:modified_time" content="2022-09-26T16:13:48+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="Compile OpenWRT With OpenClash"/>
<meta name="twitter:description" content="最近朋友希望弄一台翻牆路由器放在辦公室用，於是買了一台 Netgear R6300 v2。刷了 DD-WRT 後才發現問題：安裝不了 OpenClash，ipkg 連 update 都不行了，就更不用說安裝。
參考 DD-WRT 官網 development 的 Firmware Modification Kit，將 OpenClash 的 ipk 解壓縮後放進 firmware 一起重編。編譯完後的 fireware 貌似是含有 OpenClash，但是刷到 AP 後卻消失了，web 介面沒有相關的 UI、ssh 進去後也找不到。
重新拾回 OpenWRT，先刷了官網 for R6300v2 的 firmware，在 wifi 上遇到很大的問題：

5G 完全不能用
2.4G 可以用，但是目前實測很不穩 (ping 掉封包、高延遲)

實在不想花太多時間在翻牆上，而且電腦可以插網路線，不影響工作，於是就選擇 OpenWRT。
但是安裝 OpenClash 時又遇到的問題，luci-app-openclash_0.45.59-beta_all.ipk 的相依性 packages 包含了 dnsmasq-full，而官網提供的 firmware 預設已經有了 dnsmasq，這兩個是衝突的。如果 opkg install 加上 --nodeps 是可以解決，安裝完後的 OpenClash 也是可以使用的。不過對於系統潔癖/強迫症患者來說，這裡提供了重新編譯的解法。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Compile OpenWRT With OpenClash</h1>
			<div class="meta">Posted on Sep 26, 2022</div>
		</div>
		

		<section class="body">
			<p>最近朋友希望弄一台翻牆路由器放在辦公室用，於是買了一台 Netgear R6300 v2。刷了 DD-WRT 後才發現問題：安裝不了 <a href="https://github.com/vernesong/OpenClash">OpenClash</a>，<code>ipkg</code> 連 update 都不行了，就更不用說安裝。</p>
<p>參考 DD-WRT 官網 development 的 <a href="https://wiki.dd-wrt.com/wiki/index.php/Development#Firmware_Modification_Kit">Firmware Modification Kit</a>，將 OpenClash 的 ipk 解壓縮後放進 firmware 一起重編。編譯完後的 fireware 貌似是含有 OpenClash，但是刷到 AP 後卻消失了，web 介面沒有相關的 UI、ssh 進去後也找不到。</p>
<p>重新拾回 OpenWRT，先刷了官網 for R6300v2 的 firmware，在 wifi 上遇到很大的問題：</p>
<ol>
<li>5G 完全不能用</li>
<li>2.4G 可以用，但是目前實測很不穩 (ping 掉封包、高延遲)</li>
</ol>
<p>實在不想花太多時間在翻牆上，而且電腦可以插網路線，不影響工作，於是就選擇 OpenWRT。</p>
<p>但是安裝 OpenClash 時又遇到的問題，<code>luci-app-openclash_0.45.59-beta_all.ipk</code> 的相依性 packages 包含了 <code>dnsmasq-full</code>，而官網提供的 firmware 預設已經有了 <code>dnsmasq</code>，這兩個是衝突的。如果 <code>opkg install</code> 加上 <code>--nodeps</code> 是可以解決，安裝完後的 OpenClash 也是可以使用的。不過對於系統潔癖/強迫症患者來說，這裡提供了重新編譯的解法。</p>
<h2 id="版本">版本</h2>
<table>
<thead>
<tr>
<th style="text-align:left">#</th>
<th style="text-align:left">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">OS <em>(編譯用)</em></td>
<td style="text-align:left">Debian testing</td>
</tr>
<tr>
<td style="text-align:left">OpenWRT</td>
<td style="text-align:left">v22.03.0</td>
</tr>
<tr>
<td style="text-align:left">OpenClash</td>
<td style="text-align:left">v0.45.59-beta</td>
</tr>
</tbody>
</table>
<h2 id="前置工作">前置工作</h2>
<pre tabindex="0"><code>sudo apt install build-essential gawk gcc-multilib flex git gettext libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev clang wget file musl-dev
wget https://github.com/vernesong/OpenClash/archive/refs/tags/v0.45.59-beta.tar.gz
git clone https://git.openwrt.org/openwrt/openwrt.git
cd openwrt/
git checkout v22.03.0
tar zxf ../v0.45.59-beta.tar.gz -C package/
./scripts/feeds update -a
./scripts/feeds install -a
make menuconfig
</code></pre><p>執行完後就會進入選擇畫面：</p>
<p><img src="https://i.imgur.com/FOFbaqS.png" alt="Make menuconfig"></p>
<h2 id="menu-config">Menu Config</h2>
<ul>
<li><code>Target System</code> 選擇 <code>Broadcom BCM47xx/53xx (ARM)</code></li>
<li><code>Target Profile</code> 選擇 <code>NETGEAR R6300 v2</code></li>
<li><code>LuCI</code> -&gt; <code>3. Applications</code> -&gt; <code>luci-app-openclash</code>
<img src="https://i.imgur.com/lfAYSO9.png" alt="Enable luci-app-openclash"></li>
<li><code>LuCI</code> -&gt; <code>1. Collections</code> -&gt; <code>luci</code>
<img src="https://i.imgur.com/o1TWhOM.png" alt="Enable luci"></li>
<li><code>Base system</code> -&gt; <code>dnsmasq</code> (<strong>取消選擇</strong>)
<img src="https://i.imgur.com/BMWGDlQ.png" alt="Disable dnsmasq"></li>
</ul>
<p>然後保存配置為 <code>.config</code> 並退出</p>
<h2 id="編譯">編譯</h2>
<pre tabindex="0"><code>make prepare
make package/feeds/luci/luci-base/compile V=99
make V=s
</code></pre><p>編譯完後 firmware 放在 <code>bin/targets/bcm53xx/generic/</code>，檔名為 <code>openwrt-bcm53xx-generic-netgear_r6300-v2-squashfs.chk</code></p>
<p>之後就可以從 web 頁面或是 <code>sysupgrade</code> 指令刷 firmware。刷完後，web 介面上就可以看到 OpenClash ui：</p>
<p><img src="https://i.imgur.com/1F1A081.png" alt="OpenClash UI"></p>
<blockquote>
<p>刷完後若無配置，service 狀態應該是 stop 而非上圖的 running。</p>
</blockquote>
<h2 id="設定-openclash">設定 OpenClash</h2>
<p>順便紀錄下簡單的配置順序</p>
<ol>
<li>先到 <code>Config Manage</code> 頁面，上傳你的 clash 配置檔</li>
<li>然後切換到 <code>Global Settings</code>，在標籤群組下方的 <code> Current Config File</code> 選擇剛剛上傳的配置，並點擊 <code>Switch Config</code></li>
</ol>
<p><img src="https://i.imgur.com/La4Gbpw.png" alt="Switch clash config"></p>
<blockquote>
<p>其他選項我是靠直覺的設置的，因為不熟悉，不想誤導，這裡就不一一羅列了</p>
</blockquote>
<p>配置完後，回到 <code>Overviews</code> 然後點擊頁面下方 <code>Enable OpenClash</code> 按鈕：</p>
<p><img src="https://i.imgur.com/kNp1Udm.png" alt="Enable OpenClash on LuCI"></p>
<p>等待服務啟動與檢驗即可 (需要等幾分鐘)。</p>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="cp-cannot-stat-rootopenwrtstaging_dirtoolchain-arm_cortex-a9_gcc-1120_musl_eabilibld-musl-so-no-such-file-or-directory"><code>cp: cannot stat '/root/openwrt/staging_dir/toolchain-arm_cortex-a9_gcc-11.2.0_musl_eabi/lib/ld-musl-*.so*': No such file or directory</code></h3>
<p>編譯時可能會出現以下錯誤：</p>
<p><img src="https://i.imgur.com/K2Cg83C.png" alt=""></p>
<p>本來沒有這個問題，但是前幾天更新了系統後就出現了(gcc/musl版本都升級了)。但，即使改放到 docker 裡指定了 <a href="https://gist.github.com/maple52046/00db60a7c2dc53b39b050ecb6e48d68c">gcc 11.2.0</a> 也是一樣的。Google了一下看到別人說是 sdk/toolchain 的問題。根據這個線索最後找到的解法是：先執行 <code>make prepare</code> 把 toolchain 編譯好就可以了。</p>
<h2 id="參考資料">參考資料</h2>
<ul>
<li><a href="https://openwrt.org/docs/guide-developer/toolchain/install-buildsystem">Build system setup</a></li>
<li><a href="https://www.right.com.cn/forum/thread-1086753-1-1.html">请问编译出错bash: po2lmo: command not found怎么弄</a></li>
<li><a href="https://github.com/mchome/openwrt-dogcom/issues/6">cp: cannot stat &lsquo;/root/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-7.3.0_musl/lib/ld-musl-<em>.so</em>&rsquo;: No such file or directory #6</a></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/openwrt">openwrt</a></li>
					
					<li><a href="/tags/openclash">openclash</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
