<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>客製化 Flutter Image Provider - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="之前在 flutter app 中使用 Optimized Cached Image 來展示圖片，選擇他的原因也很簡單，因為當時剛學 flutter 沒多久就要直接上陣了。先選一個看起來簡單好用的再說；而且他還可以設置 cache key，避免重複抓取，感覺起來就不錯。
然而後來圖片一多起來之後，就發現問題了，往往 app 打開滑沒幾下就 crash。看 log 是 OOM 問題，上網查了一下，有人說是 memory leak。大致上就是 image disposed 之後，沒有正確的釋放 ram，app 佔用的 ram 越來越多，就直接觸發 OOM killer。測試了一下原生的 NetworkImage 沒有這個問題。所以應該就是 Optimized Cached Image 的問題了。
另外就是在我的程式裡，widget 只拿到 media id，需要先到後端去查 media 的 presigned url 返回給 app，app 再用 presigned url 抓圖片資料。也就是原來的程式碼裡一直都是 future builder &#43; image，這造成的問題就是頁面一刷新就要重新抓 presigned url，大大降低了效率，也大大提升了後端的負載。
因此決定客製化一個業務專用的 image provider。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="客製化 Flutter Image Provider" />
<meta property="og:description" content="之前在 flutter app 中使用 Optimized Cached Image 來展示圖片，選擇他的原因也很簡單，因為當時剛學 flutter 沒多久就要直接上陣了。先選一個看起來簡單好用的再說；而且他還可以設置 cache key，避免重複抓取，感覺起來就不錯。
然而後來圖片一多起來之後，就發現問題了，往往 app 打開滑沒幾下就 crash。看 log 是 OOM 問題，上網查了一下，有人說是 memory leak。大致上就是 image disposed 之後，沒有正確的釋放 ram，app 佔用的 ram 越來越多，就直接觸發 OOM killer。測試了一下原生的 NetworkImage 沒有這個問題。所以應該就是 Optimized Cached Image 的問題了。
另外就是在我的程式裡，widget 只拿到 media id，需要先到後端去查 media 的 presigned url 返回給 app，app 再用 presigned url 抓圖片資料。也就是原來的程式碼裡一直都是 future builder &#43; image，這造成的問題就是頁面一刷新就要重新抓 presigned url，大大降低了效率，也大大提升了後端的負載。
因此決定客製化一個業務專用的 image provider。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/customize-flutter-image-provider/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-27T17:57:53+08:00" />
<meta property="article:modified_time" content="2022-05-27T17:57:53+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="客製化 Flutter Image Provider"/>
<meta name="twitter:description" content="之前在 flutter app 中使用 Optimized Cached Image 來展示圖片，選擇他的原因也很簡單，因為當時剛學 flutter 沒多久就要直接上陣了。先選一個看起來簡單好用的再說；而且他還可以設置 cache key，避免重複抓取，感覺起來就不錯。
然而後來圖片一多起來之後，就發現問題了，往往 app 打開滑沒幾下就 crash。看 log 是 OOM 問題，上網查了一下，有人說是 memory leak。大致上就是 image disposed 之後，沒有正確的釋放 ram，app 佔用的 ram 越來越多，就直接觸發 OOM killer。測試了一下原生的 NetworkImage 沒有這個問題。所以應該就是 Optimized Cached Image 的問題了。
另外就是在我的程式裡，widget 只拿到 media id，需要先到後端去查 media 的 presigned url 返回給 app，app 再用 presigned url 抓圖片資料。也就是原來的程式碼裡一直都是 future builder &#43; image，這造成的問題就是頁面一刷新就要重新抓 presigned url，大大降低了效率，也大大提升了後端的負載。
因此決定客製化一個業務專用的 image provider。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">客製化 Flutter Image Provider</h1>
			<div class="meta">Posted on May 27, 2022</div>
		</div>
		

		<section class="body">
			<p>之前在 flutter app 中使用 <a href="https://pub.dev/packages/optimized_cached_image">Optimized Cached Image</a> 來展示圖片，選擇他的原因也很簡單，因為當時剛學 flutter 沒多久就要直接上陣了。先選一個看起來簡單好用的再說；而且他還可以設置 cache key，避免重複抓取，感覺起來就不錯。</p>
<p>然而後來圖片一多起來之後，就發現問題了，往往 app 打開滑沒幾下就 crash。看 log 是 OOM 問題，上網查了一下，有人說是 memory leak。大致上就是 image disposed 之後，沒有正確的釋放 ram，app 佔用的 ram 越來越多，就直接觸發 OOM killer。測試了一下原生的 NetworkImage 沒有這個問題。所以應該就是 Optimized Cached Image 的問題了。</p>
<p>另外就是在我的程式裡，widget 只拿到 media id，需要先到後端去查 media 的 presigned url 返回給 app，app 再用 presigned url 抓圖片資料。也就是原來的程式碼裡一直都是 future builder + image，這造成的問題就是頁面一刷新就要重新抓 presigned url，大大降低了效率，也大大提升了後端的負載。</p>
<p>因此決定客製化一個業務專用的 image provider。</p>
<p>經一番 google 之後，找到了一篇寫得很淺顯易懂的文章: <a href="https://blog.csdn.net/WangQingLei0307/article/details/119932581">Flutter 网络图片的缓存和加载</a>。</p>
<p>按他的方法客製了一個自己的版本，目標：</p>
<ol>
<li>使用 <a href="https://pub.dev/packages/ffcache">ffcache</a> 做圖片快取存儲，如果 cache 中有圖片的資料，就直接讀取 cache；如果 cache 沒有，就從網路上下載。</li>
<li>將查詢業務 media 資料的程式邏輯放到 image provider 中自動查詢，一方面簡化輸入的參數，另一方面 widget 無需再用 future builder，減少 rebuild 過程中無意義的消耗。</li>
</ol>
<p>以下展示程式碼：</p>
<ul>
<li>
<p><code>drivers/cache.dart</code>:</p>
<p><code>MyCache</code> 做為 abstraction layer 存取 ffcache api。其他程式用 <code>getCache</code> 函數取得 cache 實例。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:ffcache/ffcache.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../logger.dart&#39;</span> <span style="color:#66d9ef">as</span> logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyCache</span> {
</span></span><span style="display:flex;"><span>  FFCache<span style="color:#f92672">?</span> _cache;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> isReady <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Future initialize() <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>    logger.debug(<span style="color:#e6db74">&#39;initializing cache&#39;</span>);
</span></span><span style="display:flex;"><span>    _cache <span style="color:#f92672">=</span> FFCache();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> _cache<span style="color:#f92672">?</span>.init();
</span></span><span style="display:flex;"><span>    isReady <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Future<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">bool</span><span style="color:#f92672">&gt;</span> hasKey(<span style="color:#66d9ef">String</span> key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> _cache<span style="color:#f92672">!</span>.has(key);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Future removeKey(<span style="color:#66d9ef">String</span> key) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> _cache<span style="color:#f92672">!</span>.remove(key);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// bytes data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Future getBytes(<span style="color:#66d9ef">String</span> key) <span style="color:#f92672">=&gt;</span> _cache<span style="color:#f92672">!</span>.getBytes(key);
</span></span><span style="display:flex;"><span>  Future putBytes(<span style="color:#66d9ef">String</span> key, List<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int</span><span style="color:#f92672">&gt;</span> bytes, Duration<span style="color:#f92672">?</span> timeout) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> timeout <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?</span> _cache<span style="color:#f92672">!</span>.setBytesWithTimeout(key, bytes, timeout)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">:</span> _cache<span style="color:#f92672">!</span>.setBytes(key, bytes);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// json data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  Future getJson(<span style="color:#66d9ef">String</span> key) <span style="color:#f92672">=&gt;</span> _cache<span style="color:#f92672">!</span>.getJSON(key);
</span></span><span style="display:flex;"><span>  Future putJson(<span style="color:#66d9ef">String</span> key, <span style="color:#66d9ef">dynamic</span> value, Duration<span style="color:#f92672">?</span> timeout) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> timeout <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?</span> _cache<span style="color:#f92672">!</span>.setJSONWithTimeout(key, value, timeout)
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">:</span> _cache<span style="color:#f92672">!</span>.setJSON(key, value);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">final</span> _instant <span style="color:#f92672">=</span> MyCache();
</span></span><span style="display:flex;"><span>Future initCache() <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>_instant.isReady) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> _instant.initialize();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MyCache getCache() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> _instant;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><code>image_provider.dart</code>:</p>
<ul>
<li>獲取圖片與 metadata 的程式邏輯放到 <code>_loadAsync</code> 函數裡，拿到圖片資料之後再 call <code>instantiateImageCodec</code> 繪圖。</li>
<li>存取 cache 中的資料需要 cache key, 我做法是用圖片的 MD5 值(由後端提供)，沒有就用 URL 的 MD5。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;dart:convert&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;dart:io&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;dart:typed_data&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;dart:ui&#39;</span> <span style="color:#66d9ef">as</span> ui <span style="color:#66d9ef">show</span> Codec;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:crypto/crypto.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:flutter/foundation.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:flutter/widgets.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;package:http/http.dart&#39;</span> <span style="color:#66d9ef">as</span> http;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../apis.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../constants.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../drivers/cache.dart&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../logger.dart&#39;</span> <span style="color:#66d9ef">as</span> logger;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;../models.dart&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> _utf8encoder <span style="color:#f92672">=</span> Utf8Encoder();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">String</span> md5sum(<span style="color:#66d9ef">String</span> key) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> content <span style="color:#f92672">=</span> _utf8encoder.convert(key);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> digest <span style="color:#f92672">=</span> md5.convert(content);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> digest.toString();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> _cache <span style="color:#f92672">=</span> getCache();
</span></span><span style="display:flex;"><span>Future<span style="color:#f92672">&lt;</span>Uint8List<span style="color:#f92672">&gt;</span> getBytes(<span style="color:#66d9ef">String</span> key) <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> exist <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _cache.hasKey(key);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (exist) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> bytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> _cache.getBytes(key);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Uint8List.fromList(bytes);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> Uint8List(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Future saveBytes(<span style="color:#66d9ef">String</span> key, Uint8List bytes, Duration timeout) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> _cache.putBytes(key, bytes, timeout);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyImageProvider</span> <span style="color:#66d9ef">extends</span> ImageProvider<span style="color:#f92672">&lt;</span>MyImageProvider<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> BuildContext context;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> MyMedia media;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">String</span><span style="color:#f92672">&gt;</span> headers;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">double</span> scale;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> Duration timeout;
</span></span><span style="display:flex;"><span>  MyImageProvider({
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.context,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.media,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.headers <span style="color:#f92672">=</span> <span style="color:#66d9ef">const</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span>.timeout <span style="color:#f92672">=</span> <span style="color:#66d9ef">const</span> Duration(hours: <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Future<span style="color:#f92672">&lt;</span>MyImageProvider<span style="color:#f92672">&gt;</span> obtainKey(ImageConfiguration configuration) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> SynchronousFuture<span style="color:#f92672">&lt;</span>MyImageProvider<span style="color:#f92672">&gt;</span>(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">get</span> hashCode <span style="color:#f92672">=&gt;</span> hashValues(media.mediaId, scale);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">operator</span> <span style="color:#f92672">==</span>(<span style="color:#66d9ef">dynamic</span> other) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (other.runtimeType <span style="color:#f92672">!=</span> runtimeType) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> MyImageProvider _type <span style="color:#f92672">=</span> other;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> media.mediaId <span style="color:#f92672">==</span> _type.media.mediaId <span style="color:#f92672">&amp;&amp;</span> scale <span style="color:#f92672">==</span> _type.scale;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Future<span style="color:#f92672">&lt;</span>ui.Codec<span style="color:#f92672">&gt;</span> _loadAsync(MyImageProvider key) <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">assert</span>(key <span style="color:#f92672">==</span> <span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 先看 cache 裡面有沒有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> cacheKey <span style="color:#f92672">=</span> media.checksum <span style="color:#f92672">??</span> md5sum(media.presigned);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> cachedBytes <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> getBytes(cacheKey);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (cachedBytes.isNotEmpty) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> PaintingBinding.instance
</span></span><span style="display:flex;"><span>          .instantiateImageCodec(cachedBytes)
</span></span><span style="display:flex;"><span>          .catchError(
</span></span><span style="display:flex;"><span>        (err) {
</span></span><span style="display:flex;"><span>          logger.error(<span style="color:#e6db74">&#39;unexpected image error (cache)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">$</span>err<span style="color:#e6db74">&#39;</span>);
</span></span><span style="display:flex;"><span>          _cache.removeKey(cacheKey);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">throw</span> err;
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>      );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 從線上抓圖片
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> api <span style="color:#f92672">=</span> MyAPI.of(context)<span style="color:#f92672">!</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> url <span style="color:#f92672">=</span> media.presigned <span style="color:#f92672">??</span> api.presignedMediaUrl(media.mediaId);
</span></span><span style="display:flex;"><span>    Uint8List<span style="color:#f92672">?</span> bytes;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (bytes<span style="color:#f92672">?</span>.isEmpty <span style="color:#f92672">??</span> <span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> resp <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> http.<span style="color:#66d9ef">get</span>(Uri.parse(url), headers: headers);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">switch</span> (resp.statusCode) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> HttpStatus.ok:
</span></span><span style="display:flex;"><span>          bytes <span style="color:#f92672">=</span> resp.bodyBytes;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (bytes.isEmpty) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> Exception(<span style="color:#e6db74">&#39;Invalid image, url: </span><span style="color:#e6db74">$</span>url<span style="color:#e6db74">&#39;</span>);
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          saveBytes(cacheKey, bytes, timeout);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> HttpStatus.forbidden:
</span></span><span style="display:flex;"><span>          url <span style="color:#f92672">=</span> api.presignedMediaUrl(media.mediaId);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">throw</span> Exception(
</span></span><span style="display:flex;"><span>              <span style="color:#e6db74">&#39;HTTP request failed, statusCode: </span><span style="color:#e6db74">${</span>resp.statusCode<span style="color:#e6db74">}</span><span style="color:#e6db74">, url: </span><span style="color:#e6db74">$</span>url<span style="color:#e6db74">&#39;</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 另一種寫法 (不知道有什麼區別)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// import &#39;dart:ui&#39; as ui show instantiateImageCodec;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// return ui.instantiateImageCodec(bytes);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> PaintingBinding.instance.instantiateImageCodec(bytes<span style="color:#f92672">!</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  ImageStreamCompleter load(MyImageProvider key, DecoderCallback decode) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> MultiFrameImageStreamCompleter(codec: _loadAsync(key), scale: scale);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
<p>這樣就可以用了。使用的方式：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span>Image(
</span></span><span style="display:flex;"><span>    image: MyImageProvider(media: data),
</span></span><span style="display:flex;"><span>    fit: BoxFit.cover,
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>或:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span>Container(
</span></span><span style="display:flex;"><span>    decoration: BoxDecoration(
</span></span><span style="display:flex;"><span>      image: DecorationImage(
</span></span><span style="display:flex;"><span>          image: MyImageProvider(media: data),
</span></span><span style="display:flex;"><span>          fit: BoxFit.cover,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/flutter">flutter</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
