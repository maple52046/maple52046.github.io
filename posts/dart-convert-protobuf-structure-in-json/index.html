<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Dart 轉換 json 中的 protobuf 結構 - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="最近開始將 flutter app 的後端由 restful api 逐步轉成 grpc，轉換的過程中為了同時兼容舊的 api，在原本的 json 結構中替換並嵌入了 protobuf 結構。結果在 json 序列化時 (flutter packages pub run build_runner build) 出現了類似以下錯誤：
[INFO] Generating build script completed, took 569ms
[INFO] Reading cached asset graph completed, took 77ms
[INFO] Checking for updates since last build completed, took 640ms
[SEVERE] json_serializable on lib/models/plustwo.dart:

Expecting a `fromJson` constructor with exactly one positional parameter. The only extra parameters allowed are functions of the form `T Function(Object?) fromJsonT` where `T` is a type parameter of the target type.
package:client/proto/calculator.pb.dart:40:28
   ╷
40 │   factory PlusTwoIntResult.fromJson($core.String i, [$pb.ExtensionRegistry r = $pb.ExtensionRegistry.EMPTY]) =&gt; create()..mergeFromJson(i, r);
   │                            ^^^^^^^^
   ╵
[INFO] Running build completed, took 5.1s
[INFO] Caching finalized dependency graph completed, took 48ms
[SEVERE] Failed after 5.2s
" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Dart 轉換 json 中的 protobuf 結構" />
<meta property="og:description" content="最近開始將 flutter app 的後端由 restful api 逐步轉成 grpc，轉換的過程中為了同時兼容舊的 api，在原本的 json 結構中替換並嵌入了 protobuf 結構。結果在 json 序列化時 (flutter packages pub run build_runner build) 出現了類似以下錯誤：
[INFO] Generating build script completed, took 569ms
[INFO] Reading cached asset graph completed, took 77ms
[INFO] Checking for updates since last build completed, took 640ms
[SEVERE] json_serializable on lib/models/plustwo.dart:

Expecting a `fromJson` constructor with exactly one positional parameter. The only extra parameters allowed are functions of the form `T Function(Object?) fromJsonT` where `T` is a type parameter of the target type.
package:client/proto/calculator.pb.dart:40:28
   ╷
40 │   factory PlusTwoIntResult.fromJson($core.String i, [$pb.ExtensionRegistry r = $pb.ExtensionRegistry.EMPTY]) =&gt; create()..mergeFromJson(i, r);
   │                            ^^^^^^^^
   ╵
[INFO] Running build completed, took 5.1s
[INFO] Caching finalized dependency graph completed, took 48ms
[SEVERE] Failed after 5.2s
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/dart-convert-protobuf-structure-in-json/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-10T23:22:51+08:00" />
<meta property="article:modified_time" content="2022-10-10T23:22:51+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="Dart 轉換 json 中的 protobuf 結構"/>
<meta name="twitter:description" content="最近開始將 flutter app 的後端由 restful api 逐步轉成 grpc，轉換的過程中為了同時兼容舊的 api，在原本的 json 結構中替換並嵌入了 protobuf 結構。結果在 json 序列化時 (flutter packages pub run build_runner build) 出現了類似以下錯誤：
[INFO] Generating build script completed, took 569ms
[INFO] Reading cached asset graph completed, took 77ms
[INFO] Checking for updates since last build completed, took 640ms
[SEVERE] json_serializable on lib/models/plustwo.dart:

Expecting a `fromJson` constructor with exactly one positional parameter. The only extra parameters allowed are functions of the form `T Function(Object?) fromJsonT` where `T` is a type parameter of the target type.
package:client/proto/calculator.pb.dart:40:28
   ╷
40 │   factory PlusTwoIntResult.fromJson($core.String i, [$pb.ExtensionRegistry r = $pb.ExtensionRegistry.EMPTY]) =&gt; create()..mergeFromJson(i, r);
   │                            ^^^^^^^^
   ╵
[INFO] Running build completed, took 5.1s
[INFO] Caching finalized dependency graph completed, took 48ms
[SEVERE] Failed after 5.2s
"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Dart 轉換 json 中的 protobuf 結構</h1>
			<div class="meta">Posted on Oct 10, 2022</div>
		</div>
		

		<section class="body">
			<p>最近開始將 flutter app 的後端由 restful api 逐步轉成 grpc，轉換的過程中為了同時兼容舊的 api，在原本的 json 結構中替換並嵌入了 protobuf 結構。結果在 json 序列化時 (<code>flutter packages pub run build_runner build</code>) 出現了類似以下錯誤：</p>
<pre tabindex="0"><code>[INFO] Generating build script completed, took 569ms
[INFO] Reading cached asset graph completed, took 77ms
[INFO] Checking for updates since last build completed, took 640ms
[SEVERE] json_serializable on lib/models/plustwo.dart:

Expecting a `fromJson` constructor with exactly one positional parameter. The only extra parameters allowed are functions of the form `T Function(Object?) fromJsonT` where `T` is a type parameter of the target type.
package:client/proto/calculator.pb.dart:40:28
   ╷
40 │   factory PlusTwoIntResult.fromJson($core.String i, [$pb.ExtensionRegistry r = $pb.ExtensionRegistry.EMPTY]) =&gt; create()..mergeFromJson(i, r);
   │                            ^^^^^^^^
   ╵
[INFO] Running build completed, took 5.1s
[INFO] Caching finalized dependency graph completed, took 48ms
[SEVERE] Failed after 5.2s
</code></pre><p>先來看一下上述的資料結構。首先是 json class:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>JsonSerializable(explicitToJson: <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PlusTowIntResponseV1</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> code;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> PlusTwoIntResult data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  PlusTowIntResponseV1({<span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.code, <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.data});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// json constructor and formatter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">factory</span> PlusTowIntResponseV1.fromJson(Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> json) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>      _$PlusTowIntResponseV1FromJson(json);
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> toJson() <span style="color:#f92672">=&gt;</span> _$PlusTowIntResponseV1ToJson(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中，<code>PlusTwoIntResult</code> 是 protobuf 結構，它定義如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#66d9ef">message</span> <span style="color:#a6e22e">PlusTwoIntResult</span> {<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">int64</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">int64</span> y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#66d9ef">int64</span> z <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>}<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>運行 <code>dart run build_runner build --delete-conflicting-outputs</code> 時產生了本篇開頭的錯誤。</p>
<p>在 google 一番之後，找到了幾種解法。</p>
<h2 id="在-jsonkey-中指定轉換-function">在 JsonKey 中指定轉換 function</h2>
<p>這個方式參考自 github 上的 <a href="https://github.com/google/json_serializable.dart/issues/1017#issuecomment-1000388668">Using protobuf with this package</a> 這篇</p>
<p>做法是指定 <code>fromJson</code> 與 <code>toJson</code> 的轉換函數，例如:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span>PlusTwoIntResult protobufFromJson(<span style="color:#66d9ef">String</span> json) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> PlusTwoIntResult.fromJson(json);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">String</span> protobufToJson(PlusTwoIntResult PlusTwoIntResult) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> PlusTwoIntResult.create().writeToJson();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>JsonSerializable(explicitToJson: <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PlusTowIntResponseV1</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> code;
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>JsonKey(fromJson: protobufFromJson, toJson: protobufToJson)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> PlusTwoIntResult data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> PlusTowIntResponseV1({<span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.code, <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.data});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// json constructor and formatter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">factory</span> PlusTowIntResponseV1.fromJson(Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> json) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>      _$PlusTowIntResponseV1FromJson(json);
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> toJson() <span style="color:#f92672">=&gt;</span> _$PlusTowIntResponseV1ToJson(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這個方法對單純 key/value 結構可行。但是如果 protobuf 結構是在陣列裡就不行 (應該說就不能共用同一組 function)。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>JsonSerializable(explicitToJson: <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PlusTowIntResponseV2</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> code;
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>JsonKey(fromJson: protobufFromJson, toJson: protobufToJson)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>PlusTwoIntResult<span style="color:#f92672">&gt;</span> data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> PlusTowIntResponseV2({<span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.code, <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.data});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// json constructor and formatter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">factory</span> PlusTowIntResponseV2.fromJson(Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> json) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>      _$PlusTowIntResponseV2FromJson(json);
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> toJson() <span style="color:#f92672">=&gt;</span> _$PlusTowIntResponseV2ToJson(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>PlusTowIntResponseV2</code> 是第二個 json class, 其中 data 欄位對應是 list 結構。如果重複使用同一組 convert function，就會出現以下錯誤：</p>
<pre tabindex="0"><code>[INFO] Generating build script completed, took 572ms
[INFO] Reading cached asset graph completed, took 77ms
[INFO] Checking for updates since last build completed, took 652ms
[SEVERE] json_serializable on lib/models/plustwo.dart:

Error with `@JsonKey` on the `data` field. The `toJson` function `protobufToJson` argument type `PlusTwoIntResult` is not compatible with field type `List&lt;PlusTwoIntResult&gt;`.
package:client/models/plustwo.dart:44:32
   ╷
44 │   final List&lt;PlusTwoIntResult&gt; data;
   │                                ^^^^
   ╵
[INFO] Running build completed, took 5.2s
[INFO] Caching finalized dependency graph completed, took 45ms
[SEVERE] Failed after 5.2s
</code></pre><p>也就是說，如果要用這種方法，必須要對不同的結構再增加不同的轉換函數。這樣太麻煩了，於是又找了第二種方式。</p>
<h2 id="自定義-jsonconverter">自定義 JsonConverter</h2>
<p><code>json_annotation</code> 套件中提供了 <code>JsonConverter&lt;T, S&gt;</code> 類型，這個類型定義了兩個子函數：<code>fromJson</code> 與 <code>toJson</code> 用來轉換數據。將方法一的 <code>protobufFromJson</code> 與 <code>protobufToJson</code> 結合 <code>JsonConverter</code> 定義了新的轉換器類型：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResultConverter</span> <span style="color:#66d9ef">extends</span> JsonConverter<span style="color:#f92672">&lt;</span>PlusTwoIntResult, <span style="color:#66d9ef">String</span><span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> ResultConverter();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  PlusTwoIntResult fromJson(<span style="color:#66d9ef">String</span> json) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> PlusTwoIntResult.fromJson(json);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">String</span> toJson(PlusTwoIntResult object) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> object.writeToJson();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然後在原本的 class 中以 annotation 的方式使用這個轉換器：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>JsonSerializable(explicitToJson: <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>ResultConverter()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PlusTowIntResponseV1</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> code;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> PlusTwoIntResult data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> PlusTowIntResponseV1({<span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.code, <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.data});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// json constructor and formatter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">factory</span> PlusTowIntResponseV1.fromJson(Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> json) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>      _$PlusTowIntResponseV1FromJson(json);
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> toJson() <span style="color:#f92672">=&gt;</span> _$PlusTowIntResponseV1ToJson(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>JsonSerializable(explicitToJson: <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>ResultConverter()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PlusTowIntResponseV2</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> code;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">final</span> List<span style="color:#f92672">&lt;</span>PlusTwoIntResult<span style="color:#f92672">&gt;</span> data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> PlusTowIntResponseV2({<span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.code, <span style="color:#66d9ef">required</span> <span style="color:#66d9ef">this</span>.data});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// json constructor and formatter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">factory</span> PlusTowIntResponseV2.fromJson(Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> json) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>      _$PlusTowIntResponseV2FromJson(json);
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> toJson() <span style="color:#f92672">=&gt;</span> _$PlusTowIntResponseV2ToJson(<span style="color:#66d9ef">this</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這個方式 builder 就可以正成運作。</p>
<p>接下來我們來解析 api 返回的 data：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> v1plus(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y) <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> url <span style="color:#f92672">=</span> Uri.http(apihost, <span style="color:#e6db74">&#39;/v1/plus&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> req <span style="color:#f92672">=</span> jsonEncode(PlusTwoIntRequest(x: x, y: y));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> r <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> http.post(url, body: req);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> body <span style="color:#f92672">=</span> utf8.decode(r.bodyBytes);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> resp <span style="color:#f92672">=</span> PlusTowIntResponseV1.fromJson(json.decode(body));
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">${</span>resp.data.x<span style="color:#e6db74">}</span><span style="color:#e6db74"> + </span><span style="color:#e6db74">${</span>resp.data.y<span style="color:#e6db74">}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">${</span>resp.data.z<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>利用上面的函數，呼叫後端 api，取得返回結果後再將 json string 解析成資料結構。看似很理想，但是運行時出現了以下的錯誤：</p>
<pre tabindex="0"><code>Unhandled exception:
type &#39;_InternalLinkedHashMap&lt;String, dynamic&gt;&#39; is not a subtype of type &#39;String&#39; in type cast
#0      _$PlusTowIntResponseV1FromJson (package:client/models/plustwo.g.dart:25:59)
#1      new PlusTowIntResponseV1.fromJson (package:client/models/plustwo.dart:29:7)
#2      v1plus (package:client/client.dart:14:35)
&lt;asynchronous suspension&gt;
</code></pre><p>這個錯誤是因為前面將 <code>ResultConverter</code> 定義成 <code>PlusTwoIntResult</code> 與 <code>String</code> 之間做轉換。但實際上 <code>PlusTwoIntResult</code> 是被解析成 <code>_InternalLinkedHashMap&lt;String, dynamic&gt;</code>。</p>
<p>於是將 <code>ResultConverter</code> 改成：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResultConverter</span> <span style="color:#66d9ef">extends</span> JsonConverter<span style="color:#f92672">&lt;</span>PlusTwoIntResult, Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> ResultConverter();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  PlusTwoIntResult fromJson(Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> json) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> PlusTwoIntResult.create()..mergeFromProto3Json(json);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Map<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span>, <span style="color:#66d9ef">dynamic</span><span style="color:#f92672">&gt;</span> toJson(PlusTwoIntResult object) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> object.writeToJsonMap();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>_InternalLinkedHashMap&lt;String, dynamic&gt;</code> 是 builder 產生出來的東西，可以用 <code>Map&lt;String, dynamic&gt;</code> 替代。這樣，這就可以輕鬆將帶有 protobuf 結構的資料轉換成 json。</p>
<p>最後附上 demo project: <a href="https://github.com/maple52046/pbconverter">https://github.com/maple52046/pbconverter</a>。這個 project 提供了 restful api server (golang) 與 client (dart).</p>
<hr>
<h2 id="troubleshoot">Troubleshoot</h2>
<p>在 <code>ResultConverter</code> 的 <code>fromJson</code> 中，我們是用 <code>mergeFromProto3Json</code> 將 map 轉換成資料結構。如果這裡改用 <code>mergeFromJsonMap</code> 就會出現以下錯誤：</p>
<pre tabindex="0"><code>Unhandled exception:
FormatException: Invalid radix-10 number (at character 1)
x
^

#0      int._handleFormatError (dart:core-patch/integers_patch.dart:131:5)
#1      int._parseRadix (dart:core-patch/integers_patch.dart:142:16)
#2      int._parse (dart:core-patch/integers_patch.dart:103:12)
#3      int.parse (dart:core-patch/integers_patch.dart:65:12)
#4      _mergeFromJsonMap (package:protobuf/src/protobuf/json.dart:100:55)
#5      GeneratedMessage.mergeFromJsonMap (package:protobuf/src/protobuf/generated_message.dart:285:5)
#6      ResultConverter.fromJson (package:client/utils/converter.dart:10:39)
#7      _$PlusTowIntResponseV1FromJson (package:client/models/plustwo.g.dart:26:12)
#8      new PlusTowIntResponseV1.fromJson (package:client/models/plustwo.dart:29:7)
#9      v1plus (package:client/client.dart:14:35)
&lt;asynchronous suspension&gt;
</code></pre><p>這個錯誤，我猜測是因為 protobuf 的 json 以字串的方式包裝 int，也就是 dart 從後端拿到的 json 格式是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#e6db74">&#34;2&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;z&#34;</span>: <span style="color:#e6db74">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>但 <code>PlusTwoIntResult</code> 的 json 格式理論上應該是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;x&#34;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;y&#34;</span>: <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;z&#34;</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>所以 dart 在轉換時才會去 call <code>int.parse</code>。這是我個人的猜測。解決方法其實 protobuf 已經幫我們做好了，就是改用 <code>mergeFromProto3Json</code> 即可。</p>
<h2 id="參考資料">參考資料</h2>
<ul>
<li><a href="https://github.com/google/json_serializable.dart/issues/1017#issuecomment-1000388668">Using protobuf with this package</a></li>
<li><a href="https://stackoverflow.com/questions/57845333/dart-how-internallinkedhashmapstring-dynamic-convert-to-mapstring-dynami">Dart - how _InternalLinkedHashMap&lt;String, dynamic&gt; convert to Map&lt;String, dynamic&gt;?</a></li>
<li><a href="https://github.com/google/protobuf.dart/issues/220">Proto3 JSON support</a></li>
<li><a href="https://pub.dev/documentation/json_annotation/latest/json_annotation/JsonConverter-class.html">JsonConverter&lt;T, S&gt; class</a></li>
</ul>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/dart">dart</a></li>
					
					<li><a href="/tags/flutter">flutter</a></li>
					
					<li><a href="/tags/protobuf">protobuf</a></li>
					
					<li><a href="/tags/grpc">grpc</a></li>
					
					<li><a href="/tags/restful">restful</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
