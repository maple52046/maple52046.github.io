<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Setup Squid Transparent Proxy with Docker - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量
還可以控管區網內是否要開放/封鎖網站~~(監看區網內誰在玩FB或是看色情網站XD)~~" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Setup Squid Transparent Proxy with Docker" />
<meta property="og:description" content="Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量
還可以控管區網內是否要開放/封鎖網站~~(監看區網內誰在玩FB或是看色情網站XD)~~" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/setup-squid-transparent-proxy-with-docker/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-11-19T17:09:00+00:00" />
<meta property="article:modified_time" content="2015-11-19T17:09:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="Setup Squid Transparent Proxy with Docker"/>
<meta name="twitter:description" content="Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量
還可以控管區網內是否要開放/封鎖網站~~(監看區網內誰在玩FB或是看色情網站XD)~~"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Setup Squid Transparent Proxy with Docker</h1>
			<div class="meta">Posted on Nov 19, 2015</div>
		</div>
		

		<section class="body">
			<p>Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量
還可以控管區網內是否要開放/封鎖網站~~(監看區網內誰在玩FB或是看色情網站XD)~~</p>
<p>通常 Transparent proxy 都會放在區網對外的那台 server 上，例如下圖：</p>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/314634/N4mq1E37S767W0ZY5S3U_%E6%9C%AA%E5%91%BD%E5%90%8D.001.jpeg" alt="&ldquo;Squid Transparent Proxy&rdquo;"></p>
<p>對於 Proxy , Transparent proxy 沒有概念的人，可以先看<a href="http://linux.vbird.org/linux_server/0420squid.php">鳥哥的文章</a>，這邊就很不負責的說不再贅述了((懶~</p>
<h1 id="實驗環境">實驗環境</h1>
<table>
<thead>
<tr>
<th style="text-align:center">Item</th>
<th style="text-align:center">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">OS</td>
<td style="text-align:center">Gentoo</td>
</tr>
<tr>
<td style="text-align:center">Docker version</td>
<td style="text-align:center">1.7.9</td>
</tr>
<tr>
<td style="text-align:center">Docker image</td>
<td style="text-align:center"><a href="https://github.com/sameersbn/docker-squid">sameersbn/squid:3.3.8-4</a></td>
</tr>
</tbody>
</table>
<p>只要能跑 Docker, 實體機的 OS 是什麼都不重要 :D</p>
<hr>
<h1 id="安裝步驟">安裝步驟</h1>
<h2 id="1-安裝-docker">1. 安裝 Docker</h2>
<p>在 Gentoo 上安裝 Docker 會比較麻煩一些，要注意 kernel 有些功能要打開，其他就按照 <a href="http://docs.docker.com/engine/installation/gentoolinux/">Docker 官方教學(For Gentoo)</a>即可。
至於其他 OS，就只好很不負責任的說，請參考 <a href="http://docs.docker.com/engine/installation/">Docker 官方教學</a>安裝吧</p>
<h2 id="2-設定-memory-disk-option">2. 設定 Memory Disk (Option.)</h2>
<p>既然 Squid 是一個 Proxy server，那通常就會有一個存放 cache 的地方。一般來說，如果 server 的 memory 夠大，將 cache 放到 memory 中是一個好選擇，可以讓效能快很多。</p>
<pre tabindex="0"><code>$ sudo mkdir /var/spool/squid3
$ echo &#34;tmpfs /var/spool/squid3/ tmpfs defaults,size=256m,mode=1777 0 0&#34; | sudo tee -a /etc/fstab
$ sudo mount /var/spool/squid3
</code></pre><p>ps: <strong><code>tee</code> 這個指令千萬別忘了加上 <code>-a</code>，免得 <code>/etc/fstab</code> 的內容會被覆蓋。</strong></p>
<blockquote>
<p>手動掛載 <code>sudo mount -t tmpfs -o size=256M,mode=1777 tmpfs /var/spool/squid3</code></p>
</blockquote>
<h2 id="3-運行-container">3. 運行 Container</h2>
<p>裝好 Docker 之後，接下來我們要運行 container。在網路上已經有安裝好的 docker image，可以直接從 docker.io 上下載。在這裡我選的是 <a href="https://github.com/sameersbn/docker-squid">sameersbn/squid:3.3.8-4</a> 。</p>
<p>執行 <code>docker run</code> 指令，下載 docker image 並運行 Squid container：</p>
<pre tabindex="0"><code>$ sudo docker run -d --name squid3 --net host -v /var/log/squid3:/var/log/squid3 -v /var/spool/squid3:/var/spool/squid3 sameersbn/squid:3.3.8-4
</code></pre><ul>
<li><code>-d</code> 是指 daemon mode, 也就是背景運作。</li>
<li><code>--name</code> 就是這個 container 的名稱。這個參數可以自由選擇要不要加，不加的話，docker 會直接以那一長串的 UUID 為名稱；<strong>為了操作方便，建議指定 container 的名稱</strong></li>
<li><code>-net</code> 是 container 的網路模式。一般如果不加這個參數，預設是 bridge。如果不是 <code>host</code> mode 時，必須要加上 <code>-p 3128:3128</code> 或是自行設定 iptables nat rule 才能讓其他電腦連到 container。</li>
<li><code>-v</code> 是將實體機上的某個路徑，掛載到 container 的某個路徑。
<ul>
<li><code>/var/log/squid3</code> 是 Squid 預設的 log 檔目錄。如果想要方便一點查看 log，建議可以掛載這個目錄。</li>
<li><code>/var/spool/squid3</code> 是 Squid 預設的 cache 目錄。如果想要用 memory disk 來提高效能，記得做完第二步驟，並設定這個參數。</li>
</ul>
</li>
<li><code>sameersbn/squid:3.3.8-4</code> 就是 docker image 名稱。</li>
</ul>
<p>利用 <code>docker ps</code> 來檢查 container 是否有在運作：</p>
<pre tabindex="0"><code>sudo docker ps
CONTAINER ID        IMAGE                     COMMAND                CREATED             STATUS              PORTS               NAMES
2d8d9f19b25d        sameersbn/squid:3.3.8-4   &#34;/sbin/entrypoint.sh   2 hours ago         Up About an hour                        squid3
</code></pre><p>如果想要看 log，有兩種方式：</p>
<ol>
<li>如果 <code>docker run</code> 的參數有加上 <code>-v &lt;&lt;some path in host server&gt;&gt;:/var/log/squid3</code> 就可以在實體機上看到 log 檔。 在我的範例中是 <code>/var/log/squid3/cache.log</code></li>
<li>如果沒有掛載 log 路徑，你也可以執行 <code>docker logs &lt;&lt;container name&gt;&gt;</code> 查看 log。</li>
</ol>
<h2 id="4-設定-squid">4. 設定 Squid</h2>
<p>Squid 的設定檔是 <code>squid.conf</code>，存放在 container 裡面。想要修改可以直接進入 container 裡面，或是執行 <code>sudo docker exec -it &lt;&lt;contianer name&gt;&gt; vi /etc/squid3/squid.conf</code></p>
<p>如果你的 <a href="http://stackoverflow.com/questions/22907231/copying-files-from-host-to-docker-container">Docker 是 1.8 以上的版本</a>，可以用 <code>docker cp</code> 將檔案下載到實體機上，編輯完後再傳回去。但可惜我不是。</p>
<p>為了圖方便，我將 <code>/etc/squid3</code> 整個資料夾下載到實體機，然後刪除舊的 container，重新建立新的 container 並加上掛載設定檔目錄的參數</p>
<pre tabindex="0"><code>$ sudo docker cp squid3:/etc/squid3 /etc/
$ sudo docker rm -f squid3
$ sudo docker run -d --name squid3 --net host -v /etc/squid3:/etc/squid3 -v /var/log/squid3:/var/log/squid3 -v /var/spool/squid3:/var/spool/squid3 sameersbn/squid:3.3.8-4
</code></pre><h3 id="編輯-squidconf">編輯 squid.conf</h3>
<p>接下來就要編輯 squid.conf，以下先提供我的設定檔：</p>
<pre tabindex="0"><code>acl localnet src 10.0.0.0/8	    # RFC1918 possible internal network
acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines
acl SSL_ports port 443
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access deny to_localhost
http_access allow localnet
http_access allow localhost
http_access deny all
http_port 3128 transparent
https_port 3129 transparent cert=/etc/squid3/squid-proxy.crt key=/etc/squid3/squid-proxy.key ssl-bump
ssl_bump none all
</code></pre><ul>
<li><code>acl localnet src 192.168.0.0/16</code>
<ul>
<li><code>localnet</code> 是一個自訂的名稱</li>
<li><code>src</code> 是指 request 的來源</li>
<li><code>192.168.0.0/16</code> 也就是我們後端的 LAN。</li>
</ul>
</li>
<li><code>http_port 3128 transparent</code>
<ul>
<li><code>http_port</code> 就是設定 squid 負責 listen HTTP request 的 port。預設是 <code>3128</code>。</li>
<li><code>transparent</code> 就是運作模式，因為我們要建置 transparent proxy，所以必須要加上這個參數。</li>
</ul>
</li>
<li><code>https_port 3129 transparent cert=/etc/squid3/ssl/squid-proxy.crt key=/etc/squid3/ssl/squid-proxy.key ssl-bump</code>
<ul>
<li><code>https_port</code> 顧名思義就是接受 https request 的 port。不能設定跟 <code>http_port</code> 一樣</li>
<li><code>cert</code> 跟 <code>key</code> 必須要設定一對 self signed certificate 的路徑。</li>
<li><code>ssl-bump</code> 設定 HTTPs 的加解密訊息要怎麼處理。這邊建議搭配 <code>ssl_bump none all</code> 這個設定，讓 client 直接讀取 Web server 的 certificate。</li>
</ul>
</li>
</ul>
<p>其他的參數可以不用動</p>
<h3 id="產生-self-signed-certificate">產生 self signed certificate</h3>
<p>首先必需先安裝 OpenSSL。在 Gentoo 上應該是 <code>dev-libs/openssl</code>;而 Ubuntu 上則只需要 <code>apt-get install openssl</code> 即可。</p>
<blockquote>
<p>產生出來的 certificate 必須要 Squid 能讀取到。因此，如果你有安裝我之前的步驟，將實體機上的某個資料夾掛載到 container，例如： <code>/etc/squid3</code> 之類，你就可以利用這些資料夾來傳檔案；
若否，則建議直接在 container 中執行這個步驟。（例如可以 <code>docker exec -it squid3 openssl ......</code> 但是這樣路徑必須要是絕對路徑，例如 <code>/etc/squid3/squid-server.key</code>)</p>
</blockquote>
<p>安裝好之後，接下來安裝以下指令步驟：</p>
<pre tabindex="0"><code>$ openssl genrsa -des3 -out squid-server.key 1024
Generating RSA private key, 1024 bit long modulus
............................++++++
...........................................................++++++
e is 65537 (0x10001)
Enter pass phrase for squid-server.key:
Verifying - Enter pass phrase for squid-server.key:
</code></pre><p><code>pass phrase</code> 必須要打一串密碼進去，不可以留空</p>
<pre tabindex="0"><code>$ openssl req -new -key squid-server.key -out squid-server.csr
Enter pass phrase for squid-server.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) [AU]:TW
State or Province Name (full name) [Some-State]:Taiwan
Locality Name (eg, city) []:Hsichu
Organization Name (eg, company) [Internet Widgits Pty Ltd]:NTHU
Organizational Unit Name (eg, section) []:SSLab
Common Name (e.g. server FQDN or YOUR name) []:maple52046.twbbs.org.tw
Email Address []:maple52046@gmail.com

Please enter the following &#39;extra&#39; attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre><p>後面 <code>extra</code> 這邊全部直接按 enter 跳過。</p>
<p>然後接下來還有兩個指令：</p>
<pre tabindex="0"><code>$ openssl rsa -in squid-server.key -out squid-proxy.key
Enter pass phrase for squid-server.key:
writing RSA key

$ openssl x509 -req -days 365 -in squid-server.csr -signkey squid-proxy.key -out squid-proxy.crt
Signature ok
subject=/C=TW/ST=Taiwan/L=Hsichu/O=NTHU/OU=SSLab/CN=maple52046.twbbs.org.tw/emailAddress=maple52046@gmail.com
Getting Private key
</code></pre><p>完成之後，在當前目錄下，會產生4個檔案：</p>
<pre tabindex="0"><code>$ ls
squid-proxy.crt  squid-proxy.key  squid-server.csr  squid-server.key
</code></pre><p>將 <code>squid-proxy.crt</code> 與 <code>squid-proxy.key</code> 放到 container 可以讀取到的地方，例如：<code>/etc/squid3</code> &hellip;</p>
<h2 id="5-restart-squid">5. Restart Squid</h2>
<p>重新啟動 Squid server 以便套用新設定</p>
<pre tabindex="0"><code>$ sudo docker restart squid3
</code></pre><p>檢查一下 port 是否有在監聽：</p>
<pre tabindex="0"><code>sudo netstat -tlnp | egrep &#39;3128|3129&#39;
</code></pre><h2 id="6-設定-iptables">6. 設定 Iptables</h2>
<p>因為是 transparent proxy，所以還必須要加上 iptables nat rule，將 HTTP/HTTPs request 導入到 Squid 中：</p>
<pre tabindex="0"><code>$ sudo iptables -t nat -A PREROUTING ! -d 10.0.0.1 -p tcp --dport 80 -j REDIRECT --to 3128
$ sudo iptables -t nat -A PREROUTING ! -d 10.0.0.1 -p tcp --dport 443 -j REDIRECT --to 3129
</code></pre><p>這邊 <code>10.0.0.1</code> 是實體 server 的對外 IP。如果你的 NAT server 沒有提供 web service，那就可以去掉這個條件，直接變成 <code>iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to 3128</code></p>
<p>或者你的 NAT server 是有區分內外網的 interface，例如假設 eth0 是連接外網、eth1 是連接內網，那就可以改成：<code>iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j REDIRECT --to 3128</code></p>
<h2 id="7-用-upstartsystemd-來管理-squid-container-options">7. 用 upstart/systemd 來管理 Squid container (Options.)</h2>
<p>如果將來 NAT server 重開機，那麼就得要自己重新啟動 container。
因此可以利用 Linux 上的 upstart(或是 systemd)來啟動 container 會方便很多。</p>
<p>以下用 upstart 為例( systemd 可以參考 <a href="https://docs.docker.com/v1.8/articles/host_integration/">Docker 官方教學</a>)：</p>
<ol>
<li>建立 <code>/etc/init/squid3.conf</code>，並新增以下內容：</li>
</ol>
<pre tabindex="0"><code>description &#34;Squid Proxy Server&#34;
author &#34;Maple52046&#34;
start on filesystem and started docker
stop on runlevel [!2345]
respawn
script
	/usr/bin/docker start -a squid3
end script
</code></pre><ol start="2">
<li>產生 <code>/etc/init.d/squid3</code></li>
</ol>
<pre tabindex="0"><code>sudo ln -s /lib/init/upstart-job /etc/init.d/squid3
</code></pre><ol start="3">
<li>關閉原本的 container ，並啟動服務</li>
</ol>
<pre tabindex="0"><code>sudo docker stop squid3
sudo service squid3 start
</code></pre><p>檢查一下 container 是否已經啟動</p>
<pre tabindex="0"><code>sudo service squid3 status
sudo docker ps | grep squid3
</code></pre><hr>
<p>架設完 Squid proxy server 之後， 就可以分析 Squid 的 Log (<code>/var/log/squid3/access.log</code>)</p>
<pre tabindex="0"><code>1447999536.213 120894 192.168.0.3 TCP_MISS/200 7655 CONNECT 74.125.203.138:443 - HIER_DIRECT/74.125.203.138 -
1447999536.213 121078 192.168.0.3 TCP_MISS/200 4957 CONNECT 64.233.188.139:443 - HIER_DIRECT/64.233.188.139 -
1447999554.963 240143 192.168.0.3 TCP_MISS/200 5176 CONNECT 64.233.189.95:443 - HIER_DIRECT/64.233.189.95 -
1447999555.327 240351 192.168.0.3 TCP_MISS/200 5961 CONNECT 64.233.189.95:443 - HIER_DIRECT/64.233.189.95 -
1447999566.344   3061 192.168.0.3 TCP_MISS_ABORTED/000 0 GET http://secclientgw.alipay.com/product/3001/2.4.0.0/version.xml? - HIER_DIRECT/110.76.20.11 -
1447999567.267 112594 192.168.0.3 TCP_MISS/200 55546 CONNECT 23.48.140.135:443 - HIER_DIRECT/23.48.140.135 -
1447999574.672 240106 192.168.0.3 TCP_MISS/200 4895 CONNECT 74.125.204.139:443 - HIER_DIRECT/74.125.204.139 -
1447999574.975 120170 192.168.0.3 TCP_MISS/200 744 CONNECT 54.230.212.62:443 - HIER_DIRECT/54.230.212.62 -
1447999578.090 240080 192.168.0.3 TCP_MISS/200 1310 CONNECT 74.125.203.139:443 - HIER_DIRECT/74.125.203.139 -
1447999631.985  65873 192.168.0.3 TCP_MISS/200 7278 CONNECT 31.13.87.1:443 - HIER_DIRECT/31.13.87.1 -
</code></pre><h1 id="reference">Reference</h1>
<ol>
<li><a href="http://linux.vbird.org/linux_server/0420squid.php">第十七章、區網控制者： Proxy 伺服器</a> - 鳥哥的 Linux 私房菜</li>
<li><a href="https://github.com/sameersbn/docker-squid">sameersbn/squid:3.3.8-4</a></li>
<li><a href="http://docs.docker.com/engine/installation/gentoolinux/">Installing Docker on Gentoo Linux</a></li>
<li><a href="http://serverfault.com/questions/610232/how-to-setup-client-for-squid-transparent-proxy">How to setup client for squid transparent proxy?</a></li>
<li><a href="http://busylog.net/squid-ssl-certificate/">Squid – SSL Certificate</a></li>
<li><a href="http://blog.longwin.com.tw/2006/01/ram_disk_build_method/">拿 RAM 當硬碟來用(RAM Disk)</a></li>
<li><a href="http://www.ehow.com/how_7498953_enable-ssl-squid.html">How to Enable SSL Squid</a></li>
<li><a href="http://stackoverflow.com/questions/22907231/copying-files-from-host-to-docker-container">Copying files from host to docker container</a></li>
<li><a href="http://stackoverflow.com/questions/10175812/how-to-create-a-self-signed-certificate-with-openssl">How to create a self-signed certificate with openssl?</a></li>
<li><a href="https://docs.docker.com/v1.8/articles/host_integration/">Automatically start containers</a></li>
</ol>
<h1 id="圖片來源">圖片來源</h1>
<ol>
<li><a href="http://www.peppercan.com/wp-content/uploads/2012/03/cloud.png">http://www.peppercan.com/wp-content/uploads/2012/03/cloud.png</a></li>
<li><a href="http://orig05.deviantart.net/4a1c/f/2010/239/0/b/pc">http://orig05.deviantart.net/4a1c/f/2010/239/0/b/pc</a>_clipart_by_chiprunner-d2xfpv6.png</li>
</ol>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/docker">docker</a></li>
					
					<li><a href="/tags/squid">squid</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
