<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Flutter ReorderableListView - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="使用 ReorderableList 解決 Bloc 在 ListView 中頻繁的關閉與創建問題
最近在開發 Flutter app 時遇到了一個問題：當 ListView 中，每個 child 都使用 BlocProvider ，例如:
class MyListView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder&lt;MyCubit, MyState&gt;(
      builder: (_, state) {
        return ListView.builder(
          itemCount: state.length,
          itemBuilder: (context, index) {
            return BlocProvider(
              create: (_) =&gt; MyCubit(),
              child: ListTile(
                key: ValueKey(state[index]),
                title: Text(state[index].title),
              ),
            );
          },
        );
      },
    );
  }
}
如果列表的順序變更，child bloc 會將頻繁地被關閉與重新創建。此時會導致所有的 child 發生 emit error：
[ERROR: flutter/runtime/dart_vm_initializer.cc(41)] Unhandled Exception: Bad state: Cannot emit new states after calling close
#0  BlocBase.emit (package:bloc/src/bloc_base.dart:97:9)
#1  MyCubit.fetchData.&lt;anonymous closure&gt; (package: myapp/features/hello/presentation/blocs/cubit.dart:203:13)
#2  GreetingRepository.fetchData(package:myapp/features/hello/infrastructure/repositories.dart:167:20)
‹asynchronous suspension&gt;
#3  GreetingRepository.fetch.&lt;anonymous closure (package:myapp/features/hello/infrastructure/repositories.dart:60:9)
&lt;asynchronous suspension&gt;
即便在每個 child 上增加了唯一的 key，也無法避免這個問題。" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Flutter ReorderableListView" />
<meta property="og:description" content="使用 ReorderableList 解決 Bloc 在 ListView 中頻繁的關閉與創建問題
最近在開發 Flutter app 時遇到了一個問題：當 ListView 中，每個 child 都使用 BlocProvider ，例如:
class MyListView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder&lt;MyCubit, MyState&gt;(
      builder: (_, state) {
        return ListView.builder(
          itemCount: state.length,
          itemBuilder: (context, index) {
            return BlocProvider(
              create: (_) =&gt; MyCubit(),
              child: ListTile(
                key: ValueKey(state[index]),
                title: Text(state[index].title),
              ),
            );
          },
        );
      },
    );
  }
}
如果列表的順序變更，child bloc 會將頻繁地被關閉與重新創建。此時會導致所有的 child 發生 emit error：
[ERROR: flutter/runtime/dart_vm_initializer.cc(41)] Unhandled Exception: Bad state: Cannot emit new states after calling close
#0  BlocBase.emit (package:bloc/src/bloc_base.dart:97:9)
#1  MyCubit.fetchData.&lt;anonymous closure&gt; (package: myapp/features/hello/presentation/blocs/cubit.dart:203:13)
#2  GreetingRepository.fetchData(package:myapp/features/hello/infrastructure/repositories.dart:167:20)
‹asynchronous suspension&gt;
#3  GreetingRepository.fetch.&lt;anonymous closure (package:myapp/features/hello/infrastructure/repositories.dart:60:9)
&lt;asynchronous suspension&gt;
即便在每個 child 上增加了唯一的 key，也無法避免這個問題。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/flutter-reorderablelistview/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-09-21T02:08:09+08:00" />
<meta property="article:modified_time" content="2024-09-21T02:08:09+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="Flutter ReorderableListView"/>
<meta name="twitter:description" content="使用 ReorderableList 解決 Bloc 在 ListView 中頻繁的關閉與創建問題
最近在開發 Flutter app 時遇到了一個問題：當 ListView 中，每個 child 都使用 BlocProvider ，例如:
class MyListView extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return BlocBuilder&lt;MyCubit, MyState&gt;(
      builder: (_, state) {
        return ListView.builder(
          itemCount: state.length,
          itemBuilder: (context, index) {
            return BlocProvider(
              create: (_) =&gt; MyCubit(),
              child: ListTile(
                key: ValueKey(state[index]),
                title: Text(state[index].title),
              ),
            );
          },
        );
      },
    );
  }
}
如果列表的順序變更，child bloc 會將頻繁地被關閉與重新創建。此時會導致所有的 child 發生 emit error：
[ERROR: flutter/runtime/dart_vm_initializer.cc(41)] Unhandled Exception: Bad state: Cannot emit new states after calling close
#0  BlocBase.emit (package:bloc/src/bloc_base.dart:97:9)
#1  MyCubit.fetchData.&lt;anonymous closure&gt; (package: myapp/features/hello/presentation/blocs/cubit.dart:203:13)
#2  GreetingRepository.fetchData(package:myapp/features/hello/infrastructure/repositories.dart:167:20)
‹asynchronous suspension&gt;
#3  GreetingRepository.fetch.&lt;anonymous closure (package:myapp/features/hello/infrastructure/repositories.dart:60:9)
&lt;asynchronous suspension&gt;
即便在每個 child 上增加了唯一的 key，也無法避免這個問題。"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Flutter ReorderableListView</h1>
			<div class="meta">Posted on Sep 21, 2024</div>
		</div>
		

		<section class="body">
			<h1 id="使用-reorderablelist-解決-bloc-在-listview-中頻繁的關閉與創建問題">使用 ReorderableList 解決 Bloc 在 ListView 中頻繁的關閉與創建問題</h1>
<p>最近在開發 Flutter app 時遇到了一個問題：當 <code>ListView</code> 中，每個 child 都使用 <code>BlocProvider</code> ，例如:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyListView</span> <span style="color:#66d9ef">extends</span> StatelessWidget {
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Widget build(BuildContext context) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> BlocBuilder<span style="color:#f92672">&lt;</span>MyCubit, MyState<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      builder: (_, state) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ListView.builder(
</span></span><span style="display:flex;"><span>          itemCount: state.length,
</span></span><span style="display:flex;"><span>          itemBuilder: (context, index) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> BlocProvider(
</span></span><span style="display:flex;"><span>              create: (_) <span style="color:#f92672">=&gt;</span> MyCubit(),
</span></span><span style="display:flex;"><span>              child: ListTile(
</span></span><span style="display:flex;"><span>                key: ValueKey(state[index]),
</span></span><span style="display:flex;"><span>                title: Text(state[index].title),
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果列表的順序變更，child bloc 會將頻繁地被關閉與重新創建。此時會導致所有的 child 發生 <code>emit error</code>：</p>
<pre tabindex="0"><code>[ERROR: flutter/runtime/dart_vm_initializer.cc(41)] Unhandled Exception: Bad state: Cannot emit new states after calling close
#0  BlocBase.emit (package:bloc/src/bloc_base.dart:97:9)
#1  MyCubit.fetchData.&lt;anonymous closure&gt; (package: myapp/features/hello/presentation/blocs/cubit.dart:203:13)
#2  GreetingRepository.fetchData(package:myapp/features/hello/infrastructure/repositories.dart:167:20)
‹asynchronous suspension&gt;
#3  GreetingRepository.fetch.&lt;anonymous closure (package:myapp/features/hello/infrastructure/repositories.dart:60:9)
&lt;asynchronous suspension&gt;
</code></pre><p>即便在每個 <code>child</code> 上增加了唯一的 <code>key</code>，也無法避免這個問題。</p>
<h2 id="解決方案">解決方案</h2>
<p>為了解決這個問題，可以將 <code>ListView</code> 替換為 <code>ReorderableListView</code>。<code>ReorderableListView</code> 提供了一個可以自由拖曳調整順序的功能，並且在指定每個 <code>child</code> 的 <code>key</code> 後，它不會隨便重新創建 <code>child</code> 或關閉 <code>Cubit</code>。這樣，我們就能保持 <code>Cubit</code> 狀態的穩定性，不再受到順序變更的影響。</p>
<p>以下是修正後的程式碼，使用 <code>ReorderableListView</code> 來處理列表的順序變更，同時保留每個 <code>Bloc</code> 的狀態：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyReorderableListView</span> <span style="color:#66d9ef">extends</span> StatelessWidget {
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Widget build(BuildContext context) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> BlocBuilder<span style="color:#f92672">&lt;</span>MyCubit, MyState<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      builder: (ctx, state) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ReorderableListView(
</span></span><span style="display:flex;"><span>          onReorder: (oldIndex, newIndex) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (newIndex <span style="color:#f92672">&gt;</span> oldIndex) {
</span></span><span style="display:flex;"><span>              newIndex <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            ctx.read<span style="color:#f92672">&lt;</span>MyCubit<span style="color:#f92672">&gt;</span>().moveItem(oldIndex, newIndex);
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>          children: List.generate(state.items.length, (index) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> BlocProvider(
</span></span><span style="display:flex;"><span>              key: ValueKey(state.items[index]), <span style="color:#75715e">// 保證每個 child 有唯一的 key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              create: (_) <span style="color:#f92672">=&gt;</span> MyCubit(),
</span></span><span style="display:flex;"><span>              child: ListTile(
</span></span><span style="display:flex;"><span>                title: Text(state.items[index].title),
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>          }),
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>這段程式碼的關鍵在於，我們使用 <code>ValueKey</code> 為每個 <code>BlocProvider</code> 提供唯一的標識，並且使用 <code>ReorderableListView</code> 來取代 <code>ListView</code>，解決了頻繁的 <code>Cubit</code> 關閉與重建問題。</p>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/flutter">flutter</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
