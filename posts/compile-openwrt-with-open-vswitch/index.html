<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Compile OpenWRT with Open vSwitch - 世界的盡頭</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="雖然說在 google 上很多資料都說，Open vSwitch 已經加入到 OpenWRT 的 packages repository，而且在 GitHub 上也有看到 Open vSwitch 的身影。但是實際上，在官方的 repository 中並沒有 Open vSwitch。因此決定自行編譯。
實驗環境


編譯環境

Operating System: Ubuntu 14.04 x64
OpenWRT version: 14.07
Open vSwitch version: 2.3.1



路由器

TP-Link TL-WR1043ND


" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="Compile OpenWRT with Open vSwitch" />
<meta property="og:description" content="雖然說在 google 上很多資料都說，Open vSwitch 已經加入到 OpenWRT 的 packages repository，而且在 GitHub 上也有看到 Open vSwitch 的身影。但是實際上，在官方的 repository 中並沒有 Open vSwitch。因此決定自行編譯。
實驗環境


編譯環境

Operating System: Ubuntu 14.04 x64
OpenWRT version: 14.07
Open vSwitch version: 2.3.1



路由器

TP-Link TL-WR1043ND


" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://maple52046.github.io/posts/compile-openwrt-with-open-vswitch/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-03-05T17:05:00+00:00" />
<meta property="article:modified_time" content="2015-03-05T17:05:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="Compile OpenWRT with Open vSwitch"/>
<meta name="twitter:description" content="雖然說在 google 上很多資料都說，Open vSwitch 已經加入到 OpenWRT 的 packages repository，而且在 GitHub 上也有看到 Open vSwitch 的身影。但是實際上，在官方的 repository 中並沒有 Open vSwitch。因此決定自行編譯。
實驗環境


編譯環境

Operating System: Ubuntu 14.04 x64
OpenWRT version: 14.07
Open vSwitch version: 2.3.1



路由器

TP-Link TL-WR1043ND


"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">Compile OpenWRT with Open vSwitch</h1>
			<div class="meta">Posted on Mar 5, 2015</div>
		</div>
		

		<section class="body">
			<p>雖然說在 google 上很多資料都說，Open vSwitch 已經加入到 OpenWRT 的 packages repository，而且在 GitHub 上也有看到 <a href="https://github.com/openwrt/packages/tree/master/net/openvswitch">Open vSwitch</a> 的身影。但是實際上，在官方的 <a href="https://downloads.openwrt.org/barrier_breaker/14.07/">repository</a> 中並沒有 Open vSwitch。因此決定自行編譯。</p>
<h1 id="實驗環境"><strong>實驗環境</strong></h1>
<ul>
<li>
<p>編譯環境</p>
<ul>
<li>Operating System: Ubuntu 14.04 x64</li>
<li>OpenWRT version: 14.07</li>
<li>Open vSwitch version: 2.3.1</li>
</ul>
</li>
<li>
<p>路由器</p>
<ul>
<li><a href="http://www.tp-link.tw/products/details/?model=TL-WR1043ND">TP-Link TL-WR1043ND</a></li>
</ul>
</li>
</ul>
<hr>
<h1 id="開始編譯"><strong>開始編譯</strong></h1>
<ul>
<li><strong>首先要先安裝編譯環境</strong></li>
</ul>
<pre tabindex="0"><code>sudo apt-get -y install build-essential subversion git-core libncurses5-dev zlib1g-dev gawk flex quilt libssl-dev xsltproc libxml-parser-perl unzip
</code></pre><ul>
<li><strong>下載 source code (stable version, 14.07)</strong></li>
</ul>
<pre tabindex="0"><code>user@localhost:~$ git clone git://git.openwrt.org/14.07/openwrt.git
</code></pre><ul>
<li><strong>建立 feeds.conf</strong></li>
</ul>
<pre tabindex="0"><code>user@localhost:~$ cd openwrt
user@localhost:~/openwrt$ mv feeds.conf.default feeds.conf
</code></pre><ul>
<li><strong>執行 <code>feeds update</code></strong></li>
</ul>
<pre tabindex="0"><code>user@localhost:~/openwrt$ ./scripts/feeds update -a
</code></pre><pre><code>指令結束後，會看到當前目錄下多了一個資料夾，名稱為 **feeds**，裡面將會根據 feeds.conf 的每個項目，一個項目將會產生兩個目錄、一個 soft-link，例如:
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ ls -lh feeds/
drwxrwxr-x 13 user user 4.0K  3月  9 14:24 packages
lrwxrwxrwx  1 user user   25  3月  9 14:52 packages.index -&gt; packages.tmp/.packageinfo
drwxrwxr-x  3 user user 4.0K  3月  9 14:24 packages.tmp
</code></pre><ul>
<li>
<p><strong>將 Open vSwitch repo 新增到 feeds.conf 中</strong></p>
<p>先檢查看看 packages 與 oldpackages 裡面是否有 openvswitch:</p>
</li>
</ul>
<pre tabindex="0"><code>user@localhost:~/openwrt$ ls feeds/packages/net/ | grep openvswtich
user@localhost:~/openwrt$ ls feeds/oldpackages/net/ | grep openvswitch
</code></pre><pre><code>如果有，則跳過此步驟；反之，則新增 Open vSwitch repo:
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ echo &#39;src-git openvswitch git://github.com/pichuang/openvwrt.git&#39; &gt;&gt; feeds.conf
user@localhost:~/openwrt$ ./script/feeds update -a
</code></pre><pre><code>然後打上 libatomic patch:
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ wget https://gist.githubusercontent.com/pichuang/7372af6d5d3bd1db5a88/raw/4e2290e3e184288de7623c02f63fb57c536e035a/openwrt-add-libatomic.patch -q -O - | patch -p1
</code></pre><pre><code>執行完之後，在 feeds 資料夾裡面看到 openvswitch:
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ ls -lh feeds/ | grep openvswitch
drwxrwxr-x  4 user user 4.0K  3月  9 14:52 openvswitch
lrwxrwxrwx  1 user user   28  3月  9 14:52 openvswitch.index -&gt; openvswitch.tmp/.packageinfo
drwxrwxr-x  3 user user 4.0K  3月  9 14:52 openvswitch.tmp
</code></pre><pre><code>- **更改 Open vSwitch 版本**
    原本的 maintainer 已經不再維護了，因此版本還是 2.3.0。如果想要更改版本，則編輯 `feeds/openvswitch/openvswitch/Makefile`
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-make" data-lang="make"><span style="display:flex;"><span>PKG_RELEASE<span style="color:#f92672">:=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>PKG_VERSION<span style="color:#f92672">:=</span>2.3.0
</span></span></code></pre></div><pre><code>    修改 `PKG_RELEASE` 與 `PKG_VERSION` 這兩個值:
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-make" data-lang="make"><span style="display:flex;"><span>PKG_RELEASE<span style="color:#f92672">:=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>PKG_VERSION<span style="color:#f92672">:=</span>2.3.1
</span></span></code></pre></div><pre><code>    然後再次執行 `feeds update`
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ ./scripts/feeds update openvswitch
</code></pre><pre><code>    這時候就可以看到 `feeds/openvswitch.index` 裡面，Open vSwitch 的版本就改成了 **2.3.1-0**
</code></pre>
<pre tabindex="0"><code>Source-Makefile: feeds/openvswitch/openvswitch/Makefile
Package: openvswitch-ipsec
Version: 2.3.1-0
</code></pre><ul>
<li><strong>執行 <code>feeds install</code></strong></li>
</ul>
<pre tabindex="0"><code>user@localhost:~/openwrt$ ./scripts/feeds install -a
</code></pre><ul>
<li><strong>執行 <code>make menuconfig</code></strong></li>
</ul>
<pre tabindex="0"><code>user@localhost:~/openwrt$ make menuconfig
</code></pre><pre><code>接下來會開啟編譯選單:&lt;br /&gt;
</code></pre>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/sjalQsXQQmSupf39sAid_make_menuconfig.jpg" alt="make_menuconfig.jpg"></p>
<pre><code>利用上下左右、M、空白鍵來切換與選擇不同的編譯選項。在選擇編譯選項時，原則上是:
1. 系統預設值保留不變，除非要拿掉甚麼功能，ex: ppp。
2. 盡量將需要編譯的項目選擇為 **M**，而不是 &lt;strong&gt;*&lt;/strong&gt;，除非認定必要存在。

選擇的過程中或是離開前，選擇 **save** 可以將選項儲存起來，檔名保留為 **.config** (檔名不可以變更)。&lt;br /&gt;
</code></pre>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/S0tZR8TwRa2v87AuN92F_save_config.jpg" alt="save_config.jpg"></p>
<pre><code>- **Target Profile**

    如果 OpenWRT 是要自己使用的，可以指定要編譯哪些 firmware，這樣可以節省不少編譯時間。&lt;br /&gt;
    選擇 `Target Profile` -&gt; 選擇指定的 device 名稱，例如: TP-Link TL-W1043N/ND&lt;br /&gt;
</code></pre>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/T7gxdCp0SAmLXpoyZvnH_custom_profile.jpg" alt="custom_profile.jpg"></p>
<pre><code>- **Open vSwitch**
    1. 選擇 `Network` -&gt; `openvswitch-common`、`openvswitch-ipsec`、`openvswitch-switch` &lt;br /&gt;&lt;br /&gt;
</code></pre>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/KlkgzKJGSVSWdkhAGBOL_choice_openvswitch.jpg" alt="choice_openvswitch.jpg"><!-- raw HTML omitted -->
2. 選擇 <code>Advanced configuration options (for developers)</code> -&gt; <code>Target Options</code> -&gt; <strong>取消勾選</strong> <code>Build packages with MPIS16 instructions</code><!-- raw HTML omitted -->
3. 選擇 <code>Advanced configuration options (for developers)</code> -&gt; <code>Toolchain Options</code> -&gt; <code>Binutils Version</code> -&gt;<code>Linaro binutils 2.24</code></p>
<pre><code>- **Luci** (Option.)

    如果想要網頁管理介面，可以選擇加裝 luci&lt;br /&gt;
    選擇 `Luci` -&gt; `Collections` -&gt; `luci`&lt;br /&gt;
</code></pre>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/O6dnoyPcQ0KoIldgbv3Y_luci.jpg" alt="luci.jpg"></p>
<ul>
<li><strong>Compile OpenWRT</strong>
選擇完編譯選項，並將設定值儲存為 <strong>.config</strong> 之後，接下來執行:<!-- raw HTML omitted --></li>
</ul>
<pre tabindex="0"><code>user@localhost:~/openwrt$ echo &#39;#CONFIG_KERNEL_BRIDGE is not set&#39; &gt;&gt; .config
</code></pre><pre><code>這個步驟再每一次 `make menuconfig` 之後都要執行一次&lt;br /&gt;
然後開始編譯 OpenWRT&lt;br/&gt;
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ make V=s
</code></pre><pre><code>編譯完成後的檔案會放在 `openwrt/bin/`
</code></pre>
<p><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<ul>
<li>
<p><strong>架設 repository</strong>
為了方便燒 OpenWRT 到 AP 裡面，可以順便架設 web server ，透過 HTTP 來提供 firmware 載點。以 nginx 為範例:</p>
<ul>
<li>安裝 web server</li>
</ul>
</li>
</ul>
<pre tabindex="0"><code>user@localhost:~/openwrt$ sudo apt-get -y install nginx
</code></pre><pre><code>- 編輯 `/etc/nginx/sites-available/default`，在 **server** 的設定裡面，新增以下 location 片段:
</code></pre>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#66d9ef">location</span> <span style="color:#e6db74">/openwrt/downloads</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">alias</span> <span style="color:#e6db74">/home/user/openwrt/bin</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">autoindex</span> <span style="color:#66d9ef">on</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><pre><code>    請根據喜好與系統狀態去設定:
    - URL: `/openwrt/downloads`
    - PATH (編譯後的 firmware 放置位置): `/home/user/openwrt/bin`

- 重啟 nginx
</code></pre>
<pre tabindex="0"><code>user@localhost:~/openwrt$ sudo service nginx restart
</code></pre><pre><code>然後打開瀏覽器，輸入網址: `http://&lt;&lt;your ip&gt;&gt;/openwrt/downloads`，應該要出現類似以下的畫面:&lt;br /&gt;
</code></pre>
<p><img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/2NycfcuTRCiuY67uumXA_custom_repository_1.jpg" alt="custom_repository_1.jpg"><!-- raw HTML omitted -->
點擊 <strong>ar71xx</strong> 後:<!-- raw HTML omitted -->
<img src="http://user-image.logdown.io/user/10779/blog/10403/post/256561/Az6shvIdRqyXaK4wDUkV_custom_repository_2.jpg" alt="custom_repository_2.jpg"></p>
<hr>
<h1 id="使用-openwrt"><strong>使用 OpenWRT</strong></h1>
<p>接下來就可以利用 Luci 、<a href="http://wiki.openwrt.org/doc/howto/generic.sysupgrade">Sysupgrade 指令</a>、AP 原廠的管理介面等方法去燒 OpenWRT。<!-- raw HTML omitted -->
OpenWRT 第一次開機時，要使用 telnet 的方式連入</p>
<pre tabindex="0"><code>telnet 192.168.1.1
</code></pre><p>進入系統之後，更換 root 密碼。登出之後，接下來就改用 ssh (或是 Luci) 登入。</p>
<hr>
<h1 id="reference">Reference</h1>
<ul>
<li><a href="http://linton.tw/2014/05/13/openflow-13-for-openwrt-on-tl-1043nd-with-open-vswitch/">OpenFlow 1.3 for OpenWRT on TL-1043ND with OVS</a></li>
<li><a href="http://roan.logdown.com/posts/165911-compiled-openwrt">編譯 OpenWrt</a></li>
<li><a href="http://roan.logdown.com/posts/208499-openvswitch-lab-5-porting-openvswitch-to-openwrt">Porting OpenvSwitch to OpenWrt</a></li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/openwrt">openwrt</a></li>
					
					<li><a href="/tags/open-vswitch">open vswitch</a></li>
					
				</ul>
			</nav>
			
			
		</div>
		</article>
</main>
<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</div>
    </body>
</html>
