
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="世界的盡頭">
    <title>Setup Squid Transparent Proxy with Docker - 世界的盡頭</title>
    <meta name="author" content="古振浩 Chen-Hao Ku">
    
    
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"古振浩 Chen-Hao Ku","sameAs":["https://github.com/maple52046","https://twitter.com/","https://www.facebook.com/maple52046","https://www.linkedin.com/in/kuchenhao/","mailto:maple52046@gmail.com"],"image":"https://www.gravatar.com/avatar/79384e4270ffd7a2d23fc41b7533db73"},"articleBody":"Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量還可以控管區網內是否要開放/封鎖網站(監看區網內誰在玩FB或是看色情網站XD)\n通常 Transparent proxy 都會放在區網對外的那台 server 上，例如下圖：\n\n\n對於 Proxy , Transparent proxy 沒有概念的人，可以先看鳥哥的文章，這邊就很不負責的說不再贅述了((懶~\n實驗環境\n\n\nItem\nValue\n\n\n\nOS\nGentoo\n\n\nDocker version\n1.7.9\n\n\nDocker image\nsameersbn/squid:3.3.8-4\n\n\n只要能跑 Docker, 實體機的 OS 是什麼都不重要 :D\n\n\n安裝步驟1. 安裝 Docker在 Gentoo 上安裝 Docker 會比較麻煩一些，要注意 kernel 有些功能要打開，其他就按照 Docker 官方教學(For Gentoo)即可。至於其他 OS，就只好很不負責任的說，請參考 Docker 官方教學安裝吧\n2. 設定 Memory Disk (Option.)既然 Squid 是一個 Proxy server，那通常就會有一個存放 cache 的地方。一般來說，如果 server 的 memory 夠大，將 cache 放到 memory 中是一個好選擇，可以讓效能快很多。\n123$ sudo mkdir &#x2F;var&#x2F;spool&#x2F;squid3$ echo &quot;tmpfs &#x2F;var&#x2F;spool&#x2F;squid3&#x2F; tmpfs defaults,size&#x3D;256m,mode&#x3D;1777 0 0&quot; | sudo tee -a &#x2F;etc&#x2F;fstab$ sudo mount &#x2F;var&#x2F;spool&#x2F;squid3\n\nps: tee 這個指令千萬別忘了加上 -a，免得 /etc/fstab 的內容會被覆蓋。\n\n手動掛載 sudo mount -t tmpfs -o size=256M,mode=1777 tmpfs /var/spool/squid3\n\n3. 運行 Container裝好 Docker 之後，接下來我們要運行 container。在網路上已經有安裝好的 docker image，可以直接從 docker.io 上下載。在這裡我選的是 sameersbn/squid:3.3.8-4 。\n執行 docker run 指令，下載 docker image 並運行 Squid container：\n1$ sudo docker run -d --name squid3 --net host -v &#x2F;var&#x2F;log&#x2F;squid3:&#x2F;var&#x2F;log&#x2F;squid3 -v &#x2F;var&#x2F;spool&#x2F;squid3:&#x2F;var&#x2F;spool&#x2F;squid3 sameersbn&#x2F;squid:3.3.8-4\n\n\n-d 是指 daemon mode, 也就是背景運作。\n--name 就是這個 container 的名稱。這個參數可以自由選擇要不要加，不加的話，docker 會直接以那一長串的 UUID 為名稱；為了操作方便，建議指定 container 的名稱\n-net 是 container 的網路模式。一般如果不加這個參數，預設是 bridge。如果不是 host mode 時，必須要加上 -p 3128:3128 或是自行設定 iptables nat rule 才能讓其他電腦連到 container。\n-v 是將實體機上的某個路徑，掛載到 container 的某個路徑。\n/var/log/squid3 是 Squid 預設的 log 檔目錄。如果想要方便一點查看 log，建議可以掛載這個目錄。\n/var/spool/squid3 是 Squid 預設的 cache 目錄。如果想要用 memory disk 來提高效能，記得做完第二步驟，並設定這個參數。\n\n\nsameersbn/squid:3.3.8-4 就是 docker image 名稱。\n\n利用 docker ps 來檢查 container 是否有在運作：\n123sudo docker psCONTAINER ID        IMAGE                     COMMAND                CREATED             STATUS              PORTS               NAMES2d8d9f19b25d        sameersbn&#x2F;squid:3.3.8-4   &quot;&#x2F;sbin&#x2F;entrypoint.sh   2 hours ago         Up About an hour                        squid3\n\n如果想要看 log，有兩種方式：\n\n如果 docker run 的參數有加上 -v &lt;&lt;some path in host server&gt;&gt;:/var/log/squid3 就可以在實體機上看到 log 檔。 在我的範例中是 /var/log/squid3/cache.log\n如果沒有掛載 log 路徑，你也可以執行 docker logs &lt;&lt;container name&gt;&gt; 查看 log。\n\n4. 設定 SquidSquid 的設定檔是 squid.conf，存放在 container 裡面。想要修改可以直接進入 container 裡面，或是執行 sudo docker exec -it &lt;&lt;contianer name&gt;&gt; vi /etc/squid3/squid.conf\n如果你的 Docker 是 1.8 以上的版本，可以用 docker cp 將檔案下載到實體機上，編輯完後再傳回去。但可惜我不是。\n為了圖方便，我將 /etc/squid3 整個資料夾下載到實體機，然後刪除舊的 container，重新建立新的 container 並加上掛載設定檔目錄的參數\n123$ sudo docker cp squid3:&#x2F;etc&#x2F;squid3 &#x2F;etc&#x2F;$ sudo docker rm -f squid3$ sudo docker run -d --name squid3 --net host -v &#x2F;etc&#x2F;squid3:&#x2F;etc&#x2F;squid3 -v &#x2F;var&#x2F;log&#x2F;squid3:&#x2F;var&#x2F;log&#x2F;squid3 -v &#x2F;var&#x2F;spool&#x2F;squid3:&#x2F;var&#x2F;spool&#x2F;squid3 sameersbn&#x2F;squid:3.3.8-4\n\n編輯 squid.conf接下來就要編輯 squid.conf，以下先提供我的設定檔：\n12345678910111213141516171819202122232425262728acl localnet src 10.0.0.0&#x2F;8\t    # RFC1918 possible internal networkacl localnet src 172.16.0.0&#x2F;12\t# RFC1918 possible internal networkacl localnet src 192.168.0.0&#x2F;16\t# RFC1918 possible internal networkacl localnet src fc00::&#x2F;7       # RFC 4193 local private network rangeacl localnet src fe80::&#x2F;10      # RFC 4291 link-local (directly plugged) machinesacl SSL_ports port 443acl Safe_ports port 80\t\t# httpacl Safe_ports port 21\t\t# ftpacl Safe_ports port 443\t\t# httpsacl Safe_ports port 70\t\t# gopheracl Safe_ports port 210\t\t# waisacl Safe_ports port 1025-65535\t# unregistered portsacl Safe_ports port 280\t\t# http-mgmtacl Safe_ports port 488\t\t# gss-httpacl Safe_ports port 591\t\t# filemakeracl Safe_ports port 777\t\t# multiling httpacl CONNECT method CONNECThttp_access deny !Safe_portshttp_access deny CONNECT !SSL_portshttp_access allow localhost managerhttp_access deny managerhttp_access deny to_localhosthttp_access allow localnethttp_access allow localhosthttp_access deny allhttp_port 3128 transparenthttps_port 3129 transparent cert&#x3D;&#x2F;etc&#x2F;squid3&#x2F;squid-proxy.crt key&#x3D;&#x2F;etc&#x2F;squid3&#x2F;squid-proxy.key ssl-bumpssl_bump none all\n\n\nacl localnet src 192.168.0.0/16\nlocalnet 是一個自訂的名稱\nsrc 是指 request 的來源\n192.168.0.0/16 也就是我們後端的 LAN。\n\n\nhttp_port 3128 transparent\nhttp_port 就是設定 squid 負責 listen HTTP request 的 port。預設是 3128。\ntransparent 就是運作模式，因為我們要建置 transparent proxy，所以必須要加上這個參數。\n\n\nhttps_port 3129 transparent cert=/etc/squid3/ssl/squid-proxy.crt key=/etc/squid3/ssl/squid-proxy.key ssl-bump\nhttps_port 顧名思義就是接受 https request 的 port。不能設定跟 http_port 一樣\ncert 跟 key 必須要設定一對 self signed certificate 的路徑。\nssl-bump 設定 HTTPs 的加解密訊息要怎麼處理。這邊建議搭配 ssl_bump none all 這個設定，讓 client 直接讀取 Web server 的 certificate。\n\n\n\n其他的參數可以不用動\n產生 self signed certificate首先必需先安裝 OpenSSL。在 Gentoo 上應該是 dev-libs/openssl;而 Ubuntu 上則只需要 apt-get install openssl 即可。\n\n產生出來的 certificate 必須要 Squid 能讀取到。因此，如果你有安裝我之前的步驟，將實體機上的某個資料夾掛載到 container，例如： /etc/squid3 之類，你就可以利用這些資料夾來傳檔案；若否，則建議直接在 container 中執行這個步驟。（例如可以 docker exec -it squid3 openssl ...... 但是這樣路徑必須要是絕對路徑，例如 /etc/squid3/squid-server.key)\n\n安裝好之後，接下來安裝以下指令步驟：\n1234567$ openssl genrsa -des3 -out squid-server.key 1024Generating RSA private key, 1024 bit long modulus............................++++++...........................................................++++++e is 65537 (0x10001)Enter pass phrase for squid-server.key:Verifying - Enter pass phrase for squid-server.key:\n\npass phrase 必須要打一串密碼進去，不可以留空\n123456789101112131415161718192021$ openssl req -new -key squid-server.key -out squid-server.csrEnter pass phrase for squid-server.key:You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &#39;.&#39;, the field will be left blank.-----Country Name (2 letter code) [AU]:TWState or Province Name (full name) [Some-State]:TaiwanLocality Name (eg, city) []:HsichuOrganization Name (eg, company) [Internet Widgits Pty Ltd]:NTHUOrganizational Unit Name (eg, section) []:SSLabCommon Name (e.g. server FQDN or YOUR name) []:maple52046.twbbs.org.twEmail Address []:maple52046@gmail.comPlease enter the following &#39;extra&#39; attributesto be sent with your certificate requestA challenge password []:An optional company name []:\n\n後面 extra 這邊全部直接按 enter 跳過。\n然後接下來還有兩個指令：\n12345678$ openssl rsa -in squid-server.key -out squid-proxy.keyEnter pass phrase for squid-server.key:writing RSA key$ openssl x509 -req -days 365 -in squid-server.csr -signkey squid-proxy.key -out squid-proxy.crtSignature oksubject&#x3D;&#x2F;C&#x3D;TW&#x2F;ST&#x3D;Taiwan&#x2F;L&#x3D;Hsichu&#x2F;O&#x3D;NTHU&#x2F;OU&#x3D;SSLab&#x2F;CN&#x3D;maple52046.twbbs.org.tw&#x2F;emailAddress&#x3D;maple52046@gmail.comGetting Private key\n\n完成之後，在當前目錄下，會產生4個檔案：\n12$ lssquid-proxy.crt  squid-proxy.key  squid-server.csr  squid-server.key\n\n將 squid-proxy.crt 與 squid-proxy.key 放到 container 可以讀取到的地方，例如：/etc/squid3 …\n5. Restart Squid重新啟動 Squid server 以便套用新設定\n1$ sudo docker restart squid3\n\n檢查一下 port 是否有在監聽：\n1sudo netstat -tlnp | egrep &#39;3128|3129&#39;\n\n6. 設定 Iptables因為是 transparent proxy，所以還必須要加上 iptables nat rule，將 HTTP/HTTPs request 導入到 Squid 中：\n12$ sudo iptables -t nat -A PREROUTING ! -d 10.0.0.1 -p tcp --dport 80 -j REDIRECT --to 3128$ sudo iptables -t nat -A PREROUTING ! -d 10.0.0.1 -p tcp --dport 443 -j REDIRECT --to 3129\n\n這邊 10.0.0.1 是實體 server 的對外 IP。如果你的 NAT server 沒有提供 web service，那就可以去掉這個條件，直接變成 iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to 3128\n或者你的 NAT server 是有區分內外網的 interface，例如假設 eth0 是連接外網、eth1 是連接內網，那就可以改成：iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j REDIRECT --to 3128\n7. 用 upstart/systemd 來管理 Squid container (Options.)如果將來 NAT server 重開機，那麼就得要自己重新啟動 container。因此可以利用 Linux 上的 upstart(或是 systemd)來啟動 container 會方便很多。\n以下用 upstart 為例( systemd 可以參考 Docker 官方教學)：\n\n建立 /etc/init/squid3.conf，並新增以下內容：\n12345678description &quot;Squid Proxy Server&quot;author &quot;Maple52046&quot;start on filesystem and started dockerstop on runlevel [!2345]respawnscript\t&#x2F;usr&#x2F;bin&#x2F;docker start -a squid3end script\n\n產生 /etc/init.d/squid3\n1sudo ln -s &#x2F;lib&#x2F;init&#x2F;upstart-job &#x2F;etc&#x2F;init.d&#x2F;squid3\n\n關閉原本的 container ，並啟動服務\n12sudo docker stop squid3sudo service squid3 start\n檢查一下 container 是否已經啟動\n12sudo service squid3 statussudo docker ps | grep squid3\n\n\n\n\n架設完 Squid proxy server 之後， 就可以分析 Squid 的 Log (/var/log/squid3/access.log)\n123456789101447999536.213 120894 192.168.0.3 TCP_MISS&#x2F;200 7655 CONNECT 74.125.203.138:443 - HIER_DIRECT&#x2F;74.125.203.138 -1447999536.213 121078 192.168.0.3 TCP_MISS&#x2F;200 4957 CONNECT 64.233.188.139:443 - HIER_DIRECT&#x2F;64.233.188.139 -1447999554.963 240143 192.168.0.3 TCP_MISS&#x2F;200 5176 CONNECT 64.233.189.95:443 - HIER_DIRECT&#x2F;64.233.189.95 -1447999555.327 240351 192.168.0.3 TCP_MISS&#x2F;200 5961 CONNECT 64.233.189.95:443 - HIER_DIRECT&#x2F;64.233.189.95 -1447999566.344   3061 192.168.0.3 TCP_MISS_ABORTED&#x2F;000 0 GET http:&#x2F;&#x2F;secclientgw.alipay.com&#x2F;product&#x2F;3001&#x2F;2.4.0.0&#x2F;version.xml? - HIER_DIRECT&#x2F;110.76.20.11 -1447999567.267 112594 192.168.0.3 TCP_MISS&#x2F;200 55546 CONNECT 23.48.140.135:443 - HIER_DIRECT&#x2F;23.48.140.135 -1447999574.672 240106 192.168.0.3 TCP_MISS&#x2F;200 4895 CONNECT 74.125.204.139:443 - HIER_DIRECT&#x2F;74.125.204.139 -1447999574.975 120170 192.168.0.3 TCP_MISS&#x2F;200 744 CONNECT 54.230.212.62:443 - HIER_DIRECT&#x2F;54.230.212.62 -1447999578.090 240080 192.168.0.3 TCP_MISS&#x2F;200 1310 CONNECT 74.125.203.139:443 - HIER_DIRECT&#x2F;74.125.203.139 -1447999631.985  65873 192.168.0.3 TCP_MISS&#x2F;200 7278 CONNECT 31.13.87.1:443 - HIER_DIRECT&#x2F;31.13.87.1 -\n\nReference\n第十七章、區網控制者： Proxy 伺服器 - 鳥哥的 Linux 私房菜\nsameersbn/squid:3.3.8-4\nInstalling Docker on Gentoo Linux\nHow to setup client for squid transparent proxy?\nSquid – SSL Certificate\n拿 RAM 當硬碟來用(RAM Disk)\nHow to Enable SSL Squid\nCopying files from host to docker container\nHow to create a self-signed certificate with openssl?\nAutomatically start containers\n\n圖片來源\nhttp://www.peppercan.com/wp-content/uploads/2012/03/cloud.png\nhttp://orig05.deviantart.net/4a1c/f/2010/239/0/b/pc\\_clipart\\_by\\_chiprunner-d2xfpv6.png\n\n","dateCreated":"2015-11-19T17:09:00+08:00","dateModified":"2019-12-13T02:17:56+08:00","datePublished":"2015-11-19T17:09:00+08:00","description":"Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量還可以控管區網內是否要開放/封鎖網站(監看區網內誰在玩FB或是看色情網站XD)\n通常 Transparent proxy 都會放在區網對外的那台 server 上，例如下圖：\n\n\n對於 Proxy , Transparent proxy 沒有概念的人，可以先看鳥哥的文章，這邊就很不負責的說不再贅述了((懶~\n實驗環境\n\n\nItem\nValue\n\n\n\nOS\nGentoo\n\n\nDocker version\n1.7.9\n\n\nDocker image\nsameersbn/squid:3.3.8-4\n\n\n只要能跑 Docker, 實體機的 OS 是什麼都不重要 :D","headline":"Setup Squid Transparent Proxy with Docker","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"},"publisher":{"@type":"Organization","name":"古振浩 Chen-Hao Ku","sameAs":["https://github.com/maple52046","https://twitter.com/","https://www.facebook.com/maple52046","https://www.linkedin.com/in/kuchenhao/","mailto:maple52046@gmail.com"],"image":"https://www.gravatar.com/avatar/79384e4270ffd7a2d23fc41b7533db73","logo":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/79384e4270ffd7a2d23fc41b7533db73"}},"url":"https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/","keywords":"Docker, Squid"}</script>
    <meta name="description" content="Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量還可以控管區網內是否要開放&#x2F;封鎖網站(監看區網內誰在玩FB或是看色情網站XD) 通常 Transparent proxy 都會放在區網對外的那台 server 上，例如下圖：   對於 Proxy , Transparent proxy 沒有概念的人，可以先看鳥哥的文章，這邊就很不負責的說不再贅述了">
<meta property="og:type" content="blog">
<meta property="og:title" content="Setup Squid Transparent Proxy with Docker">
<meta property="og:url" content="https:&#x2F;&#x2F;maple52046.github.io&#x2F;2015&#x2F;11&#x2F;19&#x2F;Setup-Squid-Transparent-Proxy-with-Docker&#x2F;index.html">
<meta property="og:site_name" content="世界的盡頭">
<meta property="og:description" content="Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量還可以控管區網內是否要開放&#x2F;封鎖網站(監看區網內誰在玩FB或是看色情網站XD) 通常 Transparent proxy 都會放在區網對外的那台 server 上，例如下圖：   對於 Proxy , Transparent proxy 沒有概念的人，可以先看鳥哥的文章，這邊就很不負責的說不再贅述了">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http:&#x2F;&#x2F;user-image.logdown.io&#x2F;user&#x2F;10779&#x2F;blog&#x2F;10403&#x2F;post&#x2F;314634&#x2F;N4mq1E37S767W0ZY5S3U_%E6%9C%AA%E5%91%BD%E5%90%8D.001.jpeg">
<meta property="article:published_time" content="2015-11-19T09:09:00.000Z">
<meta property="article:modified_time" content="2019-12-12T18:17:56.465Z">
<meta property="article:author" content="古振浩 Chen-Hao Ku">
<meta property="article:tag" content="Docker">
<meta property="article:tag" content="Squid">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;user-image.logdown.io&#x2F;user&#x2F;10779&#x2F;blog&#x2F;10403&#x2F;post&#x2F;314634&#x2F;N4mq1E37S767W0ZY5S3U_%E6%9C%AA%E5%91%BD%E5%90%8D.001.jpeg">
<meta name="twitter:creator" content="@titan1782">
    
    
        
    
    
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-7yv7uj2hjiyfxjpniqemlgo6xmfv4x3o4kblstx6a7uhun0eclzenhgguigr.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-79529428-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-79529428-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/%20"
            aria-label=""
        >
            世界的盡頭
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
        </a>
    
</header>

            <!-- Define author's picture -->


<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/%20"
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                            title="Search"
                        >
                    
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/maple52046" target="_blank" rel="noopener" title="GitHub">
                    
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/" target="_blank" rel="noopener" title="Twitter">
                    
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.facebook.com/maple52046" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/kuchenhao/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:maple52046@gmail.com" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Setup Squid Transparent Proxy with Docker
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2015-11-19T17:09:00+08:00">
	
		    Nov 19, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/Container/">Container</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>Squid 作為 Transparent proxy 時，不但可以加快區域網絡內的速度、降低網路流量<br>還可以控管區網內是否要開放/封鎖網站<del>(監看區網內誰在玩FB或是看色情網站XD)</del></p>
<p>通常 Transparent proxy 都會放在區網對外的那台 server 上，例如下圖：</p>
<img class="center" src="http://user-image.logdown.io/user/10779/blog/10403/post/314634/N4mq1E37S767W0ZY5S3U_%E6%9C%AA%E5%91%BD%E5%90%8D.001.jpeg" alt="Squid-transparent-proxy.jpeg">

<p>對於 Proxy , Transparent proxy 沒有概念的人，可以先看<a href="http://linux.vbird.org/linux_server/0420squid.php" target="_blank" rel="noopener">鳥哥的文章</a>，這邊就很不負責的說不再贅述了((懶~</p>
<h1 id="實驗環境"><a href="#實驗環境" class="headerlink" title="實驗環境"></a>實驗環境</h1><table>
<thead>
<tr>
<th align="center">Item</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td align="center">OS</td>
<td align="center">Gentoo</td>
</tr>
<tr>
<td align="center">Docker version</td>
<td align="center">1.7.9</td>
</tr>
<tr>
<td align="center">Docker image</td>
<td align="center"><a href="https://github.com/sameersbn/docker-squid" target="_blank" rel="noopener">sameersbn/squid:3.3.8-4</a></td>
</tr>
</tbody></table>
<p>只要能跑 Docker, 實體機的 OS 是什麼都不重要 :D</p>
<a id="more"></a>
<hr>
<h1 id="安裝步驟"><a href="#安裝步驟" class="headerlink" title="安裝步驟"></a>安裝步驟</h1><h2 id="1-安裝-Docker"><a href="#1-安裝-Docker" class="headerlink" title="1. 安裝 Docker"></a>1. 安裝 Docker</h2><p>在 Gentoo 上安裝 Docker 會比較麻煩一些，要注意 kernel 有些功能要打開，其他就按照 <a href="http://docs.docker.com/engine/installation/gentoolinux/" target="_blank" rel="noopener">Docker 官方教學(For Gentoo)</a>即可。<br>至於其他 OS，就只好很不負責任的說，請參考 <a href="http://docs.docker.com/engine/installation/" target="_blank" rel="noopener">Docker 官方教學</a>安裝吧</p>
<h2 id="2-設定-Memory-Disk-Option"><a href="#2-設定-Memory-Disk-Option" class="headerlink" title="2. 設定 Memory Disk (Option.)"></a>2. 設定 Memory Disk (Option.)</h2><p>既然 Squid 是一個 Proxy server，那通常就會有一個存放 cache 的地方。一般來說，如果 server 的 memory 夠大，將 cache 放到 memory 中是一個好選擇，可以讓效能快很多。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir &#x2F;var&#x2F;spool&#x2F;squid3</span><br><span class="line">$ echo &quot;tmpfs &#x2F;var&#x2F;spool&#x2F;squid3&#x2F; tmpfs defaults,size&#x3D;256m,mode&#x3D;1777 0 0&quot; | sudo tee -a &#x2F;etc&#x2F;fstab</span><br><span class="line">$ sudo mount &#x2F;var&#x2F;spool&#x2F;squid3</span><br></pre></td></tr></table></figure>

<p>ps: <strong><code>tee</code> 這個指令千萬別忘了加上 <code>-a</code>，免得 <code>/etc/fstab</code> 的內容會被覆蓋。</strong></p>
<blockquote>
<p>手動掛載 <code>sudo mount -t tmpfs -o size=256M,mode=1777 tmpfs /var/spool/squid3</code></p>
</blockquote>
<h2 id="3-運行-Container"><a href="#3-運行-Container" class="headerlink" title="3. 運行 Container"></a>3. 運行 Container</h2><p>裝好 Docker 之後，接下來我們要運行 container。在網路上已經有安裝好的 docker image，可以直接從 docker.io 上下載。在這裡我選的是 <a href="https://github.com/sameersbn/docker-squid" target="_blank" rel="noopener">sameersbn/squid:3.3.8-4</a> 。</p>
<p>執行 <code>docker run</code> 指令，下載 docker image 並運行 Squid container：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker run -d --name squid3 --net host -v &#x2F;var&#x2F;log&#x2F;squid3:&#x2F;var&#x2F;log&#x2F;squid3 -v &#x2F;var&#x2F;spool&#x2F;squid3:&#x2F;var&#x2F;spool&#x2F;squid3 sameersbn&#x2F;squid:3.3.8-4</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-d</code> 是指 daemon mode, 也就是背景運作。</li>
<li><code>--name</code> 就是這個 container 的名稱。這個參數可以自由選擇要不要加，不加的話，docker 會直接以那一長串的 UUID 為名稱；<strong>為了操作方便，建議指定 container 的名稱</strong></li>
<li><code>-net</code> 是 container 的網路模式。一般如果不加這個參數，預設是 bridge。如果不是 <code>host</code> mode 時，必須要加上 <code>-p 3128:3128</code> 或是自行設定 iptables nat rule 才能讓其他電腦連到 container。</li>
<li><code>-v</code> 是將實體機上的某個路徑，掛載到 container 的某個路徑。<ul>
<li><code>/var/log/squid3</code> 是 Squid 預設的 log 檔目錄。如果想要方便一點查看 log，建議可以掛載這個目錄。</li>
<li><code>/var/spool/squid3</code> 是 Squid 預設的 cache 目錄。如果想要用 memory disk 來提高效能，記得做完第二步驟，並設定這個參數。</li>
</ul>
</li>
<li><code>sameersbn/squid:3.3.8-4</code> 就是 docker image 名稱。</li>
</ul>
<p>利用 <code>docker ps</code> 來檢查 container 是否有在運作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo docker ps</span><br><span class="line">CONTAINER ID        IMAGE                     COMMAND                CREATED             STATUS              PORTS               NAMES</span><br><span class="line">2d8d9f19b25d        sameersbn&#x2F;squid:3.3.8-4   &quot;&#x2F;sbin&#x2F;entrypoint.sh   2 hours ago         Up About an hour                        squid3</span><br></pre></td></tr></table></figure>

<p>如果想要看 log，有兩種方式：</p>
<ol>
<li>如果 <code>docker run</code> 的參數有加上 <code>-v &lt;&lt;some path in host server&gt;&gt;:/var/log/squid3</code> 就可以在實體機上看到 log 檔。 在我的範例中是 <code>/var/log/squid3/cache.log</code></li>
<li>如果沒有掛載 log 路徑，你也可以執行 <code>docker logs &lt;&lt;container name&gt;&gt;</code> 查看 log。</li>
</ol>
<h2 id="4-設定-Squid"><a href="#4-設定-Squid" class="headerlink" title="4. 設定 Squid"></a>4. 設定 Squid</h2><p>Squid 的設定檔是 <code>squid.conf</code>，存放在 container 裡面。想要修改可以直接進入 container 裡面，或是執行 <code>sudo docker exec -it &lt;&lt;contianer name&gt;&gt; vi /etc/squid3/squid.conf</code></p>
<p>如果你的 <a href="http://stackoverflow.com/questions/22907231/copying-files-from-host-to-docker-container" target="_blank" rel="noopener">Docker 是 1.8 以上的版本</a>，可以用 <code>docker cp</code> 將檔案下載到實體機上，編輯完後再傳回去。但可惜我不是。</p>
<p>為了圖方便，我將 <code>/etc/squid3</code> 整個資料夾下載到實體機，然後刪除舊的 container，重新建立新的 container 並加上掛載設定檔目錄的參數</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker cp squid3:&#x2F;etc&#x2F;squid3 &#x2F;etc&#x2F;</span><br><span class="line">$ sudo docker rm -f squid3</span><br><span class="line">$ sudo docker run -d --name squid3 --net host -v &#x2F;etc&#x2F;squid3:&#x2F;etc&#x2F;squid3 -v &#x2F;var&#x2F;log&#x2F;squid3:&#x2F;var&#x2F;log&#x2F;squid3 -v &#x2F;var&#x2F;spool&#x2F;squid3:&#x2F;var&#x2F;spool&#x2F;squid3 sameersbn&#x2F;squid:3.3.8-4</span><br></pre></td></tr></table></figure>

<h3 id="編輯-squid-conf"><a href="#編輯-squid-conf" class="headerlink" title="編輯 squid.conf"></a>編輯 squid.conf</h3><p>接下來就要編輯 squid.conf，以下先提供我的設定檔：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">acl localnet src 10.0.0.0&#x2F;8	    # RFC1918 possible internal network</span><br><span class="line">acl localnet src 172.16.0.0&#x2F;12	# RFC1918 possible internal network</span><br><span class="line">acl localnet src 192.168.0.0&#x2F;16	# RFC1918 possible internal network</span><br><span class="line">acl localnet src fc00::&#x2F;7       # RFC 4193 local private network range</span><br><span class="line">acl localnet src fe80::&#x2F;10      # RFC 4291 link-local (directly plugged) machines</span><br><span class="line">acl SSL_ports port 443</span><br><span class="line">acl Safe_ports port 80		# http</span><br><span class="line">acl Safe_ports port 21		# ftp</span><br><span class="line">acl Safe_ports port 443		# https</span><br><span class="line">acl Safe_ports port 70		# gopher</span><br><span class="line">acl Safe_ports port 210		# wais</span><br><span class="line">acl Safe_ports port 1025-65535	# unregistered ports</span><br><span class="line">acl Safe_ports port 280		# http-mgmt</span><br><span class="line">acl Safe_ports port 488		# gss-http</span><br><span class="line">acl Safe_ports port 591		# filemaker</span><br><span class="line">acl Safe_ports port 777		# multiling http</span><br><span class="line">acl CONNECT method CONNECT</span><br><span class="line">http_access deny !Safe_ports</span><br><span class="line">http_access deny CONNECT !SSL_ports</span><br><span class="line">http_access allow localhost manager</span><br><span class="line">http_access deny manager</span><br><span class="line">http_access deny to_localhost</span><br><span class="line">http_access allow localnet</span><br><span class="line">http_access allow localhost</span><br><span class="line">http_access deny all</span><br><span class="line">http_port 3128 transparent</span><br><span class="line">https_port 3129 transparent cert&#x3D;&#x2F;etc&#x2F;squid3&#x2F;squid-proxy.crt key&#x3D;&#x2F;etc&#x2F;squid3&#x2F;squid-proxy.key ssl-bump</span><br><span class="line">ssl_bump none all</span><br></pre></td></tr></table></figure>

<ul>
<li><code>acl localnet src 192.168.0.0/16</code><ul>
<li><code>localnet</code> 是一個自訂的名稱</li>
<li><code>src</code> 是指 request 的來源</li>
<li><code>192.168.0.0/16</code> 也就是我們後端的 LAN。</li>
</ul>
</li>
<li><code>http_port 3128 transparent</code><ul>
<li><code>http_port</code> 就是設定 squid 負責 listen HTTP request 的 port。預設是 <code>3128</code>。</li>
<li><code>transparent</code> 就是運作模式，因為我們要建置 transparent proxy，所以必須要加上這個參數。</li>
</ul>
</li>
<li><code>https_port 3129 transparent cert=/etc/squid3/ssl/squid-proxy.crt key=/etc/squid3/ssl/squid-proxy.key ssl-bump</code><ul>
<li><code>https_port</code> 顧名思義就是接受 https request 的 port。不能設定跟 <code>http_port</code> 一樣</li>
<li><code>cert</code> 跟 <code>key</code> 必須要設定一對 self signed certificate 的路徑。</li>
<li><code>ssl-bump</code> 設定 HTTPs 的加解密訊息要怎麼處理。這邊建議搭配 <code>ssl_bump none all</code> 這個設定，讓 client 直接讀取 Web server 的 certificate。</li>
</ul>
</li>
</ul>
<p>其他的參數可以不用動</p>
<h3 id="產生-self-signed-certificate"><a href="#產生-self-signed-certificate" class="headerlink" title="產生 self signed certificate"></a>產生 self signed certificate</h3><p>首先必需先安裝 OpenSSL。在 Gentoo 上應該是 <code>dev-libs/openssl</code>;而 Ubuntu 上則只需要 <code>apt-get install openssl</code> 即可。</p>
<blockquote>
<p>產生出來的 certificate 必須要 Squid 能讀取到。因此，如果你有安裝我之前的步驟，將實體機上的某個資料夾掛載到 container，例如： <code>/etc/squid3</code> 之類，你就可以利用這些資料夾來傳檔案；<br>若否，則建議直接在 container 中執行這個步驟。（例如可以 <code>docker exec -it squid3 openssl ......</code> 但是這樣路徑必須要是絕對路徑，例如 <code>/etc/squid3/squid-server.key</code>)</p>
</blockquote>
<p>安裝好之後，接下來安裝以下指令步驟：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -des3 -out squid-server.key 1024</span><br><span class="line">Generating RSA private key, 1024 bit long modulus</span><br><span class="line">............................++++++</span><br><span class="line">...........................................................++++++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line">Enter pass phrase for squid-server.key:</span><br><span class="line">Verifying - Enter pass phrase for squid-server.key:</span><br></pre></td></tr></table></figure>

<p><code>pass phrase</code> 必須要打一串密碼進去，不可以留空</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -new -key squid-server.key -out squid-server.csr</span><br><span class="line">Enter pass phrase for squid-server.key:</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter &#39;.&#39;, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (2 letter code) [AU]:TW</span><br><span class="line">State or Province Name (full name) [Some-State]:Taiwan</span><br><span class="line">Locality Name (eg, city) []:Hsichu</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:NTHU</span><br><span class="line">Organizational Unit Name (eg, section) []:SSLab</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:maple52046.twbbs.org.tw</span><br><span class="line">Email Address []:maple52046@gmail.com</span><br><span class="line"></span><br><span class="line">Please enter the following &#39;extra&#39; attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:</span><br><span class="line">An optional company name []:</span><br></pre></td></tr></table></figure>

<p>後面 <code>extra</code> 這邊全部直接按 enter 跳過。</p>
<p>然後接下來還有兩個指令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsa -in squid-server.key -out squid-proxy.key</span><br><span class="line">Enter pass phrase for squid-server.key:</span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line">$ openssl x509 -req -days 365 -in squid-server.csr -signkey squid-proxy.key -out squid-proxy.crt</span><br><span class="line">Signature ok</span><br><span class="line">subject&#x3D;&#x2F;C&#x3D;TW&#x2F;ST&#x3D;Taiwan&#x2F;L&#x3D;Hsichu&#x2F;O&#x3D;NTHU&#x2F;OU&#x3D;SSLab&#x2F;CN&#x3D;maple52046.twbbs.org.tw&#x2F;emailAddress&#x3D;maple52046@gmail.com</span><br><span class="line">Getting Private key</span><br></pre></td></tr></table></figure>

<p>完成之後，在當前目錄下，會產生4個檔案：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ls</span><br><span class="line">squid-proxy.crt  squid-proxy.key  squid-server.csr  squid-server.key</span><br></pre></td></tr></table></figure>

<p>將 <code>squid-proxy.crt</code> 與 <code>squid-proxy.key</code> 放到 container 可以讀取到的地方，例如：<code>/etc/squid3</code> …</p>
<h2 id="5-Restart-Squid"><a href="#5-Restart-Squid" class="headerlink" title="5. Restart Squid"></a>5. Restart Squid</h2><p>重新啟動 Squid server 以便套用新設定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker restart squid3</span><br></pre></td></tr></table></figure>

<p>檢查一下 port 是否有在監聽：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -tlnp | egrep &#39;3128|3129&#39;</span><br></pre></td></tr></table></figure>

<h2 id="6-設定-Iptables"><a href="#6-設定-Iptables" class="headerlink" title="6. 設定 Iptables"></a>6. 設定 Iptables</h2><p>因為是 transparent proxy，所以還必須要加上 iptables nat rule，將 HTTP/HTTPs request 導入到 Squid 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo iptables -t nat -A PREROUTING ! -d 10.0.0.1 -p tcp --dport 80 -j REDIRECT --to 3128</span><br><span class="line">$ sudo iptables -t nat -A PREROUTING ! -d 10.0.0.1 -p tcp --dport 443 -j REDIRECT --to 3129</span><br></pre></td></tr></table></figure>

<p>這邊 <code>10.0.0.1</code> 是實體 server 的對外 IP。如果你的 NAT server 沒有提供 web service，那就可以去掉這個條件，直接變成 <code>iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to 3128</code></p>
<p>或者你的 NAT server 是有區分內外網的 interface，例如假設 eth0 是連接外網、eth1 是連接內網，那就可以改成：<code>iptables -t nat -A PREROUTING -i eth1 -p tcp --dport 80 -j REDIRECT --to 3128</code></p>
<h2 id="7-用-upstart-systemd-來管理-Squid-container-Options"><a href="#7-用-upstart-systemd-來管理-Squid-container-Options" class="headerlink" title="7. 用 upstart/systemd 來管理 Squid container (Options.)"></a>7. 用 upstart/systemd 來管理 Squid container (Options.)</h2><p>如果將來 NAT server 重開機，那麼就得要自己重新啟動 container。<br>因此可以利用 Linux 上的 upstart(或是 systemd)來啟動 container 會方便很多。</p>
<p>以下用 upstart 為例( systemd 可以參考 <a href="https://docs.docker.com/v1.8/articles/host_integration/" target="_blank" rel="noopener">Docker 官方教學</a>)：</p>
<ol>
<li><p>建立 <code>/etc/init/squid3.conf</code>，並新增以下內容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">description &quot;Squid Proxy Server&quot;</span><br><span class="line">author &quot;Maple52046&quot;</span><br><span class="line">start on filesystem and started docker</span><br><span class="line">stop on runlevel [!2345]</span><br><span class="line">respawn</span><br><span class="line">script</span><br><span class="line">	&#x2F;usr&#x2F;bin&#x2F;docker start -a squid3</span><br><span class="line">end script</span><br></pre></td></tr></table></figure>
</li>
<li><p>產生 <code>/etc/init.d/squid3</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ln -s &#x2F;lib&#x2F;init&#x2F;upstart-job &#x2F;etc&#x2F;init.d&#x2F;squid3</span><br></pre></td></tr></table></figure>
</li>
<li><p>關閉原本的 container ，並啟動服務</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo docker stop squid3</span><br><span class="line">sudo service squid3 start</span><br></pre></td></tr></table></figure>
<p>檢查一下 container 是否已經啟動</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo service squid3 status</span><br><span class="line">sudo docker ps | grep squid3</span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<p>架設完 Squid proxy server 之後， 就可以分析 Squid 的 Log (<code>/var/log/squid3/access.log</code>)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1447999536.213 120894 192.168.0.3 TCP_MISS&#x2F;200 7655 CONNECT 74.125.203.138:443 - HIER_DIRECT&#x2F;74.125.203.138 -</span><br><span class="line">1447999536.213 121078 192.168.0.3 TCP_MISS&#x2F;200 4957 CONNECT 64.233.188.139:443 - HIER_DIRECT&#x2F;64.233.188.139 -</span><br><span class="line">1447999554.963 240143 192.168.0.3 TCP_MISS&#x2F;200 5176 CONNECT 64.233.189.95:443 - HIER_DIRECT&#x2F;64.233.189.95 -</span><br><span class="line">1447999555.327 240351 192.168.0.3 TCP_MISS&#x2F;200 5961 CONNECT 64.233.189.95:443 - HIER_DIRECT&#x2F;64.233.189.95 -</span><br><span class="line">1447999566.344   3061 192.168.0.3 TCP_MISS_ABORTED&#x2F;000 0 GET http:&#x2F;&#x2F;secclientgw.alipay.com&#x2F;product&#x2F;3001&#x2F;2.4.0.0&#x2F;version.xml? - HIER_DIRECT&#x2F;110.76.20.11 -</span><br><span class="line">1447999567.267 112594 192.168.0.3 TCP_MISS&#x2F;200 55546 CONNECT 23.48.140.135:443 - HIER_DIRECT&#x2F;23.48.140.135 -</span><br><span class="line">1447999574.672 240106 192.168.0.3 TCP_MISS&#x2F;200 4895 CONNECT 74.125.204.139:443 - HIER_DIRECT&#x2F;74.125.204.139 -</span><br><span class="line">1447999574.975 120170 192.168.0.3 TCP_MISS&#x2F;200 744 CONNECT 54.230.212.62:443 - HIER_DIRECT&#x2F;54.230.212.62 -</span><br><span class="line">1447999578.090 240080 192.168.0.3 TCP_MISS&#x2F;200 1310 CONNECT 74.125.203.139:443 - HIER_DIRECT&#x2F;74.125.203.139 -</span><br><span class="line">1447999631.985  65873 192.168.0.3 TCP_MISS&#x2F;200 7278 CONNECT 31.13.87.1:443 - HIER_DIRECT&#x2F;31.13.87.1 -</span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li><a href="http://linux.vbird.org/linux_server/0420squid.php" target="_blank" rel="noopener">第十七章、區網控制者： Proxy 伺服器</a> - 鳥哥的 Linux 私房菜</li>
<li><a href="https://github.com/sameersbn/docker-squid" target="_blank" rel="noopener">sameersbn/squid:3.3.8-4</a></li>
<li><a href="http://docs.docker.com/engine/installation/gentoolinux/" target="_blank" rel="noopener">Installing Docker on Gentoo Linux</a></li>
<li><a href="http://serverfault.com/questions/610232/how-to-setup-client-for-squid-transparent-proxy" target="_blank" rel="noopener">How to setup client for squid transparent proxy?</a></li>
<li><a href="http://busylog.net/squid-ssl-certificate/" target="_blank" rel="noopener">Squid – SSL Certificate</a></li>
<li><a href="http://blog.longwin.com.tw/2006/01/ram_disk_build_method/" target="_blank" rel="noopener">拿 RAM 當硬碟來用(RAM Disk)</a></li>
<li><a href="http://www.ehow.com/how_7498953_enable-ssl-squid.html" target="_blank" rel="noopener">How to Enable SSL Squid</a></li>
<li><a href="http://stackoverflow.com/questions/22907231/copying-files-from-host-to-docker-container" target="_blank" rel="noopener">Copying files from host to docker container</a></li>
<li><a href="http://stackoverflow.com/questions/10175812/how-to-create-a-self-signed-certificate-with-openssl" target="_blank" rel="noopener">How to create a self-signed certificate with openssl?</a></li>
<li><a href="https://docs.docker.com/v1.8/articles/host_integration/" target="_blank" rel="noopener">Automatically start containers</a></li>
</ol>
<h1 id="圖片來源"><a href="#圖片來源" class="headerlink" title="圖片來源"></a>圖片來源</h1><ol>
<li><a href="http://www.peppercan.com/wp-content/uploads/2012/03/cloud.png" target="_blank" rel="noopener">http://www.peppercan.com/wp-content/uploads/2012/03/cloud.png</a></li>
<li><a href="http://orig05.deviantart.net/4a1c/f/2010/239/0/b/pc\_clipart\_by\_chiprunner-d2xfpv6.png" target="_blank" rel="noopener">http://orig05.deviantart.net/4a1c/f/2010/239/0/b/pc\_clipart\_by\_chiprunner-d2xfpv6.png</a></li>
</ol>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Docker/" rel="tag">Docker</a> <a class="tag tag--primary tag--small t-link" href="/tags/Squid/" rel="tag">Squid</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/12/17/Ceph-PG-stuck-stuck-in-degraded-and-undersized/"
                    data-tooltip="Ceph PG stuck in degraded + undersized"
                    aria-label="PREVIOUS: Ceph PG stuck in degraded + undersized"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/05/14/Cross-Compile-for-OpenWRT/"
                    data-tooltip="Cross-compile for OpenWRT"
                    aria-label="NEXT: Cross-compile for OpenWRT"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/&amp;title=Setup Squid Transparent Proxy with Docker"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 古振浩 Chen-Hao Ku. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/12/17/Ceph-PG-stuck-stuck-in-degraded-and-undersized/"
                    data-tooltip="Ceph PG stuck in degraded + undersized"
                    aria-label="PREVIOUS: Ceph PG stuck in degraded + undersized"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2015/05/14/Cross-Compile-for-OpenWRT/"
                    data-tooltip="Cross-compile for OpenWRT"
                    aria-label="NEXT: Cross-compile for OpenWRT"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                    title="Share on Weibo"
                    aria-label="Share on Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://connect.qq.com/widget/shareqq/index.html?url=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/&amp;title=Setup Squid Transparent Proxy with Docker"
                    title="Share on QQ"
                    aria-label="Share on QQ"
                >
                    <i class="fab fa-qq" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="5">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/"
                        aria-label="Share on Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>Share on Weibo</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://connect.qq.com/widget/shareqq/index.html?url=https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/&amp;title=Setup Squid Transparent Proxy with Docker"
                        aria-label="Share on QQ"
                    >
                        <i class="fab fa-qq" aria-hidden="true"></i><span>Share on QQ</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <h4 id="about-card-name">古振浩 Chen-Hao Ku</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Taipei, Taiwan
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-yiemftmhqtwsxw4kjhvylvl77bvrkmkesswxwy8fiscgeiqtailhn40nft4k.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://maple52046.github.io/2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/';
              
            this.page.identifier = '2015/11/19/Setup-Squid-Transparent-Proxy-with-Docker/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'maple52046-githubio';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    




    </body>
</html>
