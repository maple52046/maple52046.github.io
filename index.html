<!DOCTYPE html>
<html>
	<head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>世界的盡頭 | Home </title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="命中有時終須有 命中無時莫強求" />
	<meta property="og:image" content=""/>
	<link rel="alternate" type="application/rss+xml" href="https://maple52046.github.io/index.xml" title="世界的盡頭" />
	<meta property="og:title" content="世界的盡頭" />
<meta property="og:description" content="命中有時終須有 命中無時莫強求" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://maple52046.github.io/" /><meta property="og:image" content="https://maple52046.github.io/site-thumbnail.png" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://maple52046.github.io/site-thumbnail.png" /><meta name="twitter:title" content="世界的盡頭"/>
<meta name="twitter:description" content="命中有時終須有 命中無時莫強求"/>

	
        <link href="https://maple52046.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://maple52046.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css" />

	
	

	
	
	
	
</head>

	<body>
		<div class="content">
			<header>
	<div class="main">
		<a href="https://maple52046.github.io">世界的盡頭</a>
	</div>
	<nav>
		
		
	</nav>
</header>

			
			<main class="list">
				<div class="site-description"></div>
				
				
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/flutter-reorderablelistview/">Flutter ReorderableListView</a></h1>
					<time>Sep 21, 2024</time>
					<br><div class="description">
	
	<h1 id="使用-reorderablelist-解決-bloc-在-listview-中頻繁的關閉與創建問題">使用 ReorderableList 解決 Bloc 在 ListView 中頻繁的關閉與創建問題</h1>
<p>最近在開發 Flutter app 時遇到了一個問題：當 <code>ListView</code> 中，每個 child 都使用 <code>BlocProvider</code> ，例如:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyListView</span> <span style="color:#66d9ef">extends</span> StatelessWidget {
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">@</span>override
</span></span><span style="display:flex;"><span>  Widget build(BuildContext context) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> BlocBuilder<span style="color:#f92672">&lt;</span>MyCubit, MyState<span style="color:#f92672">&gt;</span>(
</span></span><span style="display:flex;"><span>      builder: (_, state) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ListView.builder(
</span></span><span style="display:flex;"><span>          itemCount: state.length,
</span></span><span style="display:flex;"><span>          itemBuilder: (context, index) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> BlocProvider(
</span></span><span style="display:flex;"><span>              create: (_) <span style="color:#f92672">=&gt;</span> MyCubit(),
</span></span><span style="display:flex;"><span>              child: ListTile(
</span></span><span style="display:flex;"><span>                key: ValueKey(state[index]),
</span></span><span style="display:flex;"><span>                title: Text(state[index].title),
</span></span><span style="display:flex;"><span>              ),
</span></span><span style="display:flex;"><span>            );
</span></span><span style="display:flex;"><span>          },
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果列表的順序變更，child bloc 會將頻繁地被關閉與重新創建。此時會導致所有的 child 發生 <code>emit error</code>：</p>
<pre tabindex="0"><code>[ERROR: flutter/runtime/dart_vm_initializer.cc(41)] Unhandled Exception: Bad state: Cannot emit new states after calling close
#0  BlocBase.emit (package:bloc/src/bloc_base.dart:97:9)
#1  MyCubit.fetchData.&lt;anonymous closure&gt; (package: myapp/features/hello/presentation/blocs/cubit.dart:203:13)
#2  GreetingRepository.fetchData(package:myapp/features/hello/infrastructure/repositories.dart:167:20)
‹asynchronous suspension&gt;
#3  GreetingRepository.fetch.&lt;anonymous closure (package:myapp/features/hello/infrastructure/repositories.dart:60:9)
&lt;asynchronous suspension&gt;
</code></pre><p>即便在每個 <code>child</code> 上增加了唯一的 <code>key</code>，也無法避免這個問題。</p>&hellip;
	
</div>
					<a class="readmore" href="/posts/flutter-reorderablelistview/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/solve-widgetsflutterbinding-issue-in-flutter-with-catcher/">解決在 Flutter 使用 Catcher 時遇到 WidgetsFlutterBinding 初始化的問題</a></h1>
					<time>Dec 29, 2023</time>
					<br><div class="description">
	
	<p>最近引入 <a href="https://github.com/jhomlala/catcher">Catcher</a> 來搜集 app 發生的錯誤訊息。按照 github 上的範例修改了 main function，初始化 Catcher:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> main() <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>  WidgetsFlutterBinding.ensureInitialized();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Catcher(
</span></span><span style="display:flex;"><span>    debugConfig: CatcherOptions(SilentReportMode(), [
</span></span><span style="display:flex;"><span>      ConsoleHandler(
</span></span><span style="display:flex;"><span>        enableApplicationParameters: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        enableDeviceParameters: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        enableCustomParameters: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        enableStackTrace: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    ]),
</span></span><span style="display:flex;"><span>    releaseConfig: CatcherOptions(
</span></span><span style="display:flex;"><span>      SilentReportMode(),
</span></span><span style="display:flex;"><span>      [
</span></span><span style="display:flex;"><span>        HttpHandler(
</span></span><span style="display:flex;"><span>          HttpRequestType.post,
</span></span><span style="display:flex;"><span>          Uri.parse(<span style="color:#e6db74">&#39;https://x.y.z&#39;</span>),
</span></span><span style="display:flex;"><span>          enableApplicationParameters: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          enableCustomParameters: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>          enableDeviceParameters: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          enableStackTrace: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>      ],
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>    runAppFunction: initApp,
</span></span><span style="display:flex;"><span>    navigatorKey: myRootNavKey,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Future<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> initApp() <span style="color:#66d9ef">async</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    此處省略一萬個 sdk 初始化步驟 .......
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  runApp(<span style="color:#66d9ef">const</span> RootApp());
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>結果運行時 console 顯示錯誤：</p>
<pre tabindex="0"><code>flutter: [2023-12-29 20:47:21.680324 | Catcher | INFO] Setup localization lazily!
flutter: [2023-12-29 20:47:21.694254 | Catcher | INFO] ============================ CATCHER LOG ============================
flutter: [2023-12-29 20:47:21.694391 | Catcher | INFO] Crash occurred on 2023-12-29 20:47:21.687161
flutter: [2023-12-29 20:47:21.694430 | Catcher | INFO]
flutter: [2023-12-29 20:47:21.694508 | Catcher | INFO] ---------- ERROR ----------
flutter: [2023-12-29 20:47:21.694635 | Catcher | INFO] Zone mismatch.
The Flutter bindings were initialized in a different zone than is now being used. This will likely cause confusion and bugs as any zone-specific configuration will inconsistently use the configuration of the original binding initialization zone or this zone based on hard-to-predict factors such as which zone was active when a particular callback was set.
It is important to use the same zone when calling `ensureInitialized` on the binding as when calling `runApp` later.
To make this warning fatal, set BindingBase.debugZoneErrorsAreFatal to true before the bindings are initialized (i.e. as the first statement in `void main() { }`).
flutter: [2023-12-29 20:47:21.694679 | Catcher | INFO]
flutter: [2023-12-29 20:47:21.694899 | Catcher | INFO] ------- STACK TRACE -------
flutter: [2023-12-29 20:47:21.695005 | Catcher | INFO] #0      BindingBase.debugCheckZone.&lt;anonymous closure&gt; (package:flutter/src/foundation/binding.dart:503:29)
flutter: [2023-12-29 20:47:21.695041 | Catcher | INFO] #1      BindingBase.debugCheckZone (package:flutter/src/foundation/binding.dart:508:6)
flutter: [2023-12-29 20:47:21.695076 | Catcher | INFO] #2      runApp (package:flutter/src/widgets/binding.dart:1093:18)
flutter: [2023-12-29 20:47:21.695120 | Catcher | INFO] #3      initApp (package:arena/main.dart:225:3)
flutter: [2023-12-29 20:47:21.695152 | Catcher | INFO] &lt;asynchronous suspension&gt;
flutter: [2023-12-29 20:47:21.695183 | Catcher | INFO] #4      main.&lt;anonymous closure&gt;.&lt;anonymous closure&gt; (package:arena/main.dart:108:37)
flutter: [2023-12-29 20:47:21.695213 | Catcher | INFO] &lt;asynchronous suspension&gt;
flutter: [2023-12-29 20:47:21.695270 | Catcher | INFO]
flutter: [2023-12-29 20:47:21.695330 | Catcher | INFO] ======================================================================
flutter: [2023-12-29 20:47:21.695767 | Catcher | INFO] Report result: true
</code></pre>&hellip;
	
</div>
					<a class="readmore" href="/posts/solve-widgetsflutterbinding-issue-in-flutter-with-catcher/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/create-objc-plugin-for-flutter-with-pigeon/">使用 Flutter Pigeon 開發 Objective-C plugin</a></h1>
					<time>Jan 5, 2023</time>
					<br><div class="description">
	
	<p>最近在為 app 整合整合其他公司的 sdk，對方只提供 java / objective-c 的方案。因此得自己做 native plugin 開發。</p>
<p>Google 了一番 flutter native plugin 開發，基本都提到了 <a href="https://pub.dev/packages/pigeon">Pigeon</a> 這個套件。使用 pigeon 可以：</p>
<ul>
<li>同時規範 android/ios native plugin 的 api (長什麼樣子、怎麼傳參數)</li>
<li>自動產生 dart code</li>
<li>自動綁定 flutter 與 native 之間的通信</li>
</ul>
<p>網路上的文章，大多都將 pigeon 用於單獨的 plugin 開發。而我則因為一些因素，將 peigon 用於現有的 project 裡。</p>&hellip;
	
</div>
					<a class="readmore" href="/posts/create-objc-plugin-for-flutter-with-pigeon/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/dart-convert-protobuf-structure-in-json/">Dart 轉換 json 中的 protobuf 結構</a></h1>
					<time>Oct 10, 2022</time>
					<br><div class="description">
	
	<p>最近開始將 flutter app 的後端由 restful api 逐步轉成 grpc，轉換的過程中為了同時兼容舊的 api，在原本的 json 結構中替換並嵌入了 protobuf 結構。結果在 json 序列化時 (<code>flutter packages pub run build_runner build</code>) 出現了類似以下錯誤：</p>
<pre tabindex="0"><code>[INFO] Generating build script completed, took 569ms
[INFO] Reading cached asset graph completed, took 77ms
[INFO] Checking for updates since last build completed, took 640ms
[SEVERE] json_serializable on lib/models/plustwo.dart:

Expecting a `fromJson` constructor with exactly one positional parameter. The only extra parameters allowed are functions of the form `T Function(Object?) fromJsonT` where `T` is a type parameter of the target type.
package:client/proto/calculator.pb.dart:40:28
   ╷
40 │   factory PlusTwoIntResult.fromJson($core.String i, [$pb.ExtensionRegistry r = $pb.ExtensionRegistry.EMPTY]) =&gt; create()..mergeFromJson(i, r);
   │                            ^^^^^^^^
   ╵
[INFO] Running build completed, took 5.1s
[INFO] Caching finalized dependency graph completed, took 48ms
[SEVERE] Failed after 5.2s
</code></pre>&hellip;
	
</div>
					<a class="readmore" href="/posts/dart-convert-protobuf-structure-in-json/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/compile-openwrt-with-openclash/">Compile OpenWRT With OpenClash</a></h1>
					<time>Sep 26, 2022</time>
					<br><div class="description">
	
	<p>最近朋友希望弄一台翻牆路由器放在辦公室用，於是買了一台 Netgear R6300 v2。刷了 DD-WRT 後才發現問題：安裝不了 <a href="https://github.com/vernesong/OpenClash">OpenClash</a>，<code>ipkg</code> 連 update 都不行了，就更不用說安裝。</p>
<p>參考 DD-WRT 官網 development 的 <a href="https://wiki.dd-wrt.com/wiki/index.php/Development#Firmware_Modification_Kit">Firmware Modification Kit</a>，將 OpenClash 的 ipk 解壓縮後放進 firmware 一起重編。編譯完後的 fireware 貌似是含有 OpenClash，但是刷到 AP 後卻消失了，web 介面沒有相關的 UI、ssh 進去後也找不到。</p>
<p>重新拾回 OpenWRT，先刷了官網 for R6300v2 的 firmware，在 wifi 上遇到很大的問題：</p>
<ol>
<li>5G 完全不能用</li>
<li>2.4G 可以用，但是目前實測很不穩 (ping 掉封包、高延遲)</li>
</ol>
<p>實在不想花太多時間在翻牆上，而且電腦可以插網路線，不影響工作，於是就選擇 OpenWRT。</p>
<p>但是安裝 OpenClash 時又遇到的問題，<code>luci-app-openclash_0.45.59-beta_all.ipk</code> 的相依性 packages 包含了 <code>dnsmasq-full</code>，而官網提供的 firmware 預設已經有了 <code>dnsmasq</code>，這兩個是衝突的。如果 <code>opkg install</code> 加上 <code>--nodeps</code> 是可以解決，安裝完後的 OpenClash 也是可以使用的。不過對於系統潔癖/強迫症患者來說，這裡提供了重新編譯的解法。</p>&hellip;
	
</div>
					<a class="readmore" href="/posts/compile-openwrt-with-openclash/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/using-nestedscrollview-in-flutter/">在 Flutter 中使用 NestedScrollView 與 CustomScrollView</a></h1>
					<time>Jul 1, 2022</time>
					<br><div class="description">
	
	<p>最近在修改 app 的個人頁，遇到的需求：</p>
<ol>
<li>Tab bar 切出圓角</li>
<li>Tab bar 可以滑動，滑到 app bar 的時候固定住</li>
</ol>
<p>用文字說不太清楚，下面直接看圖：</p>
<p><img src="https://i.imgur.com/CxZ6jxL.png" alt="Imgur"></p>
<p>頁面的 components 有：</p>
<ul>
<li>App bar</li>
<li>個人資訊區</li>
<li>Tab bar</li>
<li>Tab view</li>
</ul>
<p>Tab view 裡是可滾動的內容, 這裡放了兩種類型：grid 與 list。
當用戶向上滑動時，app bar 固定不動，tab bar 往上滑動到 tab bar 時固定不動，下方 tab view 保持可滑動。如下圖：</p>
<p><img src="https://i.imgur.com/o63DCh9.png" alt="Imgur"></p>&hellip;
	
</div>
					<a class="readmore" href="/posts/using-nestedscrollview-in-flutter/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/compile-flutter-apk/">編譯 Flutter APK</a></h1>
					<time>Jun 10, 2022</time>
					<br><div class="description">
	
	<p>本文主要紀錄使用 flutter 編譯 app apk 時遇到的問題與解法。</p>
<p>版本資訊:</p>
<table>
<thead>
<tr>
<th style="text-align:left">#</th>
<th style="text-align:left">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Flutter</td>
<td style="text-align:left">3.0.1</td>
</tr>
<tr>
<td style="text-align:left">Host OS</td>
<td style="text-align:left">MacOS Big Sur (11.3.1)</td>
</tr>
<tr>
<td style="text-align:left">Android Studio</td>
<td style="text-align:left">2020.3 (AI-203.7717.56.2031.7678000)</td>
</tr>
<tr>
<td style="text-align:left">Android Platform Tool</td>
<td style="text-align:left">r33.0.2</td>
</tr>
<tr>
<td style="text-align:left">OpenJDK</td>
<td style="text-align:left">18.0.1.1</td>
</tr>
<tr>
<td style="text-align:left">Android (phone)</td>
<td style="text-align:left">11</td>
</tr>
</tbody>
</table>&hellip;
	
</div>
					<a class="readmore" href="/posts/compile-flutter-apk/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/customize-flutter-image-provider/">客製化 Flutter Image Provider</a></h1>
					<time>May 27, 2022</time>
					<br><div class="description">
	
	<p>之前在 flutter app 中使用 <a href="https://pub.dev/packages/optimized_cached_image">Optimized Cached Image</a> 來展示圖片，選擇他的原因也很簡單，因為當時剛學 flutter 沒多久就要直接上陣了。先選一個看起來簡單好用的再說；而且他還可以設置 cache key，避免重複抓取，感覺起來就不錯。</p>
<p>然而後來圖片一多起來之後，就發現問題了，往往 app 打開滑沒幾下就 crash。看 log 是 OOM 問題，上網查了一下，有人說是 memory leak。大致上就是 image disposed 之後，沒有正確的釋放 ram，app 佔用的 ram 越來越多，就直接觸發 OOM killer。測試了一下原生的 NetworkImage 沒有這個問題。所以應該就是 Optimized Cached Image 的問題了。</p>
<p>另外就是在我的程式裡，widget 只拿到 media id，需要先到後端去查 media 的 presigned url 返回給 app，app 再用 presigned url 抓圖片資料。也就是原來的程式碼裡一直都是 future builder + image，這造成的問題就是頁面一刷新就要重新抓 presigned url，大大降低了效率，也大大提升了後端的負載。</p>
<p>因此決定客製化一個業務專用的 image provider。</p>&hellip;
	
</div>
					<a class="readmore" href="/posts/customize-flutter-image-provider/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/openim-integration-notes-01/">OpenIM 整合(踩坑)筆記 01</a></h1>
					<time>May 25, 2022</time>
					<br><div class="description">
	
	<p><a href="https://doc.rentsoft.cn/#/introduce/production_introduce">OpenIM</a> 號稱是由一群前微信等技術專家一起出來打造的開源 IM 系統。撇開政治不談，個人覺得微信在 IM 領域確實是佼佼者，因此決定整合 OpenIM 到現有的產品中，以減少浪費時間重複造輪子。</p>
<p>本篇目標是串連原有的帳號系統與 OpenIM 的帳號系統，完成 <strong>自動註冊用戶到 OpenIM</strong> (下圖中的第 3 ~ 4 步驟)。</p>
<p><img src="https://doc.rentsoft.cn/images/server-register.png" alt="Open-IM用户注册"></p>&hellip;
	
</div>
					<a class="readmore" href="/posts/openim-integration-notes-01/">Read more ⟶</a>
				</section>
				
				<section class="list-item">
					<h1 class="title"><a href="/posts/use-specific-color-on-the-flutter-material-app/">在 Flutter MaterialApp 中使用指定顏色</a></h1>
					<time>Oct 28, 2021</time>
					<br><div class="description">
	
	<p>使用 Flutter MaterialApp 時，如果直接使用 <code>Color.fromRGBO</code> 指定 ThemeData 的 <code>primarySwatch</code> 會出現類型錯誤。這是因為 <code>primarySwatch</code> 接收的類型是 <code>MaterialColor</code> 而不是 <code>Color</code>：</p>
<p><img src="https://i.imgur.com/8oO6cvG.png" alt="Imgur"></p>&hellip;
	
</div>
					<a class="readmore" href="/posts/use-specific-color-on-the-flutter-material-app/">Read more ⟶</a>
				</section>
				
				

<ul class="pagination">
	<span class="page-item page-prev">
	
	</span>
	<span class="page-item page-next">
	
    <a href="/page/2/" class="page-link" aria-label="Next"><span aria-hidden="true">Next →</span></a>
	
	</span>
</ul>


			</main>
			<footer>
  <div style="display:flex"></div>
  <div class="footer-info">
    2024  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-GC1G5TJVGY', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


		</div>
		
	</body>
</html>
